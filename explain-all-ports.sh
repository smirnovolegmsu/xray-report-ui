#!/bin/bash
# –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –í–°–ï–• –ø–æ—Ä—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

echo "=========================================="
echo "  –û–ë–™–Ø–°–ù–ï–ù–ò–ï –í–°–ï–• –ü–û–†–¢–û–í –ù–ê –°–ï–†–í–ï–†–ï"
echo "=========================================="
echo ""

# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã
ALL_PORTS=$( (ss -tlnp | awk '{print $4}' | sed 's/.*://' | grep -E '^[0-9]+$'; ss -ulnp | awk '{print $4}' | sed 's/.*://' | grep -E '^[0-9]+$') | sort -n | uniq)

echo "üìã –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –í–°–ï–• –ü–û–†–¢–û–í:"
echo ""

for port in $ALL_PORTS; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º TCP –∏ UDP
    TCP_INFO=$(ss -tlnp | grep ":$port ")
    UDP_INFO=$(ss -ulnp | grep ":$port ")
    
    if [ -n "$TCP_INFO" ]; then
        PROTO="TCP"
        PORT_INFO="$TCP_INFO"
    elif [ -n "$UDP_INFO" ]; then
        PROTO="UDP"
        PORT_INFO="$UDP_INFO"
    else
        continue
    fi
    
    PID=$(echo "$PORT_INFO" | grep -oP 'pid=\K[0-9]+' | head -1)
    PROCESS=$(ps -p "$PID" -o comm= 2>/dev/null || echo "unknown")
    PROCESS_PATH=$(ps -p "$PID" -o cmd= 2>/dev/null || echo "")
    HOST=$(echo "$PORT_INFO" | awk '{print $4}' | sed 's/:.*//' | head -1)
    
    case $port in
        22)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - SSH"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –£–¥–∞–ª–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É"
            echo "  –î–æ—Å—Ç—É–ø: –ü—É–±–ª–∏—á–Ω—ã–π (–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ)"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô - –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        53)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - DNS"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–æ–º–µ–Ω–Ω—ã—Ö –∏–º–µ–Ω (systemd-resolved)"
            echo "  –î–æ—Å—Ç—É–ø: –¢–æ–ª—å–∫–æ localhost - –±–µ–∑–æ–ø–∞—Å–µ–Ω"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –°–ò–°–¢–ï–ú–ù–´–ô - –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        80)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - HTTP"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –í–µ–±-—Å–µ—Ä–≤–µ—Ä (nginx)"
            echo "  –î–æ—Å—Ç—É–ø: –ü—É–±–ª–∏—á–Ω—ã–π (–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ)"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô - –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –≤–µ–±-–¥–æ—Å—Ç—É–ø–∞. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        123)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - NTP"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ (Network Time Protocol)"
            echo "  –î–æ—Å—Ç—É–ø: –ü—É–±–ª–∏—á–Ω—ã–π (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏)"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –°–ò–°–¢–ï–ú–ù–´–ô - –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        443)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - Xray VPN"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –û—Å–Ω–æ–≤–Ω–æ–π VPN —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (VLESS + Reality –ø—Ä–æ—Ç–æ–∫–æ–ª)"
            echo "  –î–æ—Å—Ç—É–ø: –ü—É–±–ª–∏—á–Ω—ã–π (–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ)"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô - –æ—Å–Ω–æ–≤–Ω–æ–π VPN –ø–æ—Ä—Ç. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        1194)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - OpenVPN"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π VPN —Å–µ—Ä–≤–µ—Ä (OpenVPN –ø—Ä–æ—Ç–æ–∫–æ–ª)"
            echo "  –î–æ—Å—Ç—É–ø: –ü—É–±–ª–∏—á–Ω—ã–π (–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ)"
            echo "  –°—Ç–∞—Ç—É—Å: ‚ö†Ô∏è  –ü–†–û–í–ï–†–ò–¢–¨ - –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ OpenVPN, –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å"
            echo "  –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è: sudo systemctl stop openvpn && sudo systemctl disable openvpn"
            ;;
        3000)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - Next.js Frontend"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Xray Report UI"
            echo "  –î–æ—Å—Ç—É–ø: –ü—É–±–ª–∏—á–Ω—ã–π (–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ)"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô - –æ—Å–Ω–æ–≤–Ω–æ–π UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        8787)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - Flask Backend API"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Xray –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"
            echo "  –î–æ—Å—Ç—É–ø: –¢–æ–ª—å–∫–æ localhost (127.0.0.1) - –±–µ–∑–æ–ø–∞—Å–µ–Ω"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô - –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        10085)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - Xray API"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Xray (Stats API)"
            echo "  –î–æ—Å—Ç—É–ø: –¢–æ–ª—å–∫–æ localhost (127.0.0.1) - –±–µ–∑–æ–ø–∞—Å–µ–Ω"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô - –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Xray. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        42725|51473|40992|54027|39989|49909|52120|59801)
            echo "–ü–æ—Ä—Ç $port ($PROTO) - Xray UDP"
            echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
            echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: UDP –ø–æ—Ä—Ç –¥–ª—è VPN —Ç—Ä–∞—Ñ–∏–∫–∞ Xray"
            echo "  –î–æ—Å—Ç—É–ø: –ü—É–±–ª–∏—á–Ω—ã–π (–¥–ª—è UDP —Ç—Ä–∞—Ñ–∏–∫–∞)"
            echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô - –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã Xray VPN. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            ;;
        *)
            if [[ "$PROCESS" == "xray" ]] && [[ "$PROTO" == "UDP" ]]; then
                echo "–ü–æ—Ä—Ç $port ($PROTO) - Xray UDP"
                echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
                echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: UDP –ø–æ—Ä—Ç –¥–ª—è VPN —Ç—Ä–∞—Ñ–∏–∫–∞ Xray"
                echo "  –î–æ—Å—Ç—É–ø: –ü—É–±–ª–∏—á–Ω—ã–π (–¥–ª—è UDP —Ç—Ä–∞—Ñ–∏–∫–∞)"
                echo "  –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô - –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã Xray VPN. –ù–ï –ó–ê–ö–†–´–í–ê–¢–¨!"
            elif [[ "$PROCESS_PATH" == *"cursor-server"* ]] || [[ "$PROCESS_PATH" == *".cursor-server"* ]]; then
                echo "–ü–æ—Ä—Ç $port ($PROTO) - Cursor Server"
                echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
                echo "  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã Cursor IDE —á–µ—Ä–µ–∑ SSH"
                echo "  –î–æ—Å—Ç—É–ø: –¢–æ–ª—å–∫–æ localhost (127.0.0.1) - –±–µ–∑–æ–ø–∞—Å–µ–Ω"
                echo "  –°—Ç–∞—Ç—É—Å: ‚ö†Ô∏è  –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û - –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Cursor —á–µ—Ä–µ–∑ SSH"
                echo "  –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è: ./cleanup-ports.sh --kill-cursor"
            else
                echo "–ü–æ—Ä—Ç $port ($PROTO) - –ù–ï–ò–ó–í–ï–°–¢–ù–´–ô"
                echo "  –ü—Ä–æ—Ü–µ—Å—Å: $PROCESS (PID: $PID)"
                echo "  –î–æ—Å—Ç—É–ø: $HOST"
                echo "  –°—Ç–∞—Ç—É—Å: ‚ùì –¢–†–ï–ë–£–ï–¢ –ü–†–û–í–ï–†–ö–ò"
                echo "  –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: lsof -i :$port"
            fi
            ;;
    esac
    echo ""
done

echo "=========================================="
echo "  –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê"
echo "=========================================="
echo ""
echo "–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤: $(echo "$ALL_PORTS" | wc -l)"
echo ""
echo "‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ï (–Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å):"
echo "   - 22 (SSH)"
echo "   - 53 (DNS)"
echo "   - 80 (HTTP)"
echo "   - 123 (NTP)"
echo "   - 443 (Xray VPN)"
echo "   - 3000 (Next.js)"
echo "   - 8787 (Flask Backend)"
echo "   - 10085 (Xray API)"
echo "   - 42725, 51473 (Xray UDP)"
echo ""
echo "‚ö†Ô∏è  –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ï (–º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å):"
echo "   - 1194 (OpenVPN) - –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ"
echo "   - 37011, 40783, 46705 (Cursor Server) - –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Cursor —á–µ—Ä–µ–∑ SSH"
echo ""
