<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xray Report UI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <link rel="stylesheet" href="/static/app.css" />
</head>

<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <div class="logo">XR</div>
        <div>
          <div class="title">Xray UI</div>
          <div class="sub">private panel</div>
        </div>
      </div>

      <nav class="nav">
        <button class="navbtn active" data-tab="dash">Дашборд</button>
        <button class="navbtn" data-tab="admin">Управление</button>
        <button class="navbtn" data-tab="updates">Обновления</button>
        <button class="navbtn" data-tab="events">События</button>
      </nav>

      <div class="sidefoot">
        <div class="kv">
          <span>Дата</span>
          <select id="dateSel"></select>
        </div>
        <div class="kv">
          <span>Период</span>
          <select id="daysSel">
            <option value="7">7 дней</option>
            <option value="14" selected>14 дней</option>
            <option value="21">21 день</option>
            <option value="31">31 день</option>
          </select>
        </div>
        <div class="kv">
          <span>Режим</span>
          <div class="seg">
            <button id="modeGlobal" class="segbtn active">Global</button>
            <button id="modeUsers" class="segbtn">By users</button>
          </div>
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="top">
        <div class="hrow">
          <div class="hleft">
            <h1 id="hTitle">Дашборд</h1>
            <div class="hint">Данные: /var/log/xray/usage · API: 127.0.0.1:8090</div>
          </div>
          <div class="hright">
            <button id="btnRefresh" class="btn">Обновить</button>
          </div>
        </div>
      </header>

      <!-- DASH -->
      <section id="tab-dash" class="tab">
        <div class="grid2">
          <div class="card">
            <div class="cardhead">
              <div>
                <div class="cardtitle">Трафик: прошлый vs текущий период (7d)</div>
                <div class="cardsub">Топ пользователей по текущему периоду</div>
              </div>
            </div>
            <div class="tablewrap">
              <table class="tbl" id="tblTraffic"></table>
            </div>
          </div>

          <div class="card">
            <div class="cardhead">
              <div>
                <div class="cardtitle">Соединения: прошлый vs текущий период (7d)</div>
                <div class="cardsub">Топ пользователей по текущему периоду</div>
              </div>
            </div>
            <div class="tablewrap">
              <table class="tbl" id="tblConns"></table>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="cardhead">
              <div class="cardtitle">Тренды (7 дней)</div>
              <div class="cardsub">Daily + Cumulative · Global/By users</div>
            </div>
            <div class="chartwrap">
              <canvas id="chTrends"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="cardhead">
              <div class="cardtitle">Аномалии</div>
              <div class="cardsub">>= 1 GB за день у пользователя</div>
              <div class="spacer"></div>
              <div class="badge" id="anBadge">—</div>
              <div class="iwrap">
                <button id="anInfo" class="ibtn" aria-label="info">i</button>
                <div id="anTip" class="tip"></div>
              </div>
            </div>
            <div class="cardbody">
              <div id="anList" class="chips"></div>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="cardhead">
              <div class="cardtitle">Топ домены (трафик)</div>
              <div class="cardsub">Global · последние 7 дней</div>
            </div>
            <div class="tablewrap">
              <table class="tbl" id="tblTopTraffic"></table>
            </div>
          </div>

          <div class="card">
            <div class="cardhead">
              <div class="cardtitle">Топ домены (соединения)</div>
              <div class="cardsub">Global · последние 7 дней</div>
            </div>
            <div class="tablewrap">
              <table class="tbl" id="tblTopConns"></table>
            </div>
          </div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="tab-admin" class="tab hidden">
        <div class="grid2">
          <div class="card">
            <div class="cardhead">
              <div class="cardtitle">Клиенты</div>
              <div class="cardsub">Добавление / удаление / kick (reset uuid) / копирование ссылки</div>
              <div class="spacer"></div>
              <button id="btnReloadClients" class="btn">Обновить</button>
            </div>
            <div class="tablewrap">
              <table class="tbl" id="tblClients"></table>
            </div>
          </div>

          <div class="card">
            <div class="cardhead">
              <div class="cardtitle">Настройки</div>
              <div class="cardsub">public_host и импорт рабочей ссылки (pbk/sni/sid)</div>
            </div>
            <div class="cardbody">
              <div class="form">
                <label>public_host</label>
                <div class="row">
                  <input id="inPublicHost" placeholder="185.235.130.184" />
                  <button id="btnSaveHost" class="btn">Сохранить</button>
                </div>

                <label>Импорт vless:// ссылки</label>
                <textarea id="inImportLink" rows="5" placeholder="vless://...&pbk=...&sid=..."></textarea>
                <button id="btnImportLink" class="btn">Импортировать</button>

                <div class="hr"></div>
                <label>Пакеты</label>
                <div class="row">
                  <button id="btnPkgInfo" class="btn">Показать версии</button>
                  <button id="btnInstallCrypto" class="btn danger">Install cryptography</button>
                </div>
                <pre id="pkgOut" class="out"></pre>

                <div class="hr"></div>
                <label>Добавить клиента</label>
                <input id="inNewEmail" placeholder="user_11" />
                <input id="inNewAlias" placeholder="alias (необязательно)" />
                <button id="btnAddClient" class="btn">Создать</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- UPDATES -->
      <section id="tab-updates" class="tab hidden">
        <div class="card">
          <div class="cardhead">
            <div class="cardtitle">Backup → Apply → Restart (одной кнопкой)</div>
            <div class="cardsub">Manifest формат: "### FILE: path" + содержимое</div>
            <div class="spacer"></div>
            <button id="btnLoadBackups" class="btn">Список бэкапов</button>
          </div>
          <div class="cardbody">
            <textarea id="manifest" rows="16" placeholder="### FILE: app.py&#10;..."></textarea>
            <div class="row">
              <button id="btnValidate" class="btn">Проверить</button>
              <button id="btnApply" class="btn danger">Backup & Apply & Restart</button>
            </div>
            <pre id="updOut" class="out"></pre>
            <div id="backups" class="backups"></div>
          </div>
        </div>
      </section>

      <!-- EVENTS -->
      <section id="tab-events" class="tab hidden">
        <div class="card">
          <div class="cardhead">
            <div class="cardtitle">События</div>
            <div class="cardsub">events.log (последние 200 строк)</div>
            <div class="spacer"></div>
            <button id="btnEvents" class="btn">Обновить</button>
          </div>
          <div class="cardbody">
            <pre id="eventsOut" class="out"></pre>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Confirm modal -->
  <div id="modal" class="modal hidden">
    <div class="modalbox">
      <div class="modaltitle" id="modalTitle">Подтверждение</div>
      <div class="modaltext" id="modalText"></div>
      <div class="modalbtns">
        <button id="modalNo" class="btn">Отмена</button>
        <button id="modalYes" class="btn danger">Подтвердить</button>
      </div>
    </div>
  </div>

  <script src="/static/app.js"></script>
  <script src="/static/admin.js"></script>
</body>
</html>
