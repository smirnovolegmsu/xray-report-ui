# Оптимизация сборки Next.js

## Проблема
Сборка проекта занимает 5+ минут на слабом сервере (3 ядра, 3.7GB RAM).

## Реализованные оптимизации

### 1. Оптимизация `next.config.ts`
- ✅ Включено кеширование webpack (`moduleIds: 'deterministic'`)
- ✅ Оптимизация разделения чанков (code splitting)
- ✅ Параллельная сборка через `webpackBuildWorker`
- ✅ Оптимизация CSS через SWC

### 2. Оптимизация TypeScript
- ✅ Инкрементальная компиляция с кешем (`tsBuildInfoFile`)
- ✅ `skipLibCheck: true` для пропуска проверки типов в node_modules

### 3. Новые скрипты
- `npm run build:fast` - сборка без валидации переменных окружения (быстрее)
- `npm run dev:turbo` - dev режим с Turbopack (экспериментально, быстрее)

## Дополнительные рекомендации

### Для ускорения разработки:

1. **Используйте dev режим вместо build для разработки:**
   ```bash
   npm run dev
   # или с Turbopack (быстрее):
   npm run dev:turbo
   ```

2. **Очистка кеша при проблемах:**
   ```bash
   rm -rf .next
   rm -rf node_modules/.cache
   npm run build
   ```

3. **Переменные окружения для ускорения:**
   ```bash
   # Отключить проверку типов во время сборки (проверять отдельно через type-check)
   SKIP_TYPE_CHECK=true npm run build
   
   # Отключить ESLint во время сборки
   SKIP_LINT=true npm run build
   ```

### Для production сборки:

1. **Используйте CI/CD с более мощным сервером** для сборки
2. **Кешируйте node_modules** между сборками
3. **Используйте Docker multi-stage builds** с кешированием слоев

### Мониторинг производительности:

```bash
# Анализ размера бандла
npm run build:analyze

# Проверка времени сборки
time npm run build
```

## Ожидаемые результаты

- **Первая сборка**: ~3-5 минут (без изменений)
- **Инкрементальная сборка**: ~30-60 секунд (при изменениях)
- **Dev режим**: ~10-20 секунд на старт

## Если всё ещё медленно:

1. **Увеличьте RAM** сервера (минимум 4GB рекомендуется)
2. **Используйте SSD** вместо HDD
3. **Рассмотрите использование более мощного сервера** для сборки
4. **Используйте Turbopack** (экспериментально, но быстрее)

## Быстрая сборка:

Используйте готовый скрипт для максимально быстрой сборки:
```bash
./build-fast.sh
# или с очисткой кеша:
./build-fast.sh --clean
```

Этот скрипт:
- Пропускает проверку TypeScript типов
- Пропускает ESLint проверку
- Использует все оптимизации кеширования
- Показывает время сборки

## Проверка текущей производительности:

```bash
# Очистить кеш и замерить время
rm -rf .next
time npm run build

# Повторная сборка (должна быть быстрее благодаря кешу)
time npm run build

# Быстрая сборка без проверок
./build-fast.sh
```

## Важно для разработки:

**НЕ используйте `npm run build` во время разработки!**

Вместо этого:
```bash
# Для разработки (быстро, с hot reload)
npm run dev

# Для проверки production сборки (только когда нужно)
npm run build
# или быстрее:
./build-fast.sh
```
