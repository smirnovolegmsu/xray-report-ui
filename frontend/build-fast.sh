#!/bin/bash
# –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏

set -e

echo "üöÄ –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ Next.js –ø—Ä–æ–µ–∫—Ç–∞..."
echo ""

# –û—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$1" == "--clean" ]; then
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞..."
    rm -rf .next
    rm -rf node_modules/.cache
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
export SKIP_TYPE_CHECK=true
export SKIP_LINT=true
export NODE_ENV=production

echo "‚è±Ô∏è  –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ –∏ –ª–∏–Ω—Ç–∏–Ω–≥–∞)..."
echo ""

# –ó–∞–º–µ—Ä –≤—Ä–µ–º–µ–Ω–∏
START_TIME=$(date +%s)

# –°–±–æ—Ä–∫–∞
npm run build

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ standalone (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è standalone —Ä–µ–∂–∏–º–∞)
echo ""
echo "üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ standalone..."
if [ -d ".next/static" ]; then
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –∫–æ–ø–∏—Ä—É–µ–º –∑–∞–Ω–æ–≤–æ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
    rm -rf .next/standalone/.next/static
    mkdir -p .next/standalone/.next/static
    
    # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º cp —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    if ! cp -a .next/static/. .next/standalone/.next/static/; then
        echo "‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤"
        exit 1
    fi
    
    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
    chmod -R 755 .next/standalone/.next/static
    echo "‚úì –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã (chunks, media, css, build-id)"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    if [ ! -d ".next/standalone/.next/static/chunks" ]; then
        echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è chunks –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
    if [ ! -d ".next/standalone/.next/static/media" ]; then
        echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è media –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
else
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next/static –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
if [ -d "public" ]; then
    rm -rf .next/standalone/public
    cp -r public .next/standalone/ 2>/dev/null || true
    chmod -R 755 .next/standalone/public 2>/dev/null || true
    echo "‚úì Public —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
fi

END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

echo ""
echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${ELAPSED} —Å–µ–∫—É–Ω–¥"
echo ""
echo "üí° –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ –æ—Ç–¥–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run type-check"
echo "üí° –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–Ω—Ç–∏–Ω–≥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run lint"
echo "üí° –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: sudo systemctl restart xray-nextjs-ui"