# Все аудиты проекта

**Дата:** 2026-01-25  
**Объединено из:** 16 файлов аудитов

---

## 📋 Содержание

1. [Архитектурный аудит 2025](#архитектурный-аудит-2025)
2. [Краткое резюме аудита](#краткое-резюме-аудита)
3. [Аудиты модулей](#аудиты-модулей)
4. [Код аудиты](#код-аудиты)

---

# Архитектурный аудит 2025

**Дата:** 2025-01-27  
**Версия проекта:** 2.0

## TL;DR: Что сейчас не так и что сделать первым

### Критические проблемы (P0 — ломает запуск/прод):

1. **Несуществующий файл `dashboard.py`** — `dashboard_service.py` пытается импортировать `/opt/xray-report-ui/dashboard.py`, которого нет. Это сломает работу overview модуля.
2. **v2 API endpoints — мёртвый код** — все 6 модулей имеют v2 endpoints, которые возвращают 501 и не используются. Загромождают код.
3. **Избыточная документация** — 38+ файлов в `docs/`, много дубликатов и архивных материалов, сложно найти актуальную информацию.

### Важные проблемы (P1):

4. **Нет явного разделения на слои** — бизнес-логика смешана с HTTP-обработчиками в некоторых местах.
5. **Кеш без мониторинга** — in-memory кеш может утечь память (лимит 500, но нет метрик использования).
6. **TODO в критических местах** — `dashboard_service.py` имеет TODO о переносе логики, но использует несуществующий модуль.
7. **Отсутствие Docker/CI** — нет контейнеризации и автоматизации сборки/тестирования.

### Средние проблемы (P2):

8. **Дублирование констант** — API endpoints определены и в backend, и в frontend отдельно.
9. **Нет валидации входных данных** — некоторые API endpoints не валидируют параметры должным образом.
10. **Архивная документация не структурирована** — `docs/archive/` содержит много файлов без четкой организации.

---

## Карта системы: компоненты и их связи

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Next.js)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Overview │  │  Users   │  │   Live   │  │  Events  │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
│       │             │             │             │         │
│  ┌────┴─────────────┴─────────────┴─────────────┴─────┐  │
│  │              Header / Settings                     │  │
│  └─────────────────────────────────────────────────────┘  │
│                          │                                  │
│                    HTTP/REST (proxy)                        │
└──────────────────────────┼──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              Backend (Flask/Gunicorn)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Overview │  │  Users   │  │   Live   │  │  Events  │  │
│  │   API    │  │   API    │  │   API    │  │   API    │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
│       │             │             │             │         │
│  ┌────┴─────────────┴─────────────┴─────────────┴─────┐  │
│  │         Header API / Settings API                  │  │
│  └─────────────────────────────────────────────────────┘  │
│                          │                                  │
│  ┌───────────────────────┴──────────────────────────────┐ │
│  │              Core Services                            │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐            │ │
│  │  │  Cache   │  │  Config │  │  Xray    │            │ │
│  │  │  (mem)   │  │  (JSON) │  │  Config  │            │ │
│  │  └──────────┘  └──────────┘  └──────────┘            │ │
│  └────────────────────────────────────────────────────────┘ │
│                          │                                  │
└──────────────────────────┼──────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Xray Service │  │ File System  │  │  Systemd     │
│ (systemctl)  │  │ (CSV logs)   │  │  Services   │
└──────────────┘  └──────────────┘  └──────────────┘
```

**Компоненты:**
- **Frontend:** Next.js 16 (SSR/SPA), порт 3000, проксирует `/api/*` → backend:8787
- **Backend:** Flask + Gunicorn, порт 8787 (localhost only)
- **Данные:** JSON файлы (`data/settings.json`, `data/events.log`, `data/usage_live.json`), CSV файлы (`/var/log/xray/usage/`)
- **Внешние:** Xray service (systemctl), файловая система для логов

---

## Стек: backend / frontend / инфраструктура / данные

### Backend

**Язык/Фреймворк:**
- Python 3.8+
- Flask 2.0+ (web framework)
- Gunicorn (WSGI server, production)
- structlog (structured logging)

**ORM/База данных:**
- Нет БД — файловая система (JSON, CSV)
- In-memory cache (собственная реализация)

**Структура:**
```
backend/
├── core/                     # Общие модули
│   ├── api.py               # Общие API утилиты
│   ├── cache.py             # In-memory cache с TTL
│   ├── config.py            # Конфигурация
│   ├── errors.py            # Обработка ошибок
│   ├── helpers.py           # Утилиты
│   ├── logging.py           # Логирование
│   ├── system.py            # Системные операции
│   └── xray.py              # Работа с Xray config
├── features/                # Модули по функциональности
│   ├── overview/            # Дашборд
│   ├── users/               # Управление пользователями
│   ├── live/                # Онлайн статистика
│   ├── events/              # События системы
│   ├── header/              # Системные ресурсы
│   └── settings/            # Настройки
└── tests/                   # Unit тесты
```

### Frontend

**Фреймворк/Сборщик:**
- Next.js 16.1.3 (App Router, SSR/SPA)
- React 19.2.3
- TypeScript 5
- TailwindCSS 4

**State Management:**
- SWR 2.3.8 (data fetching, кеширование)
- Zustand 5.0.10 (глобальный state)

**Структура:**
```
frontend/
├── app/                     # Next.js App Router pages
├── components/              # Переиспользуемые компоненты
├── features/               # Feature-модули
├── lib/                     # Утилиты и константы
└── types/                   # TypeScript типы
```

---

## API и контракты

### Таблица API методов (v1 — стабильные)

**Всего:** 28 методов v1

| Модуль | Методы | Endpoints |
|--------|--------|-----------|
| Overview | 3 | `/api/usage/dashboard`, `/api/usage/dates` |
| Users | 7 | `/api/users/*` |
| Live | 3 | `/api/live/*` |
| Events | 2 | `/api/events/*` |
| Header | 4 | `/api/system/*`, `/api/ports/*` |
| Settings | 8 | `/api/settings/*`, `/api/xray/*`, `/api/collector/*`, `/api/backups/*`, `/api/tests/*` |

### v2 API (экспериментальные — НЕ ИСПОЛЬЗУЮТСЯ)

Все v2 endpoints возвращают `501 Not Implemented` и не используются.

---

## Функциональные модули

### Модули Backend

#### Overview (Дашборд)
- **Файлы:** `backend/features/overview/`
- **Ответственность:** Агрегация данных использования, графики, статистика
- **API:** `/api/usage/*`
- **Проблемы:** Использует несуществующий `dashboard.py`

#### Users (Пользователи)
- **Файлы:** `backend/features/users/`
- **Ответственность:** CRUD пользователей, генерация VLESS ссылок, статистика
- **API:** `/api/users/*`
- **Статус:** ✅ Работает

#### Live (Онлайн)
- **Файлы:** `backend/features/live/`
- **Ответственность:** Реалтайм статистика, временные ряды, топ пользователей
- **API:** `/api/live/*`
- **Особенности:** Background thread обновляет буфер каждую минуту

#### Events (События)
- **Файлы:** `backend/features/events/`
- **Ответственность:** Логирование событий системы, фильтрация, статистика
- **API:** `/api/events/*`
- **Особенности:** Используется другими модулями для логирования

#### Header (Системные ресурсы)
- **Файлы:** `backend/features/header/`
- **Ответственность:** CPU/RAM/Disk, статус сервисов, порты, перезапуск
- **API:** `/api/system/*`, `/api/ports/*`
- **Статус:** ✅ Работает

#### Settings (Настройки)
- **Файлы:** `backend/features/settings/`
- **Ответственность:** Настройки системы, Xray config, бэкапы, коллектор, тесты
- **API:** `/api/settings/*`, `/api/xray/*`, `/api/collector/*`, `/api/backups/*`, `/api/tests/*`

---

## Найденные дубли

1. **API endpoints константы:**
   - Backend: определены в коде endpoints
   - Frontend: `frontend/lib/constants/api.ts`
   - **Проблема:** Дублирование, изменения нужно синхронизировать вручную

2. **Валидация email/UUID:**
   - Backend: `backend/core/api.py` (validate_email, validate_uuid)
   - Frontend: вероятно есть своя валидация
   - **Рекомендация:** Вынести в общий контракт

---

## План действий

### Быстрые победы (1-3 дня)

1. **Исправить dashboard_service.py** (2-4 часа)
2. **Удалить v2 API endpoints** (1 час)
3. **Очистить TODO комментарии** (1 час)
4. **Организовать docs/** (2-3 часа)
5. **Проверить работоспособность** (2 часа)

### Безопасный рефакторинг (1-2 недели)

6. **Разделить ответственность** (3-5 дней)
7. **Добавить тесты** (2-3 дня)
8. **Улучшить обработку ошибок** (1-2 дня)
9. **Добавить Docker** (2-3 дня)
10. **Настроить CI/CD** (2-3 дня)

---

# Краткое резюме аудита

## 🚨 Критические проблемы (исправить немедленно)

### 1. Несуществующий файл dashboard.py

**Проблема:** `backend/features/overview/services/dashboard_service.py` пытается импортировать `/opt/xray-report-ui/dashboard.py`, которого нет.

**Влияние:** Overview модуль не работает, API endpoints падают с ImportError.

**Решение:**
1. Проверить, что реально используется из этих функций
2. Реализовать функции напрямую в `dashboard_service.py` или удалить, если не используются

---

### 2. Мёртвый код: v2 API endpoints

**Проблема:** Все 6 модулей имеют v2 endpoints, которые возвращают 501 и не используются.

**Файлы для удаления:**
- `backend/features/overview/api/v2/endpoints.py`
- `backend/features/users/api/v2/endpoints.py`
- `backend/features/live/api/v2/endpoints.py`
- `backend/features/events/api/v2/endpoints.py`
- `backend/features/header/api/v2/endpoints.py`
- `backend/features/settings/api/v2/endpoints.py`

**Риск:** Низкий (не используются)

---

### 3. Избыточная документация

**Проблема:** 38+ файлов в `docs/`, много дубликатов и архивных материалов.

**Действие:** Организовать архив, удалить дубликаты, обновить навигацию.

---

## 📊 Статистика проекта

- **Backend:** Python 3.8+, Flask 2.0+, 28 API endpoints (v1)
- **Frontend:** Next.js 16, React 19, TypeScript
- **Модулей:** 6 (overview, users, live, events, header, settings)
- **Тесты:** Есть базовые unit тесты
- **Документация:** Избыточная, нужна организация

---

## ✅ Что работает хорошо

- Модульная структура features
- Разделение на слои (api/services/repositories)
- Структурированное логирование
- Система кеширования
- Обработка ошибок

---

## 🔧 Что нужно улучшить

- Исправить критичные баги
- Удалить мёртвый код
- Добавить Docker/CI
- Улучшить валидацию
- Организовать документацию

---

# Аудиты модулей

## Аудит модуля Events

### Структура модуля

**Компоненты:**
1. **page.tsx** - главная страница Events
2. **events-table.tsx** - таблица событий
3. **events-stats-sidebar.tsx** - статистика в сайдбаре
4. **events-timeline.tsx** - временная шкала
5. **events-critical-alerts.tsx** - критические алерты
6. **events-trend-and-repeated.tsx** - тренды и повторяющиеся проблемы
7. **events-problematic-services.tsx** - проблемные сервисы

### Найденные проблемы

1. **Избыточный код в page.tsx** - хак для sidebar через инъекцию стилей в DOM
2. **Возможное дублирование запросов** - нужно проверить, не делают ли компоненты одинаковые запросы
3. **Множественные фильтры** - много состояний фильтров в page.tsx

### План оптимизации

1. ✅ Удалить хак для sidebar
2. ✅ Проверить дублирование запросов
3. ✅ Создать хук useEventsFilters
4. ✅ Оптимизировать загрузку данных

---

## Аудит модуля Users

### Структура модуля

**Компоненты:**
- users-table.tsx - таблица пользователей
- user-details-sheet.tsx - детали пользователя

### Найденные проблемы

1. **Hydration errors** - использование браузерных API в SSR
2. **Дублирование запросов** - несколько компонентов запрашивают одни и те же данные

---

## Аудит модуля Settings

### Структура модуля

**Компоненты:**
- Различные страницы настроек (xray, collector, backups, ports, system, tests)

### Найденные проблемы

1. **Сложная структура** - много вложенных страниц
2. **Дублирование логики** - общая логика для разных типов настроек

---

## Аудит модуля Live

### Структура модуля

**Компоненты:**
- live-now.tsx - текущее состояние
- live-charts.tsx - графики
- live-controls.tsx - управление

### Найденные проблемы

1. **Частые запросы** - каждые 5 секунд
2. **Нет кэширования** - каждый запрос идет на сервер

---

## Аудит модуля Overview

### Структура модуля

**Компоненты:**
- metrics-cards.tsx - карточки метрик
- traffic-chart.tsx - график трафика
- top-domains.tsx - топ доменов
- user-stats-cards.tsx - статистика пользователей

### Найденные проблемы

1. **Backend проблемы** - несуществующий dashboard.py
2. **Оптимизация запросов** - можно объединить запросы

---

## Аудит модуля Sidebar

### Структура модуля

**Компоненты:**
- sidebar.tsx - боковая панель навигации

### Найденные проблемы

1. **Мобильная адаптация** - элементы слишком большие на мобильных
2. **Z-index проблемы** - конфликты с другими элементами

---

## Аудит модуля Header

### Структура модуля

**Компоненты:**
- status-badges.tsx - статусы сервисов
- system-resources.tsx - системные ресурсы

### Найденные проблемы

1. **Частые запросы** - каждые 10-30 секунд
2. **Нет централизованного обновления** - каждый компонент делает свой запрос

---

# Код аудиты

## Отчет об аудите кода

**Дата:** 2026-01-20

### Исправленные проблемы

#### 1. Мобильное отображение (КРИТИЧНО)

**Проблема:** Элементы интерфейса были слишком большими на мобильных устройствах.

**Исправления:**
- Уменьшены размеры текста в sidebar для мобильных
- Уменьшены размеры кнопок навигации
- Добавлены адаптивные размеры для иконок и текста
- Добавлены медиа-запросы для очень маленьких экранов

#### 2. Дублирование функции `_parse_date_from_name`

**Проблема:** Функция была определена в двух модулях: `dashboard.py` и `collector.py`.

**Исправление:**
- Вынесена функция в `utils.py` как `parse_date_from_filename()`
- Оба модуля теперь импортируют функцию из `utils.py`

### Найденные проблемы (требуют дальнейшего исправления)

1. **Отсутствие классов (нарушение ООП)** - код в основном процедурный
2. **Хардкод путей** - некоторые пути захардкожены
3. **Отсутствие типизации** - нет type hints в некоторых местах

---

## Итоговый аудит работоспособности

### Статус модулей

| Модуль | Статус | Проблемы |
|--------|--------|----------|
| Overview | ⚠️ | Несуществующий dashboard.py |
| Users | ✅ | Работает |
| Live | ✅ | Работает |
| Events | ✅ | Работает |
| Header | ✅ | Работает |
| Settings | ✅ | Работает |

---

## Заключение

Проект имеет **хорошую базовую структуру** с модульной архитектурой и разделением на слои. Основные проблемы:

1. **Критично:** Несуществующий импорт в `dashboard_service.py` — нужно исправить немедленно
2. **Важно:** Мёртвый код (v2 endpoints) — можно удалить без риска
3. **Желательно:** Улучшить инфраструктуру (Docker, CI/CD) и добавить аутентификацию

После исправления критичных проблем проект будет в **рабочем состоянии** и готов к дальнейшему развитию.
