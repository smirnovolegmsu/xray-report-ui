# Аудиты проекта

**Дата:** 2026-01-25

---

## Критические проблемы (P0)

1. **Несуществующий файл `dashboard.py`** — `dashboard_service.py` пытается импортировать `/opt/xray-report-ui/dashboard.py`, которого нет. Сломает работу overview модуля.
2. **v2 API endpoints — мёртвый код** — все 6 модулей имеют v2 endpoints, которые возвращают 501 и не используются.
3. **Избыточная документация** — много дубликатов и архивных материалов.

---

## Важные проблемы (P1)

4. **Нет явного разделения на слои** — бизнес-логика смешана с HTTP-обработчиками.
5. **Кеш без мониторинга** — in-memory кеш может утечь память (лимит 500, но нет метрик).
6. **TODO в критических местах** — `dashboard_service.py` имеет TODO о переносе логики.
7. **Отсутствие Docker/CI** — нет контейнеризации и автоматизации.

---

## Средние проблемы (P2)

8. **Дублирование констант** — API endpoints определены и в backend, и в frontend отдельно.
9. **Нет валидации входных данных** — некоторые API endpoints не валидируют параметры.
10. **Архивная документация не структурирована** — `docs/archive/` содержит много файлов без организации.

---

## Архитектура

**Компоненты:**
- Frontend: Next.js 16 (SSR/SPA), порт 3000, проксирует `/api/*` → backend:8787
- Backend: Flask + Gunicorn, порт 8787 (localhost only)
- Данные: JSON файлы (`data/settings.json`, `data/events.log`), CSV файлы (`/var/log/xray/usage/`)
- Внешние: Xray service (systemctl), файловая система для логов

**Стек:**
- Backend: Python 3.8+, Flask 2.0+, Gunicorn, structlog
- Frontend: Next.js 16.1.3, React 19.2.3, TypeScript 5, TailwindCSS 4
- State: SWR 2.3.8, Zustand 5.0.10

**Структура:**
- Backend: `backend/core/` (общие модули), `backend/features/` (модули по функциональности)
- Frontend: `frontend/app/` (страницы), `frontend/components/` (компоненты), `frontend/features/` (feature-модули)

---

## API

**Всего:** 28 методов v1 (production ready)

| Модуль | Методы | Endpoints |
|--------|--------|-----------|
| Overview | 3 | `/api/usage/*` |
| Users | 7 | `/api/users/*` |
| Live | 3 | `/api/live/*` |
| Events | 2 | `/api/events/*` |
| Header | 4 | `/api/system/*`, `/api/ports/*` |
| Settings | 8 | `/api/settings/*`, `/api/xray/*`, `/api/collector/*`, `/api/backups/*`, `/api/tests/*` |

**v2 API:** Все endpoints возвращают `501 Not Implemented` и не используются.

---

## Модули

| Модуль | Статус | Проблемы |
|--------|--------|----------|
| Overview | ⚠️ | Несуществующий dashboard.py |
| Users | ✅ | Работает |
| Live | ✅ | Работает |
| Events | ✅ | Работает |
| Header | ✅ | Работает |
| Settings | ✅ | Работает |

---

## Найденные дубли

1. **API endpoints константы** — определены и в backend, и в frontend отдельно (нужна синхронизация вручную)
2. **Валидация email/UUID** — есть и в backend, и в frontend (рекомендация: вынести в общий контракт)

---

## План действий

### Быстрые победы (1-3 дня)
1. Исправить `dashboard_service.py` (2-4 часа)
2. Удалить v2 API endpoints (1 час)
3. Очистить TODO комментарии (1 час)
4. Организовать docs/ (2-3 часа)
5. Проверить работоспособность (2 часа)

### Безопасный рефакторинг (1-2 недели)
6. Разделить ответственность (3-5 дней)
7. Добавить тесты (2-3 дня)
8. Улучшить обработку ошибок (1-2 дня)
9. Добавить Docker (2-3 дня)
10. Настроить CI/CD (2-3 дня)

---

## Аудиты модулей

### Events
- Избыточный код в page.tsx (хак для sidebar)
- Возможное дублирование запросов
- Множественные фильтры (вынести в хук)

### Users
- Hydration errors (использование браузерных API в SSR)
- Дублирование запросов

### Live
- Частые запросы (каждые 5 секунд)
- Нет кэширования

### Overview
- Backend проблемы (несуществующий dashboard.py)
- Оптимизация запросов (можно объединить)

### Header
- Частые запросы (каждые 10-30 секунд)
- Нет централизованного обновления

---

## Код аудиты

### Исправленные проблемы
1. **Мобильное отображение** — уменьшены размеры для мобильных, добавлены медиа-запросы
2. **Дублирование функции** — `_parse_date_from_name` вынесена в `utils.py`

### Найденные проблемы
1. Отсутствие классов (нарушение ООП) — код в основном процедурный
2. Хардкод путей — некоторые пути захардкожены
3. Отсутствие типизации — нет type hints в некоторых местах

---

## Заключение

Проект имеет **хорошую базовую структуру** с модульной архитектурой. Основные проблемы:

1. **Критично:** Несуществующий импорт в `dashboard_service.py` — нужно исправить немедленно
2. **Важно:** Мёртвый код (v2 endpoints) — можно удалить без риска
3. **Желательно:** Улучшить инфраструктуру (Docker, CI/CD) и добавить аутентификацию

После исправления критичных проблем проект будет в **рабочем состоянии** и готов к дальнейшему развитию.
