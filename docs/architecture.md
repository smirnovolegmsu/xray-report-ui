# 🏗️ Архитектура системы

## Обзор

Xray Report UI — веб-панель управления VPN сервером на базе Xray-core. Проект состоит из двух основных компонентов:

1. **Backend (Flask API)** — Python сервер, обрабатывающий запросы к Xray
2. **Frontend (Next.js)** — React приложение с современным UI

---

## Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                        Пользователь                          │
│                     http://SERVER:3000                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Next.js Frontend                          │
│                       PORT: 3000                             │
│              Сервис: xray-nextjs-ui.service                  │
│                                                              │
│   - Все страницы UI (Overview, Users, Online, Events, etc)  │
│   - Проксирует /api/* запросы на Backend                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ /api/*
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Flask Backend                            │
│                       PORT: 8787                             │
│              Сервис: xray-report-ui.service                  │
│                                                              │
│   - REST API для всех операций                               │
│   - Управление пользователями Xray                           │
│   - Сбор статистики и логов                                  │
│   - Интеграция с systemd                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Xray-core                               │
│               Конфиг: /usr/local/etc/xray/config.json        │
│                   Сервис: xray.service                       │
│                                                              │
│   - VPN сервер (VLESS + Reality)                             │
│   - Управление клиентами                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## Компоненты системы

### 1. Frontend (Next.js)

**Технологии:**
- Next.js 16 (App Router)
- React 19
- TypeScript
- Tailwind CSS
- Zustand (state management)
- SWR (data fetching)
- Framer Motion (анимации)

**Структура:**
```
frontend/
├── app/                    # Next.js App Router страницы
│   ├── page.tsx           # Главная страница (Overview)
│   ├── users/             # Страница пользователей
│   ├── online/            # Страница онлайн пользователей
│   ├── events/            # Страница событий
│   └── settings/          # Страница настроек
├── components/            # React компоненты
│   ├── features/          # Функциональные компоненты
│   ├── layout/            # Компоненты макета
│   └── ui/                # UI компоненты (shadcn/ui)
├── lib/                   # Утилиты и API клиент
│   ├── api.ts             # API клиент
│   ├── utils.ts           # Утилиты
│   └── store.ts           # Zustand store
└── types/                 # TypeScript типы
```

**Особенности:**
- Server-Side Rendering (SSR)
- Static Site Generation (SSG) где возможно
- API Routes для проксирования запросов к Backend
- Оптимизированная сборка с кешированием

---

### 2. Backend (Flask)

**Технологии:**
- Python 3.8+
- Flask (веб-фреймворк)
- Интеграция с Xray API
- Systemd интеграция

**Основные функции:**
- REST API для управления пользователями
- Сбор статистики из Xray
- Управление настройками
- Обработка событий
- Бэкапы конфигураций

**Эндпоинты:**
- `/api/users` — управление пользователями
- `/api/dashboard` — данные дашборда
- `/api/live/*` — мониторинг в реальном времени
- `/api/settings` — настройки системы
- `/api/system/*` — управление системой

---

### 3. Xray-core

**Назначение:**
- VPN сервер (VLESS + Reality протокол)
- Обработка VPN трафика
- Управление клиентами
- Статистика использования

**Интеграция:**
- Backend получает статистику через Xray Stats API (порт 10085)
- Управление пользователями через конфигурационный файл
- Автоматический перезапуск при изменениях

---

## Поток данных

### 1. Просмотр статистики
```
Пользователь → Frontend → Backend API → Xray Stats API → Backend → Frontend → Пользователь
```

### 2. Добавление пользователя
```
Пользователь → Frontend → Backend API → Чтение конфига Xray → 
Модификация конфига → Перезапуск Xray → Backend → Frontend → Пользователь
```

### 3. Мониторинг в реальном времени
```
Frontend (polling) → Backend API → Xray Stats API → Backend → Frontend (обновление UI)
```

---

## Порты и сервисы

| Порт | Сервис | Описание | Доступ |
|------|--------|----------|--------|
| **3000** | `xray-nextjs-ui` | Next.js Frontend (основной UI) | Публичный |
| **8787** | `xray-report-ui` | Flask Backend API | Только localhost |
| **443** | `xray` | Xray VLESS+Reality VPN | Публичный |
| **10085** | `xray` | Xray Stats API | Только localhost |

Подробнее см. [документацию по портам](./ports.md).

---

## Структура проекта

```
/opt/xray-report-ui/
├── app.py                 # Flask Backend (основной файл)
├── venv/                  # Python virtual environment
├── data/                  # Данные приложения (не в Git)
│   ├── settings.json      # Настройки UI
│   ├── events.log         # Лог событий
│   └── backups/           # Бэкапы конфигов
├── frontend/              # Next.js Frontend
│   ├── app/               # Next.js App Router страницы
│   ├── components/        # React компоненты
│   ├── lib/               # Утилиты и API клиент
│   └── types/             # TypeScript типы
├── scripts/                # Вспомогательные скрипты
│   ├── ports/             # Скрипты для работы с портами
│   └── services/          # Скрипты для работы с сервисами
└── docs/                  # Документация проекта
```

---

## Безопасность

### Frontend
- Все API запросы проксируются через Next.js
- Нет прямого доступа к Backend из браузера
- CORS настроен только для localhost

### Backend
- Слушает только на localhost (127.0.0.1)
- Недоступен извне напрямую
- Все запросы проходят через Frontend

### Xray
- VPN трафик зашифрован
- Reality протокол маскирует VPN трафик под HTTPS
- Статистика доступна только через localhost

---

## Масштабируемость

### Текущие ограничения:
- Один сервер для всех компонентов
- Нет балансировки нагрузки
- Нет репликации данных

### Возможные улучшения:
- Разделение Frontend и Backend на разные серверы
- Использование reverse proxy (nginx) для балансировки
- Кеширование данных (Redis)
- Мониторинг и логирование (Prometheus, Grafana)

---

## Развертывание

### Production окружение:
- Сервисы запускаются через systemd
- Автоматический перезапуск при падении
- Логирование в systemd journal

### Development окружение:
- Frontend: `npm run dev` (порт 3001)
- Backend: `python app.py` (порт 8787)

Подробнее см. [документацию по развертыванию](./development.md).
