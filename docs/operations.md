# Операции и инфраструктура

**Дата:** 2026-01-25

---

## Мониторинг и стабильность

### Реализованные меры

1. **Очистка дискового пространства** — освобождено ~2GB, автоматическая ротация логов (максимум 500MB), очистка старых бэкапов (оставляется 50 последних)

2. **Ограничения ресурсов в systemd:**
   - Frontend: MemoryMax 512MB, MemoryHigh 400MB, CPUQuota 150%, TasksMax 50
   - Backend: MemoryMax 256MB, MemoryHigh 200MB, CPUQuota 100%, TasksMax 20

3. **Мониторинг** — скрипт `scripts/services/check.sh` проверяет:
   - Статус сервисов и доступность портов
   - Использование диска (автоочистка при >85%)
   - Использование памяти (алерт при >90%)
   - Автоматическая очистка старых бэкапов и логов

4. **Health Checks** — скрипт `scripts/services/health-check.sh` проверяет доступность API endpoints с таймаутами (5 секунд, 3 попытки)

### Текущее состояние

- **Диск:** ~71% использования (было 79%), свободно ~5.3GB, лимит алерта 85%
- **Память:** ~65% использования, свободно ~1.3GB, лимит алерта 90%

---

## Оптимизация производительности

### Диагностика

**Характеристики сервера:** CPU 3 ядра, RAM 3.7GB (доступно ~2.1GB) — ⚠️ слабовато для сборки Next.js

**Проблемы:**
1. Отсутствие кэширования на бэкенде — каждый запрос читает все CSV файлы заново (500-3000ms)
2. Избыточные запросы с фронтенда — ~20-30 запросов в минуту, компоненты делают запросы каждые 5-30 секунд
3. Синхронная обработка CSV — блокирует event loop Flask
4. Отсутствие кэширования запросов на фронтенде — SWR установлен, но не используется

### Реализованные оптимизации

1. **Кэширование на бэкенде** — in-memory кэш с TTL, автоматическая очистка. Результат: 500-3000ms → 50-200ms (при попадании в кэш)

2. **Оптимизация Next.js:**
   - Кеширование webpack (`moduleIds: 'deterministic'`)
   - Оптимизация разделения чанков
   - Параллельная сборка через `webpackBuildWorker`
   - Оптимизация CSS через SWC

3. **Оптимизация TypeScript:**
   - Инкрементальная компиляция с кешем
   - `skipLibCheck: true` для пропуска проверки типов в node_modules

4. **Новые инструменты:**
   - Скрипт `frontend/build-fast.sh` для быстрой сборки
   - Оптимизированные npm скрипты

### Рекомендации

- **Для разработки:** `npm run dev` (не использовать `build` во время разработки!)
- **Для production:** `npm run build:fast` (быстрая сборка без проверок)
- **Для CI/CD:** `npm run build` (стандартная сборка с проверками)

### Результаты оптимизации

**До:** Время сборки 5-10 минут, память >2GB, CPU 100%

**После:** Время сборки 2-4 минуты, память ~1.5GB, CPU 80-90%

---

## Порты сервера

**Критичные порты (оставить):**
- **22** — SSH (удаленный доступ)
- **80** — HTTP (nginx)
- **443** — Xray VPN (VLESS + Reality)
- **3000** — Next.js Frontend (веб-интерфейс)
- **8787** — Flask Backend (API, только localhost)

**Управление:**
```bash
# Проверка портов
netstat -tulpn | grep LISTEN

# Закрытие через firewall
ufw deny 3000
```

---

## Управление сервисами

**Production сервисы:**
- Frontend: `http://localhost:3000` или `http://YOUR_SERVER_IP:3000`
- Backend: `http://localhost:8787` (только localhost)

**Настроено:**
- Автозапуск при загрузке системы
- Автоматический перезапуск при падении (через 10 секунд)
- Мониторинг здоровья (каждые 5 минут)
- Логирование в `/var/log/`

**Команды:**
```bash
# Статус
systemctl status xray-nextjs-ui xray-report-ui

# Перезапуск
systemctl restart xray-nextjs-ui xray-report-ui

# Логи
journalctl -u xray-nextjs-ui -f
journalctl -u xray-report-ui -f
```

**Если сервис не работает:**
1. Проверить статус: `systemctl status xray-nextjs-ui`
2. Проверить логи: `journalctl -u xray-nextjs-ui -n 50`
3. Перезагрузить systemd: `systemctl daemon-reload`
4. Перезапустить сервис: `systemctl restart xray-nextjs-ui`

**Автоматический мониторинг:**
Скрипт `scripts/services/check.sh` запускается каждые 5 минут через cron, проверяет статус всех сервисов, автоматически перезапускает упавшие, логирует события в `/var/log/xray-services-check.log`

---

## Рекомендации

1. Настроить алерты при падении сервисов
2. Регулярно проверять логи на ошибки
3. Настроить автоматические бэкапы
4. Регулярно обновлять зависимости
