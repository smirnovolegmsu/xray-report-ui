#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² - Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ðµ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²

echo "=========================================="
echo "  ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—ÐÐ¦Ð˜Ð¯ ÐŸÐžÐ Ð¢ÐžÐ’ ÐÐ Ð¡Ð•Ð Ð’Ð•Ð Ð•"
echo "=========================================="
echo ""

# Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð°Ð½Ð°Ð»Ð¸Ð·
echo "ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
echo ""
/opt/xray-report-ui/analyze-ports.sh

echo ""
echo "=========================================="
echo "  Ð’ÐÐ Ð˜ÐÐÐ¢Ð« ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—ÐÐ¦Ð˜Ð˜"
echo "=========================================="
echo ""

# Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾)
echo "1ï¸âƒ£  ÐŸÐ ÐžÐ¡ÐœÐžÐ¢Ð  (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ - Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚):"
echo "   ./cleanup-ports.sh --dry-run"
echo "   ÐŸÐ¾ÐºÐ°Ð¶ÐµÑ‚, ÐºÐ°ÐºÐ¸Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹ Ð±ÐµÐ· Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ"
echo ""

# Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¾Ñ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹
echo "2ï¸âƒ£  Ð—ÐÐšÐ Ð«Ð¢Ð¬ ÐÐ•Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð•ÐœÐ«Ð• ÐžÐ¢Ð›ÐÐ”ÐžÐ§ÐÐ«Ð• ÐŸÐžÐ Ð¢Ð«:"
echo "   ./cleanup-ports.sh"
echo "   Ð—Ð°ÐºÑ€Ð¾ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸ (ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ)"
echo "   ÐÐ• Ð·Ð°Ñ‚Ñ€Ð¾Ð½ÐµÑ‚ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸ Cursor Server"
echo ""

# Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Cursor Server
echo "3ï¸âƒ£  Ð—ÐÐšÐ Ð«Ð¢Ð¬ ÐŸÐžÐ Ð¢Ð« CURSOR SERVER:"
echo "   ./cleanup-ports.sh --kill-cursor"
echo "   âš ï¸  Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð­Ñ‚Ð¾ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Cursor Ñ‡ÐµÑ€ÐµÐ· SSH!"
echo "   Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ Cursor Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸"
echo ""

# Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 4: ÐšÐ¾Ð¼Ð±Ð¸Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ (Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ + Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ)
echo "4ï¸âƒ£  ÐšÐžÐœÐ‘Ð˜ÐÐ˜Ð ÐžÐ’ÐÐÐÐ«Ð™ (Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ + Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ):"
echo "   ./cleanup-ports.sh --kill-cursor --dry-run"
echo "   ÐŸÐ¾ÐºÐ°Ð¶ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¾, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Cursor Server"
echo ""

echo "=========================================="
echo "  Ð Ð•ÐšÐžÐœÐ•ÐÐ”ÐÐ¦Ð˜Ð˜"
echo "=========================================="
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹
UNUSED_COUNT=$(./cleanup-ports.sh --dry-run 2>/dev/null | grep -c "Ð‘ÑƒÐ´ÐµÑ‚ Ð·Ð°ÐºÑ€Ñ‹Ñ‚" || echo "0")
CURSOR_COUNT=$(ss -tulpn | grep LISTEN | grep "127.0.0.1:" | awk '{print $5}' | sed 's/.*://' | awk '$1 > 30000 && $1 < 60000' | wc -l)

if [ "$UNUSED_COUNT" -gt 0 ]; then
    echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²: $UNUSED_COUNT"
    echo "   Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: ./cleanup-ports.sh"
    echo ""
fi

if [ "$CURSOR_COUNT" -gt 0 ]; then
    echo "ðŸ’» ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² Cursor Server: $CURSOR_COUNT"
    echo "   Ð­Ñ‚Ð¸ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹ (ÑÐ»ÑƒÑˆÐ°ÑŽÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ localhost)"
    echo "   Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ Cursor Ñ‡ÐµÑ€ÐµÐ· SSH"
    echo ""
fi

echo "ðŸ“‹ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹ (ÐÐ• Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°Ñ‚ÑŒ):"
echo "   - 22 (SSH)"
echo "   - 53 (DNS)"
echo "   - 80 (HTTP)"
echo "   - 443 (Xray VPN)"
echo "   - 3000 (Next.js Frontend)"
echo "   - 8787 (Flask Backend)"
echo "   - 10085 (Xray API)"
echo ""

echo "=========================================="
echo "  Ð‘Ð«Ð¡Ð¢Ð Ð«Ð™ Ð¡Ð¢ÐÐ Ð¢"
echo "=========================================="
echo ""
echo "Ð”Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°:"
echo "  ./optimize-ports.sh"
echo ""
echo "Ð”Ð»Ñ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²:"
echo "  ./cleanup-ports.sh"
echo ""
echo "Ð”Ð»Ñ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² Cursor Server:"
echo "  ./cleanup-ports.sh --kill-cursor"
echo ""
