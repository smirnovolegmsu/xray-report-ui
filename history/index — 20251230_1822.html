<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Xray Usage</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@450;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --w: 2550px;
      --h: 1300px;

      --bg: #0c0f14;
      --panel: rgba(255,255,255,.045);
      --line: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --topbar-h: 70px;
      --filter-h: 56px;
      --bottom-h: 330px;
      --cards-h: calc(var(--h) - var(--topbar-h) - var(--filter-h) - var(--bottom-h));

      --gap: 12px;
      --r: 16px;

      --bad: rgba(239,71,111,.70);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }

    .frame{
      width: var(--w);
      height: var(--h);
      margin: 0 auto;
      transform-origin: top left;
      background: var(--bg);
      outline: 1px solid rgba(255,255,255,.06);
    }

    .topbar{
      height: var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--line);
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .brand .title{
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .brand .range{
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .seg{
      display:inline-flex;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow:hidden;
      background: transparent;
    }
    .seg button{
      all: unset;
      cursor:pointer;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 800;
      color: var(--muted);
      border-right: 1px solid var(--line);
    }
    .seg button:last-child{ border-right:none; }
    .seg button.active{
      background: rgba(255,255,255,.06);
      color: var(--text);
    }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }

    .chip{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      user-select:none;
    }

    .user-filter{
      height: var(--filter-h);
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 18px;
      border-bottom: 1px solid var(--line);
      overflow:hidden;
    }
    .user-filter .wrap{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 1;
      overflow:hidden;
      white-space:nowrap;
    }

    .toggle{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .toggle.on{
      background: rgba(255,255,255,.07);
      color: var(--text);
      border-color: rgba(255,255,255,.18);
    }
    .toggle.all.on{
      border-color: rgba(255,255,255,.26);
    }

    .main{
      height: calc(var(--h) - var(--topbar-h) - var(--filter-h));
      display:grid;
      grid-template-rows: var(--cards-h) var(--bottom-h);
    }

    /* 5x2 cards, no scroll */
    .cards{
      padding: 12px 18px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: var(--gap);
      overflow:hidden;
    }

    .user-card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel);
      overflow:hidden;
      display:grid;
      grid-template-rows: 68px 1fr;
      min-width: 0;
    }

    .card-head{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-width:0;
    }

    .u-title{ display:flex; flex-direction:column; gap: 4px; min-width:0; }
    .u-name{
      font-size: 15px;
      font-weight: 900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 340px;
    }
    .u-sub{
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      white-space:nowrap;
    }

    .badge{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      white-space:nowrap;
    }
    .badge.bad{
      border-color: rgba(239,71,111,.40);
      color: rgba(255,255,255,.86);
    }

    .card-body{
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
      min-width:0;
      min-height:0;
    }

    .blk{
      position:relative;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(0,0,0,.10);
      overflow:hidden;
      min-width:0;
      min-height:0;
      padding-top: 26px;
    }
    .blk-title{
      position:absolute;
      left: 10px;
      top: 8px;
      font-size: 13px;
      font-weight: 900;
      color: rgba(255,255,255,.86);
      letter-spacing: .1px;
    }

    canvas{ width:100% !important; height:100% !important; }

    .placeholder{
      position:absolute;
      inset: 26px 10px 10px 10px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      text-align:center;
      padding: 0 10px;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      line-height: 1.15;
    }
    thead th{
      text-align:left;
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.78);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    tbody td{
      padding: 4px 8px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      vertical-align:top;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }
    .tiny{ font-size: 10px; color: var(--muted); font-weight: 800; }

    .bottom{
      padding: 12px 18px;
      border-top: 1px solid var(--line);
      overflow:hidden;
    }
    .bottom-grid{
      height: 100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: var(--gap);
    }
    .bcard{
      position:relative;
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel);
      overflow:hidden;
      padding-top: 30px;
    }
    .btitle{
      position:absolute;
      left: 12px;
      top: 10px;
      font-size: 14px;
      font-weight: 900;
      color: rgba(255,255,255,.86);
    }

    .toast{
      position:absolute;
      right: 18px;
      bottom: 18px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      font-weight: 800;
      display:none;
      max-width: 620px;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <div class="frame" id="frame">
    <div class="topbar">
      <div class="brand">
        <div class="title">Xray Usage</div>
        <div class="range" id="range">—</div>
      </div>

      <div class="controls">
        <div class="seg" id="unitSeg">
          <button data-unit="GB" class="active">GB</button>
          <button data-unit="MB">MB</button>
        </div>
        <button class="btn" id="refreshBtn">Обновить</button>
        <div class="chip" id="statusChip">loading…</div>
      </div>
    </div>

    <div class="user-filter">
      <div class="wrap" id="userFilter"></div>
      <div class="chip">выбрано &gt;10 → покажу первые 10</div>
    </div>

    <div class="main">
      <div class="cards" id="cardsPanel"></div>
      <div class="bottom">
        <div class="bottom-grid" id="bottomGrid"></div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
  Chart.register(ChartDataLabels);

  function applyScale(){
    const frame = document.getElementById('frame');
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const scale = Math.min(vw / 2550, vh / 1300, 1);
    frame.style.transform = `scale(${scale})`;
  }
  window.addEventListener('resize', applyScale);
  applyScale();

  const LS_USERS = 'xray_ui_selected_users_v1';
  const LS_UNIT  = 'xray_ui_unit_v1';

  const state = {
    unit: localStorage.getItem(LS_UNIT) || "GB",
    data: null,
    charts: new Map(),
    selectedUsers: new Set(),
    etag: null
  };

  function fmtNum(x, digits=2){
    if (!isFinite(x)) return "0";
    return Number(x).toFixed(digits);
  }
  function bytesTo(unit, bytes){
    return unit === "MB" ? (bytes / 1_000_000.0) : (bytes / 1_000_000_000.0);
  }
  function formatTraffic(unit, bytes){
    const v = bytesTo(unit, bytes);
    const d = unit === "MB" ? 1 : 2;
    return `${fmtNum(v, d)} ${unit}`;
  }

  // YYYY-MM-DD -> MM.DD
  function fmtDayLabel(iso){
    const p = String(iso).split('-');
    if (p.length !== 3) return iso;
    return `${p[1]}.${p[2]}`;
  }

  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(()=>t.classList.remove('show'), 2600);
  }

  function makeBarColor(isBad=false){
    return isBad ? 'rgba(239,71,111,.65)' : 'rgba(255,255,255,.20)';
  }

  function baseChartOptions(){
    return {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 180 },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(0,0,0,.75)',
          borderColor: 'rgba(255,255,255,.12)',
          borderWidth: 1,
          titleColor: 'rgba(255,255,255,.92)',
          bodyColor: 'rgba(255,255,255,.86)'
        },
        datalabels: {
          color: 'rgba(255,255,255,.88)',
          font: { weight: '800', size: 10 },
          anchor: 'center',
          align: 'center',
          clamp: true
        }
      },
      scales: {
        x: {
          ticks: { color: 'rgba(255,255,255,.62)', font: {weight: '800', size: 10 } },
          grid: { color: 'rgba(255,255,255,.06)' }
        },
        y: {
          ticks: { color: 'rgba(255,255,255,.50)', font: {weight: '800', size: 10 } },
          grid: { color: 'rgba(255,255,255,.06)' }
        }
      }
    }
  }

  function buildTrafficBar(canvas, labels, bytesArr, anomalyLabelSet){
    const unit = state.unit;
    const data = bytesArr.map(b => bytesTo(unit, b));
    const opts = baseChartOptions();
    opts.plugins.datalabels.formatter = (v)=> (v === 0 ? '' : fmtNum(v, unit === "MB" ? 1 : 2));
    return new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: (ctx)=>{
            const idx = ctx.dataIndex ?? 0;
            const lab = labels[idx];
            return makeBarColor(anomalyLabelSet.has(lab));
          },
          borderRadius: 8,
          maxBarThickness: 26
        }]
      },
      options: opts
    });
  }

  function buildConnsBar(canvas, labels, countsArr){
    const opts = baseChartOptions();
    opts.plugins.datalabels.formatter = (v)=> (v === 0 ? '' : String(Math.round(v)));
    return new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: countsArr,
          backgroundColor: 'rgba(255,255,255,.20)',
          borderRadius: 8,
          maxBarThickness: 26
        }]
      },
      options: opts
    });
  }

  function buildLine(canvas, labels, values, isTraffic=false){
    const opts = baseChartOptions();
    opts.plugins.datalabels.align = 'top';
    opts.plugins.datalabels.anchor = 'end';
    opts.plugins.datalabels.formatter = (v)=>{
      if (!v) return '';
      if (isTraffic) return fmtNum(v, state.unit === "MB" ? 1 : 2);
      return String(Math.round(v));
    };
    return new Chart(canvas, {
      type: 'line',
      data: { labels, datasets: [{
        data: values,
        fill: true,
        backgroundColor: 'rgba(255,255,255,.04)',
        borderColor: 'rgba(255,255,255,.35)',
        pointRadius: 2,
        pointHoverRadius: 3,
        tension: .30
      }]},
      options: opts
    });
  }

  function clearNode(el){ while (el.firstChild) el.removeChild(el.firstChild); }

  function escapeHtml(s){
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }
  function shorten(s, n){
    s = String(s);
    if (s.length <= n) return s;
    return s.slice(0, n-1) + '…';
  }

  function loadSelected(users){
    try{
      const raw = localStorage.getItem(LS_USERS);
      if (!raw) return new Set(users);
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return new Set(users);
      const s = new Set(arr.filter(u => users.includes(u)));
      return s.size ? s : new Set(users);
    }catch(_){
      return new Set(users);
    }
  }
  function saveSelected(){
    localStorage.setItem(LS_USERS, JSON.stringify([...state.selectedUsers]));
  }

  function createToggle(label, onClick, cls=''){
    const b = document.createElement('div');
    b.className = `toggle ${cls}`.trim();
    b.textContent = label;
    b.addEventListener('click', onClick);
    return b;
  }

  function buildUserFilter(users){
    const wrap = document.getElementById('userFilter');
    clearNode(wrap);

    state.selectedUsers = loadSelected(users);

    const allBtn = createToggle('Все', ()=>{
      const allOn = state.selectedUsers.size !== users.length;
      state.selectedUsers = new Set(allOn ? users : []);
      saveSelected();
      syncToggles();
      syncCardsVisibility();
    }, 'all');
    allBtn.dataset.user = '__ALL__';
    wrap.appendChild(allBtn);

    users.forEach(u=>{
      const btn = createToggle(u, ()=>{
        if (state.selectedUsers.has(u)) state.selectedUsers.delete(u);
        else state.selectedUsers.add(u);
        saveSelected();
        syncToggles();
        syncCardsVisibility();
      });
      btn.dataset.user = u;
      wrap.appendChild(btn);
    });

    syncToggles();
  }

  function syncToggles(){
    const users = state.data?.users || [];
    document.querySelectorAll('.toggle').forEach(el=>{
      const u = el.dataset.user;
      if (u === '__ALL__'){
        el.classList.toggle('on', state.selectedUsers.size === users.length && users.length > 0);
        return;
      }
      el.classList.toggle('on', state.selectedUsers.has(u));
    });
  }

  function syncCardsVisibility(){
    const users = state.data?.users || [];
    const selectedOrdered = users.filter(u => state.selectedUsers.has(u));
    const visible = new Set(selectedOrdered.slice(0, 10));
    if (selectedOrdered.length > 10) showToast('Выбрано >10: показываю первые 10');

    document.querySelectorAll('.user-card').forEach(card=>{
      const u = card.dataset.user;
      card.style.display = visible.has(u) ? 'grid' : 'none';
    });
  }

  function enableSort(table, rows, mode){
    table.querySelector('thead').addEventListener('click', (e)=>{
      const th = e.target.closest('th');
      if (!th) return;
      const key = th.dataset.key;
      if (!key) return;

      const dir = (table.dataset.sort === key && table.dataset.dir === 'desc') ? 'asc' : 'desc';
      table.dataset.sort = key;
      table.dataset.dir = dir;

      let sorted = [...rows];
      sorted.sort((a,b)=>{
        let av, bv;
        if (mode === 'traffic'){
          av = (key === 'domain') ? a.domain : a.bytes;
          bv = (key === 'domain') ? b.domain : b.bytes;
        } else {
          av = (key === 'domain') ? a.domain : a.count;
          bv = (key === 'domain') ? b.domain : b.count;
        }
        if (typeof av === 'string'){
          const res = av.localeCompare(bv);
          return dir === 'asc' ? res : -res;
        }
        const res = av - bv;
        return dir === 'asc' ? res : -res;
      });

      const tbody = table.querySelector('tbody');
      clearNode(tbody);

      if (mode === 'traffic'){
        sorted.forEach(r=>{
          const v = bytesTo(state.unit, r.bytes);
          const d = state.unit === "MB" ? 1 : 2;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td title="${escapeHtml(r.domain)}">${escapeHtml(shorten(r.domain, 30))}</td>
            <td class="right">${fmtNum(v, d)}<div class="tiny">${fmtNum(r.pct, 1)}%</div></td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        sorted.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td title="${escapeHtml(r.domain)}">${escapeHtml(shorten(r.domain, 30))}</td>
            <td class="right">${r.count}<div class="tiny">${fmtNum(r.pct, 1)}%</div></td>
          `;
          tbody.appendChild(tr);
        });
      }
    });
  }

  function buildTableTraffic(rows){
    const table = document.createElement('table');
    table.dataset.sort = 'bytes';
    table.dataset.dir = 'desc';
    table.innerHTML = `
      <thead><tr>
        <th data-key="domain">Domain</th>
        <th data-key="bytes" class="right">Value</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    rows.forEach(r=>{
      const v = bytesTo(state.unit, r.bytes);
      const d = state.unit === "MB" ? 1 : 2;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td title="${escapeHtml(r.domain)}">${escapeHtml(shorten(r.domain, 30))}</td>
        <td class="right">${fmtNum(v, d)}<div class="tiny">${fmtNum(r.pct, 1)}%</div></td>
      `;
      tbody.appendChild(tr);
    });
    enableSort(table, rows, 'traffic');
    return table;
  }

  function buildTableConns(rows){
    const table = document.createElement('table');
    table.dataset.sort = 'count';
    table.dataset.dir = 'desc';
    table.innerHTML = `
      <thead><tr>
        <th data-key="domain">Domain</th>
        <th data-key="count" class="right">Count</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td title="${escapeHtml(r.domain)}">${escapeHtml(shorten(r.domain, 30))}</td>
        <td class="right">${r.count}<div class="tiny">${fmtNum(r.pct, 1)}%</div></td>
      `;
      tbody.appendChild(tr);
    });
    enableSort(table, rows, 'conns');
    return table;
  }

  function userSubtitle(uobj){
    const tot = uobj.totals || {};
    const t = tot.traffic_7d_bytes || 0;
    const c = tot.conns_7d || 0;
    return `7д: ${formatTraffic(state.unit, t)} • conns: ${c}`;
  }

  function buildUserCards(payload){
    const panel = document.getElementById('cardsPanel');
    clearNode(panel);

    state.charts.forEach(ch => ch.destroy());
    state.charts.clear();

    const rawDays = payload.meta.days || [];
    const labels = rawDays.map(fmtDayLabel);

    payload.users.forEach(u=>{
      const uobj = payload.per_user[u];
      const anomalyDaysRaw = (uobj.totals?.anomaly_days || []);
      const anomalyLabelSet = new Set(anomalyDaysRaw.map(fmtDayLabel));

      const card = document.createElement('div');
      card.className = 'user-card';
      card.dataset.user = u;

      const head = document.createElement('div');
      head.className = 'card-head';
      head.innerHTML = `
        <div class="u-title">
          <div class="u-name">${escapeHtml(u)}</div>
          <div class="u-sub">${escapeHtml(userSubtitle(uobj))}</div>
        </div>
        <div>${anomalyDaysRaw.length ? `<span class="badge bad">аномалий: ${anomalyDaysRaw.length}</span>` : `<span class="badge">ok</span>`}</div>
      `;
      card.appendChild(head);

      const body = document.createElement('div');
      body.className = 'card-body';

      const blk1 = document.createElement('div');
      blk1.className = 'blk';
      blk1.innerHTML = `<div class="blk-title">Трафик (7д)</div>`;
      const c1 = document.createElement('canvas');
      blk1.appendChild(c1);

      const blk2 = document.createElement('div');
      blk2.className = 'blk';
      blk2.innerHTML = `<div class="blk-title">Подключения (7д)</div>`;
      const c2 = document.createElement('canvas');
      blk2.appendChild(c2);

      const blk3 = document.createElement('div');
      blk3.className = 'blk';
      blk3.innerHTML = `<div class="blk-title">ТОП домены • трафик</div>`;

      const blk4 = document.createElement('div');
      blk4.className = 'blk';
      blk4.innerHTML = `<div class="blk-title">ТОП домены • conns</div>`;

      body.appendChild(blk1);
      body.appendChild(blk2);
      body.appendChild(blk3);
      body.appendChild(blk4);
      card.appendChild(body);
      panel.appendChild(card);

      const tByDay = uobj.traffic_by_day_bytes || {};
      const cByDay = uobj.conns_by_day || {};
      const trafficArr = rawDays.map(d => tByDay[d] || 0);
      const connsArr = rawDays.map(d => cByDay[d] || 0);

      if (!trafficArr.some(v => v > 0)){
        blk1.innerHTML = `<div class="blk-title">Трафик (7д)</div><div class="placeholder">Нет данных за 7 дней</div>`;
      } else {
        state.charts.set(`u:${u}:t`, buildTrafficBar(c1, labels, trafficArr, anomalyLabelSet));
      }

      if (!connsArr.some(v => v > 0)){
        blk2.innerHTML = `<div class="blk-title">Подключения (7д)</div><div class="placeholder">Нет данных за 7 дней</div>`;
      } else {
        state.charts.set(`u:${u}:c`, buildConnsBar(c2, labels, connsArr));
      }

      const tRows = uobj.top_domains_traffic || [];
      const cRows = uobj.top_domains_conns || [];

      if (!tRows.length){
        blk3.innerHTML = `<div class="blk-title">ТОП домены • трафик</div><div class="placeholder">Нет данных</div>`;
      } else {
        blk3.appendChild(buildTableTraffic(tRows));
      }

      if (!cRows.length){
        blk4.innerHTML = `<div class="blk-title">ТОП домены • conns</div><div class="placeholder">Нет данных</div>`;
      } else {
        blk4.appendChild(buildTableConns(cRows));
      }
    });

    syncToggles();
    syncCardsVisibility();
  }

  function buildBottom(payload){
    const grid = document.getElementById('bottomGrid');
    grid.innerHTML = '';

    const rawDays = payload.meta.days || [];
    const labels = rawDays.map(fmtDayLabel);

    const dailyTrafficBytes = payload.global.daily_traffic_bytes || {};
    const dailyConns = payload.global.daily_conns || {};

    const dailyTraffic = rawDays.map(d => bytesTo(state.unit, dailyTrafficBytes[d] || 0));
    const dailyConnArr = rawDays.map(d => dailyConns[d] || 0);

    const cumTrafficBytes = payload.global.cumulative_traffic_bytes || [];
    const cumConns = payload.global.cumulative_conns || [];
    const cumTraffic = cumTrafficBytes.map(b => bytesTo(state.unit, b || 0));

    const cards = [
      {title:`Кумулятивный трафик (${state.unit})`, key:'cum_t', values:cumTraffic, isTraffic:true},
      {title:'Кумулятивные подключения', key:'cum_c', values:cumConns, isTraffic:false},
      {title:`Ежедневный трафик (${state.unit})`, key:'day_t', values:dailyTraffic, isTraffic:true},
      {title:'Ежедневные подключения', key:'day_c', values:dailyConnArr, isTraffic:false}
    ];

    cards.forEach((c)=>{
      const bc = document.createElement('div');
      bc.className = 'bcard';
      bc.innerHTML = `<div class="btitle">${c.title}</div>`;
      const canvas = document.createElement('canvas');
      bc.appendChild(canvas);
      grid.appendChild(bc);

      const any = c.values.some(v => v > 0);
      if (!any){
        bc.innerHTML = `<div class="btitle">${c.title}</div><div class="placeholder">Нет данных за 7 дней</div>`;
        return;
      }
      const ch = buildLine(canvas, labels, c.values, c.isTraffic);
      state.charts.set(`bottom:${c.key}`, ch);
    });
  }

  function updateRangeText(payload){
    const raw = payload.meta.days || [];
    const el = document.getElementById('range');
    if (!raw.length){ el.textContent = 'нет данных'; return; }
    const from = fmtDayLabel(raw[0]);
    const to = fmtDayLabel(raw[raw.length-1]);
    const year = String(raw[raw.length-1]).slice(0,4);
    el.textContent = `${from} → ${to} • ${year}`;
  }

  function updateStatus(ok, msg){
    const chip = document.getElementById('statusChip');
    chip.textContent = msg;
    chip.style.borderColor = ok ? 'rgba(255,255,255,.14)' : 'rgba(239,71,111,.45)';
    chip.style.color = ok ? 'rgba(255,255,255,.70)' : 'rgba(255,255,255,.86)';
  }

  document.getElementById('unitSeg').addEventListener('click', (e)=>{
    const b = e.target.closest('button');
    if (!b) return;
    const unit = b.dataset.unit;
    if (!unit || unit === state.unit) return;

    state.unit = unit;
    localStorage.setItem(LS_UNIT, unit);
    document.querySelectorAll('#unitSeg button').forEach(x=>x.classList.toggle('active', x.dataset.unit === unit));

    if (state.data){
      buildUserCards(state.data);
      buildBottom(state.data);
      showToast(`Единицы: ${unit}`);
    }
  });

  async function loadDashboard(){
    try{
      updateStatus(true, 'loading…');

      const headers = {};
      if (state.etag) headers['If-None-Match'] = state.etag;

      const res = await fetch('/api/dashboard?days=7', {headers});
      if (res.status === 304){ updateStatus(true, 'up-to-date'); return; }
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const etag = res.headers.get('ETag');
      if (etag) state.etag = etag.replaceAll('"','');

      const payload = await res.json();
      state.data = payload;

      document.querySelectorAll('#unitSeg button').forEach(x=>x.classList.toggle('active', x.dataset.unit === state.unit));

      updateRangeText(payload);
      buildUserFilter(payload.users || []);
      buildUserCards(payload);
      buildBottom(payload);

      updateStatus(true, 'ok');
    } catch(err){
      console.error(err);
      updateStatus(false, 'error');
      showToast('Ошибка загрузки данных (см. консоль)');
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', ()=>{
    state.etag = null;
    loadDashboard();
  });

  loadDashboard();
  setInterval(loadDashboard, 60_000);
</script>
</body>
</html>
