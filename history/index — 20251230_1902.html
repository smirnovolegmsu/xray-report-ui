<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Xray Usage</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --w: 2550px;
      --h: 1300px;
      --gap: 12px;
      --r: 14px;

      --topbar-h: 74px;
      --filter-h: 58px;
      --bottom-h: 340px;
      --cards-h: calc(var(--h) - var(--topbar-h) - var(--filter-h) - var(--bottom-h));
    }

    /* DARK (default) */
    body[data-theme="dark"]{
      --bg: #0b0d12;
      --panel: rgba(255,255,255,.035);
      --line: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.68);

      /* chart */
      --grid: rgba(255,255,255,.06);
      --bar: rgba(120,180,255,.34);
      --bar2: rgba(255,255,255,.18);
      --stroke: rgba(255,255,255,.28);
      --fill: rgba(255,255,255,.04);

      --bad: rgba(239,71,111,.78);
      --bad_bar: rgba(239,71,111,.58);
      --shadow: rgba(0,0,0,.55);
    }

    /* LIGHT */
    body[data-theme="light"]{
      --bg: #f7f7fa;
      --panel: rgba(0,0,0,.03);
      --line: rgba(0,0,0,.10);
      --text: rgba(0,0,0,.88);
      --muted: rgba(0,0,0,.55);

      --grid: rgba(0,0,0,.06);
      --bar: rgba(20,60,120,.24);
      --bar2: rgba(0,0,0,.16);
      --stroke: rgba(0,0,0,.28);
      --fill: rgba(0,0,0,.03);

      --bad: rgba(200,30,70,.80);
      --bad_bar: rgba(200,30,70,.50);
      --shadow: rgba(0,0,0,.12);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }

    .frame{
      width: var(--w);
      height: var(--h);
      margin: 0 auto;
      transform-origin: top left;
      background: var(--bg);
    }

    .topbar{
      height: var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
    }

    .brand{ display:flex; flex-direction:column; gap: 6px; }
    .brand .title{
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .brand .range{
      font-size: 14px;
      font-weight: 900;
      color: var(--muted);
    }

    .controls{ display:flex; align-items:center; gap: 10px; }

    .seg{
      display:inline-flex;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow:hidden;
      background: transparent;
    }
    .seg button{
      all: unset;
      cursor:pointer;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 900;
      color: var(--muted);
      border-right: 1px solid var(--line);
    }
    .seg button:last-child{ border-right:none; }
    .seg button.active{
      background: rgba(127,127,127,.10);
      color: var(--text);
    }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-weight: 900;
      font-size: 13px;
      user-select:none;
    }
    .btn:hover{ background: rgba(127,127,127,.10); }

    .chip{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
      user-select:none;
      white-space:nowrap;
    }

    .user-filter{
      height: var(--filter-h);
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 18px;
      border-bottom: 1px solid var(--line);
      overflow:hidden;
    }
    .user-filter .wrap{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 1;
      overflow:hidden;
      white-space:nowrap;
    }

    .toggle{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .toggle.on{
      background: rgba(127,127,127,.10);
      color: var(--text);
    }

    .main{
      height: calc(var(--h) - var(--topbar-h) - var(--filter-h));
      display:grid;
      grid-template-rows: var(--cards-h) var(--bottom-h);
    }

    .cards{
      padding: 12px 18px;
      display:grid;
      gap: var(--gap);
      overflow:hidden;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(2, 1fr);
    }

    .user-card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel);
      overflow:hidden;
      display:grid;
      grid-template-rows: 72px 1fr;
      min-width: 0;
    }

    .card-head{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(127,127,127,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-width:0;
    }

    .u-title{ display:flex; flex-direction:column; gap: 7px; min-width:0; }
    .u-name{
      font-size: 16px;
      font-weight: 900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 420px;
    }
    .u-sub{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      white-space:nowrap;
    }

    .badge{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(127,127,127,.22);
      color: var(--muted);
      white-space:nowrap;
    }
    .badge.bad{
      border-color: rgba(239,71,111,.40);
      color: var(--text);
    }

    .card-body{
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      /* больше высоты таблицам */
      grid-template-rows: 0.85fr 1.15fr;
      gap: 10px;
      min-width:0;
      min-height:0;
    }

    .blk{
      position:relative;
      border: 1px solid rgba(127,127,127,.12);
      border-radius: 12px;
      background: transparent;
      overflow:hidden;
      min-width:0;
      min-height:0;
      padding-top: 30px;
    }
    .blk-title{
      position:absolute;
      left: 10px;
      top: 8px;
      font-size: 15px;
      font-weight: 900;
      color: rgba(127,127,127,.95);
    }

    canvas{ width:100% !important; height:100% !important; }

    .placeholder{
      position:absolute;
      inset: 30px 10px 10px 10px;
      border-radius: 12px;
      border: 1px dashed rgba(127,127,127,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      text-align:center;
      padding: 0 10px;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 9px;
      line-height: 1.1;
    }
    thead th{
      text-align:left;
      padding: 6px 8px;
      border-bottom: 1px solid rgba(127,127,127,.16);
      color: rgba(127,127,127,.95);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    tbody td{
      padding: 2px 8px;
      border-bottom: 1px solid rgba(127,127,127,.10);
      color: var(--text);
      vertical-align:top;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }
    .tiny{ font-size: 9px; color: var(--muted); font-weight: 900; }

    .bottom{
      padding: 12px 18px;
      border-top: 1px solid var(--line);
      overflow:hidden;
    }
    .bottom-grid{
      height: 100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: var(--gap);
    }
    .bcard{
      position:relative;
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel);
      overflow:hidden;
      padding-top: 38px;
    }
    .btitle{
      position:absolute;
      left: 12px;
      top: 10px;
      font-size: 17px;
      font-weight: 900;
      color: rgba(127,127,127,.95);
    }

    .toast{
      position:absolute;
      right: 18px;
      bottom: 18px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.22);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.90);
      font-size: 12px;
      font-weight: 900;
      display:none;
      max-width: 860px;
      box-shadow: 0 12px 40px var(--shadow);
    }
    body[data-theme="light"] .toast{
      background: rgba(255,255,255,.88);
      color: rgba(0,0,0,.82);
    }
    .toast.show{ display:block; }

    /* ADMIN MODAL */
    .modal{
      position:absolute;
      inset: 0;
      display:none;
      background: rgba(0,0,0,.45);
      align-items:center;
      justify-content:center;
      padding: 22px;
    }
    body[data-theme="light"] .modal{ background: rgba(0,0,0,.20); }
    .modal.show{ display:flex; }

    .modal-card{
      width: 2100px;
      height: 1180px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: var(--bg);
      box-shadow: 0 20px 80px var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-rows: 74px 1fr;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
    }
    .modal-title{
      font-size: 22px;
      font-weight: 900;
    }
    .modal-body{
      display:grid;
      grid-template-columns: 560px 1fr;
      gap: 12px;
      padding: 12px;
      overflow:hidden;
    }
    .panel{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--panel);
      overflow:hidden;
      padding: 12px;
    }
    .panel h3{
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: 900;
      color: rgba(127,127,127,.95);
    }
    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
    }
    .field input{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 900;
      outline:none;
      background: transparent;
      color: var(--text);
    }
    .row-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .admin-table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      line-height: 1.15;
    }
    .admin-table th, .admin-table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(127,127,127,.12);
      vertical-align: top;
    }
    .admin-table th{
      color: rgba(127,127,127,.95);
      font-weight: 900;
      text-align:left;
      user-select:none;
    }
    .admin-table td{ color: var(--text); font-weight: 800; }
    .admin-scroll{
      height: 100%;
      overflow:auto;
    }
    .mini{
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
    }
    .pill{
      display:inline-block;
      border: 1px solid rgba(127,127,127,.22);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
    }
    .kbtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.22);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .kbtn:hover{ background: rgba(127,127,127,.10); }
    .kbtn.danger{
      border-color: rgba(239,71,111,.45);
      color: var(--text);
    }
  </style>
</head>

<body data-theme="dark">
  <div class="frame" id="frame">
    <div class="topbar">
      <div class="brand">
        <div class="title">Xray Usage</div>
        <div class="range" id="range">—</div>
      </div>

      <div class="controls">
        <div class="seg" id="themeSeg">
          <button data-theme="dark" class="active">Dark</button>
          <button data-theme="light">Light</button>
        </div>

        <div class="seg" id="unitSeg">
          <button data-unit="GB" class="active">GB</button>
          <button data-unit="MB">MB</button>
        </div>

        <button class="btn" id="adminBtn">Управление</button>
        <button class="btn" id="refreshBtn">Обновить</button>
        <div class="chip" id="statusChip">loading…</div>
      </div>
    </div>

    <div class="user-filter">
      <div class="wrap" id="userFilter"></div>
      <div class="chip">>10 выбрано → первые 10</div>
    </div>

    <div class="main">
      <div class="cards" id="cardsPanel"></div>
      <div class="bottom">
        <div class="bottom-grid" id="bottomGrid"></div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- ADMIN MODAL -->
    <div class="modal" id="adminModal">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">Управление пользователями</div>
          <div style="display:flex; gap:10px; align-items:center;">
            <span class="pill" id="adminTokenHint" style="display:none;">token required</span>
            <button class="btn" id="adminClose">Закрыть</button>
          </div>
        </div>

        <div class="modal-body">
          <div class="panel">
            <h3>Действия</h3>

            <div class="field" id="tokenField" style="display:none;">
              <label>Admin token (X-Admin-Token)</label>
              <input id="adminToken" placeholder="если включил XRAY_UI_ADMIN_TOKEN"/>
            </div>

            <div class="panel" style="padding:12px; margin:0 0 12px 0;">
              <h3 style="margin-bottom:10px;">Добавить пользователя</h3>
              <div class="field">
                <label>email / user_id (можно пусто → auto user_XX)</label>
                <input id="addEmail" placeholder="например: user_11"/>
              </div>
              <div class="field">
                <label>Alias (как отображать в UI)</label>
                <input id="addAlias" placeholder="например: Миша"/>
              </div>
              <div class="row-actions">
                <button class="kbtn" id="addBtn">Добавить</button>
                <button class="kbtn" id="copyAddLinkBtn" disabled>Скопировать ссылку</button>
              </div>
              <div class="mini" id="addResult" style="margin-top:10px; white-space:pre-wrap;"></div>
            </div>

            <div class="mini">
              Переименование — это алиас (история не ломается). Удаление — выкидывает UUID из Xray (доступ отрубается).
            </div>
          </div>

          <div class="panel" style="padding:0;">
            <div style="padding:12px 12px 0 12px;">
              <h3>Пользователи + all-time статистика</h3>
              <div class="mini" id="adminStatus" style="margin-bottom:10px;">—</div>
            </div>

            <div class="admin-scroll">
              <table class="admin-table" id="adminTable">
                <thead>
                  <tr>
                    <th style="width:260px;">User</th>
                    <th style="width:260px;">Email</th>
                    <th style="width:170px;">UUID</th>
                    <th style="width:110px;">Days</th>
                    <th style="width:200px;">Traffic</th>
                    <th style="width:180px;">Conns</th>
                    <th>Top-3 sites (traffic)</th>
                    <th style="width:220px;">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div>

<script>
  Chart.register(ChartDataLabels);

  // без скроллов: масштаб под окно
  function applyScale(){
    const frame = document.getElementById('frame');
    const vw = window.innerWidth, vh = window.innerHeight;
    const scale = Math.min(vw / 2550, vh / 1300, 1);
    frame.style.transform = `scale(${scale})`;
    frame.style.transformOrigin = 'top left';
  }
  window.addEventListener('resize', applyScale);
  applyScale();

  const LS_USERS  = 'xray_ui_selected_users_v4';
  const LS_UNIT   = 'xray_ui_unit_v4';
  const LS_THEME  = 'xray_ui_theme_v1';
  const LS_TOKEN  = 'xray_ui_admin_token_v1';

  const state = {
    unit: localStorage.getItem(LS_UNIT) || "GB",
    theme: localStorage.getItem(LS_THEME) || "dark",
    data: null,
    charts: new Map(),
    selectedUsers: new Set(),
    etag: null,
    aliases: {}
  };

  function cssVar(name){
    return getComputedStyle(document.body).getPropertyValue(name).trim();
  }

  function fmtNum(x, digits=2){
    if (!isFinite(x)) return "0";
    return Number(x).toFixed(digits);
  }
  function bytesTo(unit, bytes){
    return unit === "MB" ? (bytes / 1_000_000.0) : (bytes / 1_000_000_000.0);
  }
  function formatTraffic(unit, bytes){
    const v = bytesTo(unit, bytes);
    const d = unit === "MB" ? 1 : 2;
    return `${fmtNum(v, d)} ${unit}`;
  }
  function fmtDayLabel(iso){
    const p = String(iso).split('-');
    if (p.length !== 3) return iso;
    return `${p[1]}.${p[2]}`;
  }
  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(()=>t.classList.remove('show'), 2500);
  }
  function clearNode(el){ while (el.firstChild) el.removeChild(el.firstChild); }
  function escapeHtml(s){
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }
  function shorten(s, n){
    s = String(s);
    if (s.length <= n) return s;
    return s.slice(0, n-1) + '…';
  }

  function loadSelected(users){
    try{
      const raw = localStorage.getItem(LS_USERS);
      if (!raw) return new Set(users);
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return new Set(users);
      const s = new Set(arr.filter(u => users.includes(u)));
      return s.size ? s : new Set(users);
    }catch(_){
      return new Set(users);
    }
  }
  function saveSelected(){
    localStorage.setItem(LS_USERS, JSON.stringify([...state.selectedUsers]));
  }

  function baseChartOptions(){
    const grid = cssVar('--grid');
    const muted = cssVar('--muted');
    const text = cssVar('--text');
    return {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 140 },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          backgroundColor: state.theme === 'light' ? 'rgba(255,255,255,.92)' : 'rgba(0,0,0,.70)',
          borderColor: cssVar('--line'),
          borderWidth: 1,
          titleColor: text,
          bodyColor: text
        },
        datalabels: {
          color: text,
          font: { weight: '900', size: 10 },
          anchor: 'center',
          align: 'center',
          clamp: true
        }
      },
      scales: {
        x: {
          ticks: { color: muted, font: {weight: '900', size: 10 } },
          grid: { color: grid }
        },
        y: {
          ticks: { color: muted, font: {weight: '900', size: 10 } },
          grid: { color: grid }
        }
      }
    }
  }

  function buildTrafficBar(canvas, labels, bytesArr, anomalyLabelSet){
    const unit = state.unit;
    const data = bytesArr.map(b => bytesTo(unit, b));
    const opts = baseChartOptions();
    opts.plugins.datalabels.formatter = (v)=> (v === 0 ? '' : fmtNum(v, unit === "MB" ? 1 : 2));
    const normal = cssVar('--bar');
    const bad = cssVar('--bad_bar');

    return new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: (ctx)=>{
            const idx = ctx.dataIndex ?? 0;
            const lab = labels[idx];
            return anomalyLabelSet.has(lab) ? bad : normal;
          },
          borderRadius: 8,
          maxBarThickness: 26
        }]
      },
      options: opts
    });
  }

  function buildConnsBar(canvas, labels, countsArr){
    const opts = baseChartOptions();
    opts.plugins.datalabels.formatter = (v)=> (v === 0 ? '' : String(Math.round(v)));
    return new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: countsArr,
          backgroundColor: cssVar('--bar2'),
          borderRadius: 8,
          maxBarThickness: 26
        }]
      },
      options: opts
    });
  }

  function buildLine(canvas, labels, values, isTraffic=false){
    const opts = baseChartOptions();
    opts.plugins.datalabels.align = 'top';
    opts.plugins.datalabels.anchor = 'end';
    opts.plugins.datalabels.formatter = (v)=>{
      if (!v) return '';
      if (isTraffic) return fmtNum(v, state.unit === "MB" ? 1 : 2);
      return String(Math.round(v));
    };

    return new Chart(canvas, {
      type: 'line',
      data: { labels, datasets: [{
        data: values,
        fill: true,
        backgroundColor: cssVar('--fill'),
        borderColor: cssVar('--stroke'),
        pointRadius: 2,
        pointHoverRadius: 3,
        tension: .30
      }]},
      options: opts
    });
  }

  function enableSort(table, rows, mode){
    table.querySelector('thead').addEventListener('click', (e)=>{
      const th = e.target.closest('th');
      if (!th) return;
      const key = th.dataset.key;
      if (!key) return;

      const dir = (table.dataset.sort === key && table.dataset.dir === 'desc') ? 'asc' : 'desc';
      table.dataset.sort = key;
      table.dataset.dir = dir;

      let sorted = [...rows];
      sorted.sort((a,b)=>{
        let av, bv;
        if (mode === 'traffic'){
          av = (key === 'domain') ? a.domain : a.bytes;
          bv = (key === 'domain') ? b.domain : b.bytes;
        } else {
          av = (key === 'domain') ? a.domain : a.count;
          bv = (key === 'domain') ? b.domain : b.count;
        }
        if (typeof av === 'string'){
          const res = av.localeCompare(bv);
          return dir === 'asc' ? res : -res;
        }
        const res = av - bv;
        return dir === 'asc' ? res : -res;
      });

      const tbody = table.querySelector('tbody');
      clearNode(tbody);

      if (mode === 'traffic'){
        sorted.forEach(r=>{
          const v = bytesTo(state.unit, r.bytes);
          const d = state.unit === "MB" ? 1 : 2;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td title="${escapeHtml(r.domain)}">${escapeHtml(shorten(r.domain, 40))}</td>
            <td class="right">${fmtNum(v, d)}<div class="tiny">${fmtNum(r.pct, 1)}%</div></td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        sorted.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td title="${escapeHtml(r.domain)}">${escapeHtml(shorten(r.domain, 40))}</td>
            <td class="right">${r.count}<div class="tiny">${fmtNum(r.pct, 1)}%</div></td>
          `;
          tbody.appendChild(tr);
        });
      }
    });
  }

  function buildTableTraffic(rows){
    const table = document.createElement('table');
    table.dataset.sort = 'bytes';
    table.dataset.dir = 'desc';
    table.innerHTML = `
      <thead><tr>
        <th data-key="domain">Domain</th>
        <th data-key="bytes" class="right">Value</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    rows.forEach(r=>{
      const v = bytesTo(state.unit, r.bytes);
      const d = state.unit === "MB" ? 1 : 2;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td title="${escapeHtml(r.domain)}">${escapeHtml(shorten(r.domain, 40))}</td>
        <td class="right">${fmtNum(v, d)}<div class="tiny">${fmtNum(r.pct, 1)}%</div></td>
      `;
      tbody.appendChild(tr);
    });
    enableSort(table, rows, 'traffic');
    return table;
  }

  function buildTableConns(rows){
    const table = document.createElement('table');
    table.dataset.sort = 'count';
    table.dataset.dir = 'desc';
    table.innerHTML = `
      <thead><tr>
        <th data-key="domain">Domain</th>
        <th data-key="count" class="right">Count</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td title="${escapeHtml(r.domain)}">${escapeHtml(shorten(r.domain, 40))}</td>
        <td class="right">${r.count}<div class="tiny">${fmtNum(r.pct, 1)}%</div></td>
      `;
      tbody.appendChild(tr);
    });
    enableSort(table, rows, 'conns');
    return table;
  }

  function userSubtitle(uobj){
    const tot = uobj.totals || {};
    const t = tot.traffic_7d_bytes || 0;
    const c = tot.conns_7d || 0;
    return `7д: ${formatTraffic(state.unit, t)} • conns: ${c}`;
  }

  function layoutCards(n){
    const panel = document.getElementById('cardsPanel');
    let cols = 5, rows = 2;
    if (n <= 1){ cols = 1; rows = 1; }
    else if (n <= 2){ cols = 2; rows = 1; }
    else if (n <= 4){ cols = 2; rows = 2; }
    else if (n <= 6){ cols = 3; rows = 2; }
    else if (n <= 8){ cols = 4; rows = 2; }
    else { cols = 5; rows = 2; }
    panel.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    panel.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  }

  function syncCardsVisibility(){
    const users = state.data?.users || [];
    const selectedOrdered = users.filter(u => state.selectedUsers.has(u));
    const visibleArr = selectedOrdered.slice(0, 10);
    const visible = new Set(visibleArr);

    if (selectedOrdered.length > 10) showToast('Выбрано >10: показываю первые 10');
    layoutCards(visibleArr.length || 0);

    document.querySelectorAll('.user-card').forEach(card=>{
      const u = card.dataset.user;
      card.style.display = visible.has(u) ? 'grid' : 'none';
    });
  }

  function createToggle(label, onClick){
    const b = document.createElement('div');
    b.className = 'toggle';
    b.textContent = label;
    b.addEventListener('click', onClick);
    return b;
  }

  function syncToggles(){
    const users = state.data?.users || [];
    document.querySelectorAll('.toggle').forEach(el=>{
      const u = el.dataset.user;
      if (u === '__ALL__'){
        el.classList.toggle('on', state.selectedUsers.size === users.length && users.length > 0);
        return;
      }
      el.classList.toggle('on', state.selectedUsers.has(u));
    });
  }

  function displayFor(email){
    return state.aliases?.[email] || email;
  }

  function buildUserFilter(users){
    const wrap = document.getElementById('userFilter');
    clearNode(wrap);

    state.selectedUsers = loadSelected(users);

    const allBtn = createToggle('Все', ()=>{
      const allOn = state.selectedUsers.size !== users.length;
      state.selectedUsers = new Set(allOn ? users : []);
      saveSelected();
      syncToggles();
      syncCardsVisibility();
    });
    allBtn.dataset.user = '__ALL__';
    wrap.appendChild(allBtn);

    users.forEach(u=>{
      const btn = createToggle(displayFor(u), ()=>{
        if (state.selectedUsers.has(u)) state.selectedUsers.delete(u);
        else state.selectedUsers.add(u);
        saveSelected();
        syncToggles();
        syncCardsVisibility();
      });
      btn.dataset.user = u;
      wrap.appendChild(btn);
    });

    syncToggles();
    syncCardsVisibility();
  }

  function buildUserCards(payload){
    const panel = document.getElementById('cardsPanel');
    clearNode(panel);

    state.charts.forEach(ch => ch.destroy());
    state.charts.clear();

    const rawDays = payload.meta.days || [];
    const labels = rawDays.map(fmtDayLabel);

    payload.users.forEach(u=>{
      const uobj = payload.per_user[u] || {};
      const anomalyDaysRaw = (uobj.totals?.anomaly_days || []);
      const anomalyLabelSet = new Set(anomalyDaysRaw.map(fmtDayLabel));

      const card = document.createElement('div');
      card.className = 'user-card';
      card.dataset.user = u;

      const head = document.createElement('div');
      head.className = 'card-head';
      head.innerHTML = `
        <div class="u-title">
          <div class="u-name">${escapeHtml(displayFor(u))}</div>
          <div class="u-sub">${escapeHtml(userSubtitle(uobj))}</div>
        </div>
        <div>${anomalyDaysRaw.length ? `<span class="badge bad">аномалий: ${anomalyDaysRaw.length}</span>` : `<span class="badge">ok</span>`}</div>
      `;
      card.appendChild(head);

      const body = document.createElement('div');
      body.className = 'card-body';

      const blk1 = document.createElement('div');
      blk1.className = 'blk';
      blk1.innerHTML = `<div class="blk-title">Трафик (7д)</div>`;
      const c1 = document.createElement('canvas');
      blk1.appendChild(c1);

      const blk2 = document.createElement('div');
      blk2.className = 'blk';
      blk2.innerHTML = `<div class="blk-title">Подключения (7д)</div>`;
      const c2 = document.createElement('canvas');
      blk2.appendChild(c2);

      const blk3 = document.createElement('div');
      blk3.className = 'blk';
      blk3.innerHTML = `<div class="blk-title">ТОП-10 домены • трафик</div>`;

      const blk4 = document.createElement('div');
      blk4.className = 'blk';
      blk4.innerHTML = `<div class="blk-title">ТОП-10 домены • conns</div>`;

      body.appendChild(blk1);
      body.appendChild(blk2);
      body.appendChild(blk3);
      body.appendChild(blk4);
      card.appendChild(body);
      panel.appendChild(card);

      const tByDay = uobj.traffic_by_day_bytes || {};
      const cByDay = uobj.conns_by_day || {};
      const trafficArr = rawDays.map(d => tByDay[d] || 0);
      const connsArr = rawDays.map(d => cByDay[d] || 0);

      if (!trafficArr.some(v => v > 0)){
        blk1.innerHTML = `<div class="blk-title">Трафик (7д)</div><div class="placeholder">Нет данных за 7 дней</div>`;
      } else {
        state.charts.set(`u:${u}:t`, buildTrafficBar(c1, labels, trafficArr, anomalyLabelSet));
      }

      if (!connsArr.some(v => v > 0)){
        blk2.innerHTML = `<div class="blk-title">Подключения (7д)</div><div class="placeholder">Нет данных за 7 дней</div>`;
      } else {
        state.charts.set(`u:${u}:c`, buildConnsBar(c2, labels, connsArr));
      }

      const tRows = (uobj.top_domains_traffic || []).slice(0, 10);
      const cRows = (uobj.top_domains_conns || []).slice(0, 10);

      if (!tRows.length){
        blk3.innerHTML = `<div class="blk-title">ТОП-10 домены • трафик</div><div class="placeholder">Нет данных</div>`;
      } else {
        blk3.appendChild(buildTableTraffic(tRows));
      }

      if (!cRows.length){
        blk4.innerHTML = `<div class="blk-title">ТОП-10 домены • conns</div><div class="placeholder">Нет данных</div>`;
      } else {
        blk4.appendChild(buildTableConns(cRows));
      }
    });

    syncToggles();
    syncCardsVisibility();
  }

  function buildBottom(payload){
    const grid = document.getElementById('bottomGrid');
    grid.innerHTML = '';

    const rawDays = payload.meta.days || [];
    const labels = rawDays.map(fmtDayLabel);

    const dailyTrafficBytes = payload.global.daily_traffic_bytes || {};
    const dailyConns = payload.global.daily_conns || {};

    const dailyTraffic = rawDays.map(d => bytesTo(state.unit, dailyTrafficBytes[d] || 0));
    const dailyConnArr = rawDays.map(d => dailyConns[d] || 0);

    const cumTrafficBytes = payload.global.cumulative_traffic_bytes || [];
    const cumConns = payload.global.cumulative_conns || [];
    const cumTraffic = cumTrafficBytes.map(b => bytesTo(state.unit, b || 0));

    const cards = [
      {title:`Кумулятивный трафик (${state.unit})`, key:'cum_t', values:cumTraffic, isTraffic:true},
      {title:'Кумулятивные подключения', key:'cum_c', values:cumConns, isTraffic:false},
      {title:`Ежедневный трафик (${state.unit})`, key:'day_t', values:dailyTraffic, isTraffic:true},
      {title:'Ежедневные подключения', key:'day_c', values:dailyConnArr, isTraffic:false}
    ];

    cards.forEach((c)=>{
      const bc = document.createElement('div');
      bc.className = 'bcard';
      bc.innerHTML = `<div class="btitle">${c.title}</div>`;
      const canvas = document.createElement('canvas');
      bc.appendChild(canvas);
      grid.appendChild(bc);

      const any = c.values.some(v => v > 0);
      if (!any){
        bc.innerHTML = `<div class="btitle">${c.title}</div><div class="placeholder">Нет данных за 7 дней</div>`;
        return;
      }
      const ch = buildLine(canvas, labels, c.values, c.isTraffic);
      state.charts.set(`bottom:${c.key}`, ch);
    });
  }

  function updateRangeText(payload){
    const raw = payload.meta.days || [];
    const el = document.getElementById('range');
    if (!raw.length){ el.textContent = 'нет данных'; return; }
    const from = fmtDayLabel(raw[0]);
    const to = fmtDayLabel(raw[raw.length-1]);
    const year = String(raw[raw.length-1]).slice(0,4);
    el.textContent = `${from} → ${to} • ${year}`;
  }

  function updateStatus(ok, msg){
    const chip = document.getElementById('statusChip');
    chip.textContent = msg;
    chip.style.borderColor = ok ? cssVar('--line') : cssVar('--bad');
    chip.style.color = ok ? cssVar('--muted') : cssVar('--text');
  }

  function applyTheme(theme){
    state.theme = theme;
    localStorage.setItem(LS_THEME, theme);
    document.body.setAttribute('data-theme', theme);
    document.querySelectorAll('#themeSeg button').forEach(x=>x.classList.toggle('active', x.dataset.theme === theme));
    // пересобрать графики под новые цвета
    if (state.data){
      buildUserCards(state.data);
      buildBottom(state.data);
    }
  }

  document.getElementById('themeSeg').addEventListener('click', (e)=>{
    const b = e.target.closest('button');
    if (!b) return;
    const theme = b.dataset.theme;
    if (!theme || theme === state.theme) return;
    applyTheme(theme);
    showToast(`Тема: ${theme}`);
  });

  document.getElementById('unitSeg').addEventListener('click', (e)=>{
    const b = e.target.closest('button');
    if (!b) return;
    const unit = b.dataset.unit;
    if (!unit || unit === state.unit) return;

    state.unit = unit;
    localStorage.setItem(LS_UNIT, unit);

    document.querySelectorAll('#unitSeg button').forEach(x=>x.classList.toggle('active', x.dataset.unit === unit));
    if (state.data){
      buildUserCards(state.data);
      buildBottom(state.data);
      showToast(`Единицы: ${unit}`);
    }
  });

  async function loadDashboard(){
    try{
      updateStatus(true, 'loading…');

      const headers = {};
      if (state.etag) headers['If-None-Match'] = state.etag;

      const res = await fetch('/api/dashboard?days=7', {headers});
      if (res.status === 304){ updateStatus(true, 'up-to-date'); return; }
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const etag = res.headers.get('ETag');
      if (etag) state.etag = etag.replaceAll('"','');

      const payload = await res.json();
      state.data = payload;
      state.aliases = payload.aliases || {};

      document.querySelectorAll('#unitSeg button').forEach(x=>x.classList.toggle('active', x.dataset.unit === state.unit));

      updateRangeText(payload);
      buildUserFilter(payload.users || []);
      buildUserCards(payload);
      buildBottom(payload);

      updateStatus(true, 'ok');
    } catch(err){
      console.error(err);
      updateStatus(false, 'error');
      showToast('Ошибка загрузки (см. консоль)');
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', ()=>{
    state.etag = null;
    loadDashboard();
  });

  // ------------------ ADMIN ------------------
  function adminHeaders(){
    const tok = (localStorage.getItem(LS_TOKEN) || '').trim();
    const h = {'Content-Type':'application/json'};
    if (tok) h['X-Admin-Token'] = tok;
    return h;
  }

  function setAdminStatus(s){
    document.getElementById('adminStatus').textContent = s;
  }

  function bytesFmtAdmin(bytes){
    const v = bytesTo(state.unit, bytes || 0);
    const d = state.unit === "MB" ? 1 : 2;
    return `${fmtNum(v, d)} ${state.unit}`;
  }

  async function loadAdmin(){
    try{
      setAdminStatus('loading…');
      const res = await fetch('/api/admin/users', {headers: adminHeaders()});
      const j = await res.json();
      if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);

      document.getElementById('adminTokenHint').style.display = j.token_required ? 'inline-block' : 'none';
      document.getElementById('tokenField').style.display = j.token_required ? 'block' : 'none';

      const tbody = document.querySelector('#adminTable tbody');
      clearNode(tbody);

      (j.users || []).forEach(u=>{
        const st = u.stats || {};
        const top3 = (st.top3_traffic || []).map(x => `${x.domain} (${bytesFmtAdmin(x.bytes)})`).join(' • ');
        const uuidShort = (u.id || '').slice(0,8) ? `${(u.id||'').slice(0,8)}…` : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div style="font-weight:900;">${escapeHtml(u.display || u.email)}</div><div class="mini">${escapeHtml(u.alias||'')}</div></td>
          <td>${escapeHtml(u.email||'')}</td>
          <td class="mini">${escapeHtml(uuidShort)}</td>
          <td>${st.days_used || 0}</td>
          <td>${bytesFmtAdmin(st.total_traffic_bytes || 0)}</td>
          <td>${st.total_conns || 0}</td>
          <td class="mini">${escapeHtml(top3 || '—')}</td>
          <td>
            <button class="kbtn" data-act="link" data-email="${escapeHtml(u.email)}">Link</button>
            <button class="kbtn" data-act="rename" data-email="${escapeHtml(u.email)}">Rename</button>
            <button class="kbtn danger" data-act="del" data-email="${escapeHtml(u.email)}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      setAdminStatus('ok');
    } catch(e){
      console.error(e);
      setAdminStatus('error: ' + e.message);
      showToast('Admin: ошибка (см. консоль)');
    }
  }

  document.getElementById('adminTable').addEventListener('click', async (e)=>{
    const b = e.target.closest('button');
    if (!b) return;
    const act = b.dataset.act;
    const email = b.dataset.email;

    try{
      if (act === 'link'){
        const res = await fetch('/api/admin/user/link?email=' + encodeURIComponent(email), {headers: adminHeaders()});
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
        await navigator.clipboard.writeText(j.link);
        showToast('Ссылка скопирована');
        return;
      }

      if (act === 'rename'){
        const alias = prompt('Новый alias (пусто = убрать):', '');
        if (alias === null) return;
        const res = await fetch('/api/admin/user/rename', {
          method:'POST', headers: adminHeaders(),
          body: JSON.stringify({email, alias})
        });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
        showToast('Переименовано');
        state.etag = null;
        await loadAdmin();
        await loadDashboard();
        return;
      }

      if (act === 'del'){
        if (!confirm(`Удалить ${email}? Это отключит доступ.`)) return;
        const res = await fetch('/api/admin/user/delete', {
          method:'POST', headers: adminHeaders(),
          body: JSON.stringify({email})
        });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
        showToast('Удалено');
        state.etag = null;
        await loadAdmin();
        await loadDashboard();
        return;
      }
    } catch(err){
      console.error(err);
      showToast('Ошибка: ' + err.message);
    }
  });

  document.getElementById('adminBtn').addEventListener('click', async ()=>{
    document.getElementById('adminModal').classList.add('show');
    await loadAdmin();
  });

  document.getElementById('adminClose').addEventListener('click', ()=>{
    document.getElementById('adminModal').classList.remove('show');
  });

  // token input persistence
  const tokenInput = document.getElementById('adminToken');
  tokenInput.value = localStorage.getItem(LS_TOKEN) || '';
  tokenInput.addEventListener('change', ()=>{
    localStorage.setItem(LS_TOKEN, tokenInput.value.trim());
    showToast('Token сохранён');
  });

  let lastAddLink = '';
  document.getElementById('addBtn').addEventListener('click', async ()=>{
    try{
      const email = document.getElementById('addEmail').value.trim();
      const alias = document.getElementById('addAlias').value.trim();
      document.getElementById('addResult').textContent = 'adding…';
      const res = await fetch('/api/admin/user/add', {
        method:'POST', headers: adminHeaders(),
        body: JSON.stringify({email, alias})
      });
      const j = await res.json();
      if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);

      lastAddLink = j.link || '';
      document.getElementById('copyAddLinkBtn').disabled = !lastAddLink;

      document.getElementById('addResult').textContent =
        `email: ${j.email}\n` +
        `uuid: ${j.id}\n` +
        `host: ${j.host}:${j.port}\n` +
        `pbk: ${j.pbk || '(missing)'}\n` +
        `sni: ${j.sni || '(missing)'}\n` +
        `sid: ${j.sid || '(missing)'}\n` +
        `link: ${j.link}\n` +
        `xray restart ok: ${j.xray_restart?.ok}`;

      showToast('Пользователь добавлен');
      state.etag = null;
      await loadAdmin();
      await loadDashboard();
    } catch(err){
      console.error(err);
      document.getElementById('addResult').textContent = 'error: ' + err.message;
      showToast('Ошибка добавления');
    }
  });

  document.getElementById('copyAddLinkBtn').addEventListener('click', async ()=>{
    if (!lastAddLink) return;
    await navigator.clipboard.writeText(lastAddLink);
    showToast('Ссылка скопирована');
  });

  // init theme
  applyTheme(state.theme);

  loadDashboard();
  setInterval(loadDashboard, 60_000);
</script>
</body>
</html>
