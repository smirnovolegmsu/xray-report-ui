<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Xray Admin Panel</title>
<!-- amCharts 5 - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–ª—è –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è) -->
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Dark.js"></script>
<style>
:root {
  --bg: #0d1117;
  --panel: #161b22;
  --panel2: #21262d;
  --text: #e6edf3;
  --muted: #8b949e;
  --accent: #58a6ff;
  --accent-light: rgba(88, 166, 255, 0.3);
  --accent-gradient: linear-gradient(135deg, #58a6ff 0%, #3d8bfd 100%);
  --ok: #3fb950;
  --ok-light: rgba(63, 185, 80, 0.2);
  --warn: #d29922;
  --bad: #f85149;
  --bad-light: rgba(248, 81, 73, 0.2);
  --line: #30363d;
  --grid: rgba(48, 54, 61, 0.5);
  --radius: 12px;
  --shadow: 0 8px 24px rgba(0,0,0,.4);
  --bar-normal: rgba(88, 166, 255, 0.6);
  --bar-anomaly: rgba(248, 81, 73, 0.6);
  --bar-border: rgba(88, 166, 255, 0.9);
}
[data-theme="light"] {
  --bg: #f6f8fa;
  --panel: #ffffff;
  --panel2: #f6f8fa;
  --text: #24292f;
  --muted: #57606a;
  --accent: #0969da;
  --accent-light: rgba(9, 105, 218, 0.15);
  --accent-gradient: linear-gradient(135deg, #0969da 0%, #0550ae 100%);
  --ok: #1a7f37;
  --ok-light: rgba(26, 127, 55, 0.15);
  --warn: #9a6700;
  --bad: #cf222e;
  --bad-light: rgba(207, 34, 46, 0.15);
  --line: #d0d7de;
  --grid: rgba(208, 215, 222, 0.5);
  --shadow: 0 8px 24px rgba(0,0,0,.1);
  --bar-normal: rgba(9, 105, 218, 0.4);
  --bar-anomaly: rgba(207, 34, 46, 0.4);
  --bar-border: rgba(9, 105, 218, 0.8);
}
* { box-sizing: border-box; }
body { 
  margin: 0; 
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
  background: var(--bg); 
  color: var(--text);
  line-height: 1.5;
  overflow: hidden; /* –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É body */
  height: 100vh;
}

/* Header - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –¥–ª—è 2500x1300 */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--panel);
  border-bottom: 1px solid var(--line);
  padding: 6px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  min-height: 55px;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}
.logo {
  font-weight: 700;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.logo svg { width: 24px; height: 24px; }
.status-badges {
  display: flex;
  gap: 8px;
}
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 20px;
  font-size: 12px;
  color: var(--muted);
}
.badge .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--muted);
}
.badge .dot.ok { background: var(--ok); }
.badge .dot.bad { background: var(--bad); }

/* Compact status badges */
.status-badges-compact {
  display: flex;
  gap: 6px;
  align-items: center;
}
.badge-compact {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 6px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 12px;
  font-size: 10px;
  color: var(--muted);
  line-height: 1.2;
}
.badge-compact .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--muted);
  flex-shrink: 0;
}
.badge-compact .dot.ok { background: var(--ok); }
.badge-compact .dot.bad { background: var(--bad); }
.header-nav {
  display: flex;
  align-items: center;
  padding: 0 16px;
  border-left: 1px solid var(--line);
  border-right: 1px solid var(--line);
  margin: 0 12px;
}
.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}
.theme-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 20px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text);
}
.theme-toggle:hover { border-color: var(--accent); }
.lang-toggle {
  padding: 6px 12px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 20px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text);
}
.lang-toggle:hover { border-color: var(--accent); }

/* Layout - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è 2500x1300 */
.container {
  max-width: 2500px;
  margin: 0 auto;
  padding: 12px;
  height: calc(100vh - 65px); /* Header ~55px + padding */
  overflow: hidden; /* –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É - –≤—Å—ë –¥–æ–ª–∂–Ω–æ –ø–æ–º–µ—â–∞—Ç—å—Å—è */
}
/* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.container::-webkit-scrollbar {
  width: 8px;
}
.container::-webkit-scrollbar-track {
  background: var(--panel2);
  border-radius: 4px;
}
.container::-webkit-scrollbar-thumb {
  background: var(--line);
  border-radius: 4px;
}
.container::-webkit-scrollbar-thumb:hover {
  background: var(--muted);
}
.tabs {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}
.tab {
  padding: 6px 14px;
  background: transparent;
  border: 1px solid transparent;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
  transition: all .15s;
  white-space: nowrap;
}
.tab:hover { 
  background: var(--panel2);
  color: var(--text); 
}
.tab.active { 
  background: var(--accent); 
  border-color: var(--accent); 
  color: #fff; 
  font-weight: 600;
}
.card {
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 8px;
  margin-bottom: 8px;
  box-shadow: var(--shadow);
  min-width: 0;
  max-width: 100%;
}
.card-title {
  font-size: 14px;
  font-weight: 600;
  margin: 0 0 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.card-desc {
  font-size: 13px;
  color: var(--muted);
  margin: -12px 0 16px;
  padding: 12px;
  background: var(--panel2);
  border-radius: 8px;
  border-left: 3px solid var(--accent);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text);
  transition: all .15s;
}
.btn:hover { border-color: var(--accent); }
.btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
.btn.primary:hover { opacity: .9; }
.btn.danger { background: var(--bad); border-color: var(--bad); color: #fff; }
.btn.danger:hover { opacity: .9; }
.btn.ok { background: var(--ok); border-color: var(--ok); color: #fff; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }

/* Tables */
.table-wrap { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
#usersTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
#usersTable th,
#usersTable td {
  padding: 12px 8px;
  text-align: left;
  border-bottom: 1px solid var(--line);
  vertical-align: middle;
}
#usersTable th {
  background: var(--panel2);
  font-weight: 600;
  font-size: 12px;
  color: var(--muted);
  position: sticky;
  top: 0;
  z-index: 10;
}
#usersTable td {
  font-size: 13px;
}
#usersTable tr:hover td {
  background: var(--panel2);
}
#usersTable .mono {
  font-family: ui-monospace, Menlo, Consolas, monospace;
  font-size: 11px;
}
th, td {
  padding: 6px;
  text-align: left;
  border-bottom: 1px solid var(--line);
  font-size: 12px;
}
/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
.users-grid .table th,
.users-grid .table td {
  padding: 6px 8px;
  font-size: 11px;
}
th { 
  font-weight: 600; 
  color: var(--muted); 
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.users-grid .table th {
  font-size: 10px;
  padding: 6px 8px;
}
tr:hover td { background: var(--panel2); }

/* KPI Cards */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}
/* Segmented controls */
.seg {
  display: inline-flex;
  border: 1px solid var(--line);
  background: var(--panel2);
  border-radius: 8px;
  overflow: hidden;
}
.seg button {
  border: 0;
  background: transparent;
  color: var(--muted);
  padding: 6px 10px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 500;
  transition: all .15s;
  white-space: nowrap;
}
.seg button.active {
  color: #fff;
  background: var(--accent);
  font-weight: 600;
}
.seg button:hover:not(.active) {
  background: var(--panel);
  color: var(--text);
}

/* Nav pills */
.nav-pills {
  display: flex;
  gap: 4px;
  align-items: center;
}
.nav-pill {
  padding: 6px 12px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 500;
  color: var(--muted);
  transition: all .15s;
  white-space: nowrap;
}
.nav-pill:hover {
  border-color: var(--accent);
  color: var(--text);
  background: var(--panel);
}
.nav-pill.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
  font-weight: 600;
}
.nav-pill-warn {
  border-color: var(--bad);
}
.nav-pill-warn:hover {
  border-color: var(--bad);
  background: color-mix(in srgb, var(--bad) 10%, transparent);
  color: var(--bad);
}
.nav-pill-warn.active {
  background: var(--bad);
  border-color: var(--bad);
  color: #fff;
}

/* KPI Row (6 cards) - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  margin-bottom: 6px;
}
@media (max-width: 1600px) {
  .kpi-row { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 1000px) {
  .kpi-row { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 600px) {
  .kpi-row { grid-template-columns: 1fr; }
}

.kpi-card {
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 6px 8px;
  position: relative;
}
.kpi-card .kpi-title {
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 4px;
  font-weight: 500;
  line-height: 1.3;
}
.kpi-card .kpi-subtitle {
  font-size: 10px;
  color: var(--muted2);
  margin-bottom: 4px;
}
.kpi-card .kpi-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 2px;
  line-height: 1.2;
}
.kpi-card .kpi-subline {
  font-size: 10px;
  color: var(--muted);
  margin-top: 2px;
  line-height: 1.3;
}
.kpi-card .kpi-list {
  margin-top: 4px;
  font-size: 11px;
  line-height: 1.4;
}
.kpi-card .kpi-list-item {
  padding: 2px 0;
  color: var(--text);
  display: flex;
  justify-content: space-between;
}
.kpi-card .kpi-bubble {
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 10px;
  padding: 3px 6px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: var(--panel2);
  color: var(--muted);
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}
.kpi-card .kpi-bubble.up {
  color: var(--ok);
  border-color: var(--ok);
  background: color-mix(in srgb, var(--ok) 15%, transparent);
}
.kpi-card .kpi-bubble.down {
  color: var(--bad);
  border-color: var(--bad);
  background: color-mix(in srgb, var(--bad) 15%, transparent);
}
.kpi-card .kpi-bubble.na {
  color: var(--muted2);
}

/* Card header/body */
.card-hd {
  padding: 8px;
  border-bottom: 1px solid var(--line);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
}
/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
.users-grid .card-hd {
  padding: 8px;
}
.users-grid .card-hd h3 {
  font-size: 14px;
  margin: 0;
}
.users-grid .card-hd .meta {
  font-size: 11px;
}
.card-hd h2 {
  font-size: 16px;
  font-weight: 700;
  margin: 0 0 4px;
}
.card-hd .meta {
  font-size: 11px;
  color: var(--muted);
}
.card-bd {
  padding: 8px;
}
/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
.users-grid .card-bd {
  padding: 8px;
}

/* Trends grid - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
.trends-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 8px;
}
@media (max-width: 1000px) {
  .trends-grid { grid-template-columns: 1fr; }
}

/* –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π layout: –¢—Ä–µ–Ω–¥—ã + –¢–æ–ø –¥–æ–º–µ–Ω—ã */
.trends-domains-combined {
  display: grid;
  grid-template-columns: 750px 1fr 600px;
  gap: 16px;
  align-items: stretch;
}
@media (max-width: 1900px) {
  .trends-domains-combined {
    grid-template-columns: 750px 1fr;
  }
  .users-charts-column {
    display: none;
  }
}
@media (max-width: 1400px) {
  .trends-domains-combined {
    grid-template-columns: 1fr;
  }
}

/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢—Ä–µ–Ω–¥—ã (–≥—Ä–∞—Ñ–∏–∫–∏ –¥—Ä—É–≥ –ø–æ–¥ –¥—Ä—É–≥–æ–º) */
.trends-column {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 750px;
  flex-shrink: 0;
  align-items: stretch;
  max-height: 380px;
}

/* –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞: –¢–æ–ø –¥–æ–º–µ–Ω—ã */
.domains-column {
  min-width: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ */
}

/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
.users-charts-column {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 600px;
  flex-shrink: 0;
  align-items: stretch;
}
.users-charts-column .chartbox {
  height: 200px;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  padding: 4px;
}
.users-charts-column .chartbox .kpi-title {
  font-size: 13px;
  margin: 0 0 4px 0;
  padding: 0;
  flex-shrink: 0;
  height: auto;
}
.users-charts-column .chartbox > div[id^="chUsers"] {
  flex: 1;
  min-height: 0;
  width: 100%;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤—ã—Å–æ—Ç—ã */
.table-container {
  max-height: 280px;
  overflow-y: auto;
  overflow-x: hidden;
}
.table-container::-webkit-scrollbar {
  width: 6px;
}
.table-container::-webkit-scrollbar-track {
  background: var(--panel2);
  border-radius: 3px;
}
.table-container::-webkit-scrollbar-thumb {
  background: var(--line);
  border-radius: 3px;
}
.table-container::-webkit-scrollbar-thumb:hover {
  background: var(--muted);
}

/* Domains grid - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
.domains-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
.users-grid .domains-grid {
  gap: 8px;
}
.users-grid .domains-grid .table {
  font-size: 11px;
}
.users-grid .domains-grid th,
.users-grid .domains-grid td {
  padding: 6px 8px;
}
@media (max-width: 1000px) {
  .domains-grid { grid-template-columns: 1fr; }
}

/* Users charts grid - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
.users-charts-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 6px;
}
@media (max-width: 1000px) {
  .users-charts-grid { grid-template-columns: 1fr; }
}

/* Users grid (cards) - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è 2500x1300 */
.users-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  max-height: 350px;
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 4px;
}
/* –°–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è users-grid */
.users-grid::-webkit-scrollbar {
  width: 6px;
}
.users-grid::-webkit-scrollbar-track {
  background: var(--panel2);
  border-radius: 3px;
}
.users-grid::-webkit-scrollbar-thumb {
  background: var(--line);
  border-radius: 3px;
}
.users-grid::-webkit-scrollbar-thumb:hover {
  background: var(--muted);
}
@media (max-width: 2000px) {
  .users-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 1200px) {
  .users-grid { grid-template-columns: 1fr; }
}

/* Filters (chips) - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
.filters {
  padding: 6px 8px;
  border-bottom: 1px solid var(--line);
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.filters-inline {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  margin-left: auto;
  flex: 1;
  min-width: 0;
}
.users-controls-row {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  width: 100%;
}
.filter-chip {
  padding: 6px 12px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 16px;
  cursor: pointer;
  font-size: 12px;
  color: var(--muted);
  transition: all .15s;
}
.filter-chip:hover {
  border-color: var(--accent);
  color: var(--text);
}
.filter-chip.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

/* Chart boxes - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è 2500x1300 */
.chartbox {
  position: relative;
  height: 180px;
  min-height: 180px;
}
.chartbox.small { height: 185px; min-height: 185px; }
.chartbox.tiny { height: 140px; min-height: 140px; }
.chartbox > div {
  width: 100%;
  height: 100%;
}

/* Online now - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
.online-now {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 12px;
}
@media (max-width: 800px) {
  .online-now { grid-template-columns: 1fr; }
}

/* Row (flex) */
.row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

/* Notice */
.notice {
  padding: 12px 20px;
  background: var(--panel2);
  border-top: 1px solid var(--line);
  font-size: 12px;
  color: var(--muted);
}

/* Chart containers - amCharts 5 */
.chart-container {
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 20px;
  position: relative;
  height: 300px;
}

/* Forms */
input, select, textarea {
  padding: 10px 12px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 8px;
  color: var(--text);
  font-size: 14px;
  outline: none;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--accent);
}
textarea {
  width: 100%;
  min-height: 150px;
  font-family: monospace;
  font-size: 12px;
}
.form-row {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
label {
  font-size: 13px;
  color: var(--muted);
}

/* Help tooltip */
.help {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 50%;
  font-size: 11px;
  color: var(--muted);
  cursor: help;
  position: relative;
}
.help:hover::after {
  content: attr(data-tip);
  position: absolute;
  left: 50%;
  bottom: 100%;
  transform: translateX(-50%);
  background: var(--text);
  color: var(--bg);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  white-space: pre-wrap;
  max-width: 300px;
  z-index: 1000;
  margin-bottom: 8px;
  box-shadow: var(--shadow);
}

  /* Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 24px;
  max-width: 500px;
  width: 90%;
  box-shadow: var(--shadow);
}
.modal h3 { margin: 0 0 16px; }
.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 20px;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  padding: 16px 20px;
  box-shadow: var(--shadow);
  display: none;
  z-index: 300;
  max-width: 400px;
}
.toast.show { display: block; }
.toast-title { font-weight: 600; margin-bottom: 4px; }
.toast-text { font-size: 13px; color: var(--muted); }

/* Panes */
.pane { 
  display: none; 
}
.pane.active { 
  display: block !important; 
}

/* Progress bar */
.progress-bar {
  width: 100%;
  height: 20px;
  background: var(--panel2);
  border: 1px solid var(--line);
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--ok));
  transition: width .3s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  color: #fff;
  font-weight: 600;
}

/* Utils */
.mono { font-family: monospace; }
.muted { color: var(--muted); }
.text-ok { color: var(--ok); }
.text-bad { color: var(--bad); }
.text-warn { color: var(--warn); }
.mb-0 { margin-bottom: 0; }
.mt-16 { margin-top: 16px; }
.flex { display: flex; }
.gap-8 { gap: 8px; }
.items-center { align-items: center; }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      <span>Xray Usage</span>
    </div>
    <div class="status-badges-compact">
      <div class="badge-compact">
        <span class="dot" id="dotUI"></span>
        <span id="statusUI">‚Äî</span>
      </div>
      <div class="badge-compact">
        <span class="dot" id="dotXray"></span>
        <span id="statusXray">‚Äî</span>
      </div>
      <div class="badge-compact" id="badgeLive">
        <span class="dot"></span>
        <span id="liveStatus">‚Äî</span>
      </div>
    </div>
  </div>
  
  <!-- Main Navigation Tabs -->
  <div class="header-nav">
    <div class="tabs">
      <div class="tab active" data-tab="dashboard">üìä <span data-i18n="dashboard">–û–±–∑–æ—Ä</span></div>
      <div class="tab" data-tab="users">üë• <span data-i18n="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span></div>
      <div class="tab" data-tab="events">üìã <span data-i18n="events">–°–æ–±—ã—Ç–∏—è</span></div>
      <div class="tab" data-tab="xray">‚öôÔ∏è <span data-i18n="xray">Xray</span></div>
      <div class="tab" data-tab="settings">üîß <span data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
    </div>
  </div>
  
  <div class="header-right">
    <!-- DateSelect -->
    <select id="dateSelect" title="–î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞" style="width:150px;"></select>
    
    <!-- Segmented: Daily/Cumulative -->
    <div class="seg" title="–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–æ–≤">
      <button id="segDaily" class="active">üìà Daily</button>
      <button id="segCum">üìä Cumulative</button>
    </div>
    
    <!-- Segmented: Dark/Light -->
    <div class="seg" title="–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è">
      <button id="segDark" class="active">üåô Dark</button>
      <button id="segLight">‚òÄÔ∏è Light</button>
    </div>
    
    <!-- Segmented: GB/MB -->
    <div class="seg" title="–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è">
      <button id="segGB" class="active">üíæ GB</button>
      <button id="segMB">üì¶ MB</button>
    </div>
    
    <!-- Nav pills: –û–Ω–ª–∞–π–Ω / Status / Restart / Journal -->
    <div class="nav-pills">
      <button class="nav-pill" id="navOnline" data-nav="online">‚ö° –û–Ω–ª–∞–π–Ω</button>
      <button class="nav-pill" id="navStatus" data-nav="status">‚úÖ Status</button>
      <button class="nav-pill nav-pill-warn" id="navRestart" data-nav="restart">üîÑ Restart</button>
      <button class="nav-pill" id="navJournal" data-nav="journal">üìú Journal</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï (–ò—Å—Ç–æ—Ä–∏—è) -->
  <div class="pane active" data-pane="management" id="paneManagement">
    <!-- KPIRow: 6 –∫–∞—Ä—Ç–æ—á–µ–∫ -->
    <div class="kpi-row" id="kpiRow">
      <!-- KPIStatCard: Today traffic -->
      <div class="kpi-card stat-card" id="kpiTodayTraffic">
        <div class="kpi-title">Today traffic (GB)</div>
        <div class="kpi-value" id="kpiTodayTrafficValue">‚Äî</div>
        <div class="kpi-subline">avg7d: <span id="kpiTodayTrafficAvg">‚Äî</span></div>
        <div class="kpi-bubble" id="kpiTodayTrafficBubble"></div>
      </div>
      
      <!-- KPIStatCard: Today conns -->
      <div class="kpi-card stat-card" id="kpiTodayConns">
        <div class="kpi-title">Today conns</div>
        <div class="kpi-value" id="kpiTodayConnsValue">‚Äî</div>
        <div class="kpi-subline">avg7d: <span id="kpiTodayConnsAvg">‚Äî</span></div>
        <div class="kpi-bubble" id="kpiTodayConnsBubble"></div>
      </div>
      
      <!-- KPITotalCard: 7d total traffic -->
      <div class="kpi-card total-card" id="kpiTotal7dTraffic">
        <div class="kpi-title">7d total traffic (GB)</div>
        <div class="kpi-value" id="kpiTotal7dTrafficValue">‚Äî</div>
        <div class="kpi-bubble" id="kpiTotal7dTrafficBubble"></div>
      </div>
      
      <!-- KPITotalCard: 7d total conns -->
      <div class="kpi-card total-card" id="kpiTotal7dConns">
        <div class="kpi-title">7d total conns</div>
        <div class="kpi-value" id="kpiTotal7dConnsValue">‚Äî</div>
        <div class="kpi-bubble" id="kpiTotal7dConnsBubble"></div>
      </div>
      
      <!-- KPITopMiniList: Top domains (7d) ‚Äî traffic (top-3) -->
      <div class="kpi-card top-card" id="kpiTopDomainsTraffic">
        <div class="kpi-title">Top domains (7d) ‚Äî traffic (top-3)</div>
        <div class="kpi-list" id="kpiTopDomainsTrafficList"></div>
        <div class="kpi-bubble" id="kpiTopDomainsTrafficBubble"></div>
      </div>
      
      <!-- KPITopMiniList: Top domains (7d) ‚Äî conns (top-3) -->
      <div class="kpi-card top-card" id="kpiTopDomainsConns">
        <div class="kpi-title">Top domains (7d) ‚Äî conns (top-3)</div>
        <div class="kpi-list" id="kpiTopDomainsConnsList"></div>
        <div class="kpi-bubble" id="kpiTopDomainsConnsBubble"></div>
      </div>
    </div>
    
    <!-- TrendsPanel + TopDomainsPanel: –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="card">
      <div class="card-hd">
        <div>
          <h2>–¢—Ä–µ–Ω–¥—ã (7 –¥–Ω–µ–π) & –¢–æ–ø –¥–æ–º–µ–Ω—ã (7 –¥–Ω–µ–π)</h2>
          <div class="meta">–ü–µ—Ä–µ–∫–ª—é—á–∞–π –≤ —à–∞–ø–∫–µ: Daily / Cumulative (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ) | –¢–æ–ø-7 –ø–æ —Ç—Ä–∞—Ñ–∏–∫—É –∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º</div>
        </div>
      </div>
      <div class="card-bd">
        <div class="trends-domains-combined">
          <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢—Ä–µ–Ω–¥—ã (750px) -->
          <div class="trends-column">
            <div class="chartbox small">
              <div id="chTraffic" style="width:100%;height:100%;"></div>
            </div>
            <div class="chartbox small">
              <div id="chConns" style="width:100%;height:100%;"></div>
            </div>
          </div>
          <!-- –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞: –¢–æ–ø –¥–æ–º–µ–Ω—ã -->
          <div class="domains-column">
            <div class="domains-grid">
              <div>
                <div class="kpi-title">–ü–æ —Ç—Ä–∞—Ñ–∏–∫—É</div>
                <div class="table-container">
                  <table class="table" id="tblTopTraffic">
                    <thead>
                      <tr>
                        <th>Domain</th>
                        <th>GB/MB</th>
                        <th>%</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div>
                <div class="kpi-title">–ü–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º</div>
                <div class="table-container">
                  <table class="table" id="tblTopConns">
                    <thead>
                      <tr>
                        <th>Domain</th>
                        <th>#</th>
                        <th>%</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (600px) -->
          <div class="users-charts-column">
            <div class="chartbox">
              <div class="kpi-title">–ü–æ —Ç—Ä–∞—Ñ–∏–∫—É</div>
              <div id="chUsersTraffic" style="width:100%;height:100%;"></div>
            </div>
            <div class="chartbox">
              <div class="kpi-title">–ü–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º</div>
              <div id="chUsersConns" style="width:100%;height:100%;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- UsersPanel: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="card">
      <div class="card-hd">
        <div>
          <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
          <div class="meta">–§–∏–ª—å—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è. –ï—Å–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ ‚Äî –Ω–µ —É–º–µ—Å—Ç–∏—Ç—Å—è –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ (–∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ).</div>
        </div>
        <div class="users-controls-row">
          <div class="seg" title="–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
            <button id="segCmpTraffic" class="">Traffic</button>
            <button id="segCmpConns" class="active">Conns</button>
          </div>
          <div class="seg" title="–ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö">
            <button id="segMiniTraffic" class="active">Mini: Traffic</button>
            <button id="segMiniConns" class="">Mini: Conns</button>
          </div>
          <div class="filters-inline" id="userFilters"></div>
        </div>
      </div>
      <div class="card-bd">
        <div class="users-grid" id="usersGrid"></div>
      </div>
      <div class="notice" id="usersNotice" style="display:none"></div>
    </div>
  </div>
  
  <!-- –û–ù–õ–ê–ô–ù (near-realtime) -->
  <div class="pane" data-pane="online" id="paneOnline">
    <div class="card">
      <div class="card-hd">
        <div>
          <h2>–û–Ω–ª–∞–π–Ω</h2>
          <div class="meta" id="onlineMeta">–ò—Å—Ç–æ—á–Ω–∏–∫: <span id="onlineSource">‚Äî</span></div>
        </div>
        <div class="row">
          <div class="seg" title="Scope">
            <button id="segScopeGlobal" class="active">Global</button>
            <button id="segScopeUsers">By users</button>
          </div>
          <div class="seg" title="–ú–µ—Ç—Ä–∏–∫–∞">
            <button id="segMetricTraffic" class="">Traffic</button>
            <button id="segMetricConns" class="active">Conns</button>
            <button id="segMetricOnline">Online users</button>
          </div>
          <div class="seg" title="–ü–µ—Ä–∏–æ–¥">
            <button id="segPeriod60m" class="active">60m</button>
            <button id="segPeriod6h">6h</button>
            <button id="segPeriod24h">24h</button>
          </div>
          <div class="seg" title="–ì—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å">
            <button id="segGran1m">1m</button>
            <button id="segGran5m" class="active">5m</button>
            <button id="segGran10m">10m</button>
          </div>
          <button class="btn" id="btnPause">Pause</button>
        </div>
      </div>
      <div class="card-bd">
        <div class="online-now" id="onlineNow">
          <div class="kpi-card">
            <div class="kpi-title">Online users</div>
            <div class="kpi-value" id="onlineUsersValue">‚Äî</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Connections</div>
            <div class="kpi-value" id="onlineConnsValue">‚Äî</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Traffic</div>
            <div class="kpi-value" id="onlineTrafficValue">‚Äî</div>
            <div class="kpi-subline" id="onlineTrafficNote" style="display:none;">Traffic unavailable</div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="chartbox" style="position: relative;">
            <div class="kpi-title" style="position: absolute; top: 4px; left: 4px; right: 4px; z-index: 10; font-size: 13px; margin: 0; padding: 0;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
            <div id="chOnlineConns" style="width:100%;height:100%;"></div>
          </div>
          <div class="chartbox" style="position: relative;">
            <div class="kpi-title" style="position: absolute; top: 4px; left: 4px; right: 4px; z-index: 10; font-size: 13px; margin: 0; padding: 0;">–¢—Ä–∞—Ñ–∏–∫</div>
            <div id="chOnlineTraffic" style="width:100%;height:100%;"></div>
          </div>
        </div>
        <div class="card">
          <h3>Top users (—Å–µ–≥–æ–¥–Ω—è)</h3>
          <table class="table" id="tblOnlineTop">
            <thead>
              <tr>
                <th>User</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–¢—Ä–∞—Ñ–∏–∫</th>
                <th>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- STATUS / RESTART / JOURNAL -->
  <div class="pane" data-pane="status" id="paneStatus">
    <div class="card">
      <h3>System Status</h3>
      <div id="statusContent"></div>
    </div>
  </div>
  
  <div class="pane" data-pane="restart" id="paneRestart">
    <div class="card">
      <h3>Restart Services</h3>
      <div class="btn-group">
        <button class="btn" id="btnRestartUI">Restart UI</button>
        <button class="btn" id="btnRestartXray">Restart Xray</button>
      </div>
    </div>
  </div>
  
  <div class="pane" data-pane="journal" id="paneJournal">
    <div class="card">
      <h3>Journal Logs</h3>
      <select id="journalTarget">
        <option value="ui">UI</option>
        <option value="xray" selected>Xray</option>
      </select>
      <pre id="journalContent" style="max-height:600px;overflow:auto;font-size:12px;"></pre>
    </div>
  </div>

      <!-- USERS -->
  <div class="pane" data-pane="users">
    <div class="card">
      <h3 class="card-title">
        <span data-i18n="usersManagement">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</span>
        <span class="help" data-tip="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Xray config. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å, —É–¥–∞–ª—è—Ç—å –∏ –∫–∏–∫–∞—Ç—å (—Å–º–µ–Ω–∏—Ç—å UUID —á—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Å–µ—Å—Å–∏–∏).">?</span>
      </h3>
      <div class="card-desc" data-i18n="usersDesc">
        –ó–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ Xray. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ, —É–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–ª–∏ "–∫–∏–∫–Ω—É—Ç—å" ‚Äî —Å–º–µ–Ω–∏—Ç—å UUID, —á—Ç–æ–±—ã —Ç–µ–∫—É—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ–±–æ—Ä–≤–∞–ª–∏—Å—å.
        </div>
      
      <div class="btn-group">
        <button class="btn primary" id="btnAddUser">‚ûï <span data-i18n="addUser">–î–æ–±–∞–≤–∏—Ç—å</span></button>
        <button class="btn" id="btnRefreshUsers">üîÑ <span data-i18n="refresh">–û–±–Ω–æ–≤–∏—Ç—å</span></button>
      </div>

      <div class="table-wrap">
        <table id="usersTable">
          <thead>
            <tr>
              <th data-i18n="name">–ò–º—è/Alias</th>
              <th>UUID</th>
              <th>–¢–û–ü-3 –¥–æ–º–µ–Ω–∞</th>
              <th>–î–Ω–µ–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</th>
              <th>–°—É–º–º–∞—Ä–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        </div>
        </div>
      </div>

  <!-- EVENTS -->
  <div class="pane" data-pane="events">
    <div class="card">
      <h3 class="card-title">
        <span data-i18n="eventLog">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</span>
        <span class="help" data-tip="–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –ø–∞–Ω–µ–ª–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ä–µ—Å—Ç–∞—Ä—Ç—ã, –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫.">?</span>
      </h3>
      <div class="card-desc" data-i18n="eventsDesc">
        –ñ—É—Ä–Ω–∞–ª –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –ø–∞–Ω–µ–ª–∏. –ü–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –≤–Ω–æ—Å–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è.
        </div>
      
      <div class="form-row">
        <input type="text" id="eventsFilter" placeholder="–ü–æ–∏—Å–∫..." style="flex:1;max-width:300px;">
        <button class="btn" id="btnRefreshEvents">üîÑ <span data-i18n="refresh">–û–±–Ω–æ–≤–∏—Ç—å</span></button>
      </div>

      <div class="table-wrap">
        <table id="eventsTable">
          <thead>
            <tr>
              <th data-i18n="time">–í—Ä–µ–º—è</th>
              <th data-i18n="type">–¢–∏–ø</th>
              <th data-i18n="action">–î–µ–π—Å—Ç–≤–∏–µ</th>
              <th data-i18n="details">–î–µ—Ç–∞–ª–∏</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        </div>
        </div>
      </div>

  <!-- XRAY -->
  <div class="pane" data-pane="xray">
    <div class="card">
      <h3 class="card-title">
        <span data-i18n="xrayConfig">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Xray</span>
        <span class="help" data-tip="–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ Xray –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ Reality. –ò–∑–º–µ–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥ –Ω–∞–ø—Ä—è–º—É—é –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.">?</span>
      </h3>
      <div class="card-desc" data-i18n="xrayDesc">
        –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ Reality (pbk, sid, sni). –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏".
        </div>
      
      <div class="btn-group">
        <button class="btn" id="btnReloadXray">üîÑ <span data-i18n="reload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span></button>
        <button class="btn danger" id="btnRestartXray">‚ö° <span data-i18n="restartXray">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Xray</span></button>
      </div>

      <div class="mt-16">
        <label><strong>Reality –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong></label>
        <pre id="realityParams" class="mono" style="background:var(--panel2);padding:12px;border-radius:8px;overflow-x:auto;font-size:12px;"></pre>
        </div>
      
      <div class="mt-16">
        <label><strong>–ö–æ–Ω—Ñ–∏–≥ (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ):</strong></label>
        <textarea id="xrayConfig" readonly></textarea>
        </div>
        </div>
      </div>

      <!-- SETTINGS -->
  <div class="pane" data-pane="settings">
    <div class="card">
      <h3 class="card-title">
        <span data-i18n="settingsTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏</span>
        <span class="help" data-tip="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'. –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è server_host —Å—Å—ã–ª–∫–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –Ω–æ–≤—ã–º –∞–¥—Ä–µ—Å–æ–º.">?</span>
      </h3>
      <div class="card-desc" data-i18n="settingsDesc">
        –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫, –ø—É—Ç—å –∫ CSV-–æ—Ç—á—ë—Ç–∞–º –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
        </div>
      
      <div class="form-row">
        <label>
          Server Host
          <span class="help" data-tip="IP-–∞–¥—Ä–µ—Å –∏–ª–∏ –¥–æ–º–µ–Ω –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ VLESS-—Å—Å—ã–ª–æ–∫.">?</span>
        </label>
        <input type="text" id="setServerHost" placeholder="123.45.67.89" style="width:200px;">
        </div>

      <div class="form-row">
        <label>
          Reality PBK (override)
          <span class="help" data-tip="–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á Reality. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏–∑ privateKey.">?</span>
        </label>
        <input type="text" id="setPbk" placeholder="(–∞–≤—Ç–æ)" style="width:300px;">
        </div>

      <div class="form-row">
        <label>
          CSV –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
          <span class="help" data-tip="–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å CSV-–æ—Ç—á—ë—Ç–∞–º–∏ –æ—Ç —Å–±–æ—Ä—â–∏–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.">?</span>
        </label>
        <input type="text" id="setUsageDir" placeholder="/var/log/xray/usage" style="width:300px;">
      </div>

      <div class="btn-group mt-16">
        <button class="btn primary" id="btnSaveSettings">üíæ <span data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span></button>
        <button class="btn" id="btnReloadSettings">üîÑ <span data-i18n="reload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span></button>
        </div>
      </div>

    <div class="card">
      <h3 class="card-title">Collector (—Å–±–æ—Ä—â–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)</h3>
      <div class="card-desc">
        <strong>–ß—Ç–æ —ç—Ç–æ:</strong> –°–±–æ—Ä—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ cron –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç CSV-—Ñ–∞–π–ª—ã —Å —Ç—Ä–∞—Ñ–∏–∫–æ–º –∏–∑ Xray access.log.<br/>
        <strong>–ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å:</strong> –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å (–≤–∫–ª—é—á–µ–Ω/–≤—ã–∫–ª—é—á–µ–Ω), –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤, –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª, –ª–∞–≥ —Å–±–æ—Ä—â–∏–∫–∞.<br/>
        <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ cron (–Ω–µ –∏–∑ –ø–∞–Ω–µ–ª–∏).
      </div>
      <div id="collectorStatus"></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
    <p id="modalText" class="muted"></p>
    <div id="modalInput"></div>
    <div class="modal-actions">
      <button class="btn" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn danger" id="modalConfirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="toast-title" id="toastTitle"></div>
  <div class="toast-text" id="toastText"></div>
</div>

<script>
// ==================== I18N ====================
const i18n = {
  ru: {
    dashboard: '–û–±–∑–æ—Ä',
    users: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
    events: '–°–æ–±—ã—Ç–∏—è',
    xray: 'Xray',
    settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    topUsers: '–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ç—Ä–∞—Ñ–∏–∫—É',
    user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
    traffic: '–¢—Ä–∞—Ñ–∏–∫',
    daysActive: '–î–Ω–µ–π –∞–∫—Ç–∏–≤–µ–Ω',
    usersManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏',
    usersDesc: '–ó–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ Xray. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ, —É–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–ª–∏ "–∫–∏–∫–Ω—É—Ç—å" ‚Äî —Å–º–µ–Ω–∏—Ç—å UUID.',
    addUser: '–î–æ–±–∞–≤–∏—Ç—å',
    refresh: '–û–±–Ω–æ–≤–∏—Ç—å',
    name: '–ò–º—è',
    actions: '–î–µ–π—Å—Ç–≤–∏—è',
    eventLog: '–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π',
    eventsDesc: '–ñ—É—Ä–Ω–∞–ª –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –ø–∞–Ω–µ–ª–∏.',
    time: '–í—Ä–µ–º—è',
    type: '–¢–∏–ø',
    action: '–î–µ–π—Å—Ç–≤–∏–µ',
    details: '–î–µ—Ç–∞–ª–∏',
    xrayConfig: '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Xray',
    xrayDesc: '–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ Reality.',
    reload: '–ó–∞–≥—Ä—É–∑–∏—Ç—å',
    restartXray: '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Xray',
    settingsTitle: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏',
    settingsDesc: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.',
    save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    todayTraffic: '–¢—Ä–∞—Ñ–∏–∫ —Å–µ–≥–æ–¥–Ω—è',
    yesterdayTraffic: '–¢—Ä–∞—Ñ–∏–∫ –≤—á–µ—Ä–∞',
    totalTraffic: '–í—Å–µ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥',
    activeUsers: '–ê–∫—Ç–∏–≤–Ω—ã—Ö —é–∑–µ—Ä–æ–≤',
    collectorLag: '–õ–∞–≥ —Å–±–æ—Ä—â–∏–∫–∞',
    getLink: '–°—Å—ã–ª–∫–∞',
    kick: '–ö–∏–∫–Ω—É—Ç—å',
    delete: '–£–¥–∞–ª–∏—Ç—å',
    confirmDelete: '–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    confirmKick: '–°–º–µ–Ω–∏—Ç—å UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –í—Å–µ —Ç–µ–∫—É—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ–±–æ—Ä–≤—É—Ç—Å—è.',
    userAdded: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω',
    userDeleted: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω',
    userKicked: 'UUID —Å–º–µ–Ω—ë–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–∏–∫–Ω—É—Ç',
    linkCopied: '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞',
    settingsSaved: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã',
    error: '–û—à–∏–±–∫–∞',
  },
  en: {
    dashboard: 'Dashboard',
    users: 'Users',
    events: 'Events',
    xray: 'Xray',
    settings: 'Settings',
    topUsers: 'Top users by traffic',
    user: 'User',
    traffic: 'Traffic',
    daysActive: 'Days active',
    usersManagement: 'Users management',
    usersDesc: 'All users from Xray config. You can add, delete or kick (change UUID to disconnect current sessions).',
    addUser: 'Add',
    refresh: 'Refresh',
    name: 'Name',
    actions: 'Actions',
    eventLog: 'Event log',
    eventsDesc: 'Log of all actions in the panel.',
    time: 'Time',
    type: 'Type',
    action: 'Action',
    details: 'Details',
    xrayConfig: 'Xray Configuration',
    xrayDesc: 'View Xray config and Reality params.',
    reload: 'Reload',
    restartXray: 'Restart Xray',
    settingsTitle: 'Panel Settings',
    settingsDesc: 'Configure server address and other params.',
    save: 'Save',
    todayTraffic: 'Today traffic',
    yesterdayTraffic: 'Yesterday traffic',
    totalTraffic: 'Total for period',
    activeUsers: 'Active users',
    collectorLag: 'Collector lag',
    getLink: 'Link',
    kick: 'Kick',
    delete: 'Delete',
    confirmDelete: 'Are you sure you want to delete user',
    confirmKick: 'Change user UUID? All current connections will be dropped.',
    userAdded: 'User added',
    userDeleted: 'User deleted',
    userKicked: 'UUID changed, user kicked',
    linkCopied: 'Link copied',
    settingsSaved: 'Settings saved',
    error: 'Error',
  }
};

function t(key) {
  return i18n[state.lang]?.[key] || i18n.en[key] || key;
}

function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    el.textContent = t(key);
  });
}

// ==================== UTILS ====================
function $(sel) { return document.querySelector(sel); }
function $$(sel) { return document.querySelectorAll(sel); }

function fmtBytes(n) {
  n = Number(n || 0);
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  let i = 0;
  while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
  return (i === 0 ? n.toFixed(0) : n.toFixed(2)) + ' ' + units[i];
}

function fmtDate(iso) {
  if (!iso) return '‚Äî';
  try {
    const d = new Date(iso);
    return d.toLocaleString(state.lang === 'ru' ? 'ru-RU' : 'en-US', {
      day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
    });
  } catch { return iso; }
}

function showToast(title, text) {
  $('#toastTitle').textContent = title;
  $('#toastText').textContent = text || '';
  $('#toast').classList.add('show');
  setTimeout(() => $('#toast').classList.remove('show'), 3000);
}

async function api(path, opts = {}) {
  try {
    const res = await fetch(path, {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    const data = await res.json();
    // If response has 'ok' field, check it
    if (data.hasOwnProperty('ok') && !data.ok && data.error) {
      throw new Error(data.error);
    }
    return data;
  } catch (e) {
    console.error('API error:', path, e);
    const msg = e.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞';
    if ($('#toast')) {
      showToast('‚ùå', msg);
    }
    throw e;
  }
}

function modal(title, text, inputHtml = '', cancelText = '–û—Ç–º–µ–Ω–∞', confirmText = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', confirmDanger = false) {
  return new Promise(resolve => {
    $('#modalTitle').textContent = title;
    $('#modalText').innerHTML = text; // Use innerHTML to support HTML
    $('#modalInput').innerHTML = inputHtml;
    
    // Update button texts
    const cancelBtn = $('#modalCancel');
    const confirmBtn = $('#modalConfirm');
    if (cancelBtn) cancelBtn.textContent = cancelText;
    if (confirmBtn) {
      confirmBtn.textContent = confirmText;
      if (confirmDanger) {
        confirmBtn.classList.add('danger');
      } else {
        confirmBtn.classList.remove('danger');
      }
    }
    
    $('#modalOverlay').classList.add('show');
    
    const cleanup = () => {
      $('#modalOverlay').classList.remove('show');
      $('#modalConfirm').onclick = null;
      $('#modalCancel').onclick = null;
    };
    
    $('#modalConfirm').onclick = () => {
      cleanup();
      const input = $('#modalInput input') || $('#modalInput textarea') || null;
      if (input) {
        resolve(input.value);
      } else {
        resolve(true);
      }
    };
    $('#modalCancel').onclick = () => {
      cleanup();
      resolve(null);
    };
  });
}

// ==================== THEME ====================
function setTheme(theme) {
  state.theme = theme;
  document.documentElement.setAttribute('data-theme', theme);
  const themeIcon = $('#themeIcon');
  const themeText = $('#themeText');
  if (themeIcon) themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  if (themeText) themeText.textContent = theme === 'dark' ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è';
  localStorage.setItem('theme', theme);
  localStorage.setItem('ui.theme', theme);
}

// ==================== TABS ====================
function setTab(tab) {
  if (!tab) {
    console.warn('setTab called without tab parameter');
    return;
  }
  
  // Update tabs
  $$('.tab').forEach(t => {
    if (t && t.dataset) {
      t.classList.toggle('active', t.dataset.tab === tab);
    }
  });
  
  // Update panes - hide all, show active
  // Map dashboard tab to management pane
  const targetPane = (tab === 'dashboard') ? 'management' : tab;
  const navPillPanes = ['online', 'status', 'restart', 'journal'];
  
  $$('.pane').forEach(p => {
    if (p && p.dataset) {
      const paneName = p.dataset.pane;
      
      // Show target pane if it matches
      if (paneName === targetPane) {
        p.classList.add('active');
        p.style.display = 'block';
      } 
      // Hide all other panes
      else {
        p.classList.remove('active');
        p.style.display = 'none';
      }
    }
  });
  
  // Deactivate nav pills when switching to tabs
  $$('.nav-pill').forEach(p => {
    if (p) p.classList.remove('active');
  });
  
  // Load content for active tab
  if (tab === 'dashboard') {
    // Dashboard directly shows management pane (no nav pill needed)
    loadManagement();
  } else if (tab === 'users') {
    loadUsers();
  } else if (tab === 'events') {
    loadEvents();
  } else if (tab === 'xray') {
    loadXrayConfig();
  } else if (tab === 'settings') {
    loadSettings();
  }
}

// ==================== STATE & LOCALSTORAGE ====================
const state = {
  settings: null,
  users: [],
  lang: localStorage.getItem('ui.lang') || 'ru',
  theme: localStorage.getItem('ui.theme') || 'dark',
  unit: localStorage.getItem('ui.unit') || 'gb',
  mode: localStorage.getItem('usage.mode') || 'daily',
  date: localStorage.getItem('usage.date') || '',
  selectedUsers: JSON.parse(localStorage.getItem('users.selected') || '[]'),
  mainMetric: localStorage.getItem('users.mainMetric') || 'traffic',
  miniMetric: localStorage.getItem('users.miniMetric') || 'traffic',
  livePeriod: parseInt(localStorage.getItem('live.period') || '3600'),
  liveGran: parseInt(localStorage.getItem('live.gran') || '300'),
  liveMetric: localStorage.getItem('live.metric') || 'conns',
  liveScope: localStorage.getItem('live.scope') || 'global',
  livePaused: localStorage.getItem('live.paused') === 'true',
  dashboard: null,
};

// ==================== NAVIGATION ====================
function setNav(nav) {
  if (!nav) {
    console.warn('setNav called without nav parameter');
    return;
  }
  
  // Update nav pills
  const navPills = $$('.nav-pill');
  navPills.forEach(p => {
    if (p && p.dataset) {
      const isActive = p.dataset.nav === nav;
      if (isActive) {
        p.classList.add('active');
      } else {
        p.classList.remove('active');
      }
    }
  });
  
  // Update panes - hide all, show active
  const panes = $$('.pane');
  panes.forEach(p => {
    if (p && p.dataset) {
      const paneName = p.dataset.pane;
      
      // Show target nav pane
      if (paneName === nav) {
        p.classList.add('active');
        p.style.display = 'block';
      } 
      // Hide all other panes
      else {
        p.classList.remove('active');
        p.style.display = 'none';
      }
    }
  });
  
  // Deactivate tabs when switching to nav pills
  $$('.tab').forEach(t => {
    if (t) t.classList.remove('active');
  });
  
  // Load content for active pane
  if (nav === 'online') {
    startOnlinePolling(); // –ó–∞–ø—É—Å—Ç–∏—Ç—å online polling —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ online
  } else if (nav === 'status') {
    stopOnlinePolling();
    loadStatus();
  } else if (nav === 'restart') {
    stopOnlinePolling();
    loadRestart();
  } else if (nav === 'journal') {
    stopOnlinePolling();
    loadJournal();
  }
}

// ==================== MANAGEMENT (–ò—Å—Ç–æ—Ä–∏—è) ====================
async function loadManagement() {
  try {
    let date = state.date;
    if (!date) {
      date = await getLastAvailableDate();
    }
    if (!date) {
      console.warn('No date available for dashboard');
      showToast('‚ö†Ô∏è', '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
      return;
    }
    
    console.log('Loading dashboard for date:', date, 'mode:', state.mode);
    const data = await api(`/api/usage/dashboard?date=${date}&mode=${state.mode}&windowDays=7`);
    
    // API returns {ok: true, ...} or just data
    if (data && (data.ok !== false)) {
      console.log('Dashboard data loaded successfully:', {
        summary: data.summary ? 'present' : 'missing',
        trends: data.trends ? 'present' : 'missing',
        users: data.users ? `${data.users.length} users` : 'missing',
        meta: data.meta || {}
      });
      state.dashboard = data;
      renderManagement(data);
    } else {
      console.error('Dashboard data invalid:', data);
      showToast('‚ùå', '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
    }
  } catch (e) {
    console.error('Management load error:', e);
    showToast('‚ùå', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + (e.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
  }
}

async function getLastAvailableDate() {
  try {
    const res = await api('/api/usage/dates');
    // Handle both {ok: true, dates: [...]} and {dates: [...]} formats
    const dates = (res && res.ok && res.dates) ? res.dates : (res && res.dates ? res.dates : []);
    if (dates && dates.length > 0) {
      // Prefer today's date, otherwise use the first (most recent) date
      const today = new Date().toISOString().split('T')[0];
      const date = dates.includes(today) ? today : dates[0];
      state.date = date;
      localStorage.setItem('usage.date', state.date);
      return date;
    }
  } catch (e) {
    console.error('Error getting last available date:', e);
  }
  return null;
}

function renderManagement(data) {
  if (!data) {
    console.warn('renderManagement: no data');
    return;
  }
  // Handle both {ok: true, ...} and direct data formats
  if (data.hasOwnProperty('ok') && !data.ok) {
    console.warn('renderManagement: data.ok is false', data);
    return;
  }
  
  console.log('renderManagement: rendering data', {
    summary: data.summary ? 'present' : 'missing',
    trends: data.trends ? 'present' : 'missing',
    topDomains: data.topDomains ? 'present' : 'missing',
    users: data.users ? `${data.users.length} users` : 'missing',
    userDetails: data.userDetails ? `${Object.keys(data.userDetails).length} details` : 'missing',
    meta: data.meta || {}
  });
  
  const s = data.summary || {};
  const t = data.trends || {};
  const td = data.topDomains || { traffic: [], conns: [] };
  const u = data.users || [];
  const ud = data.userDetails || {};
  const meta = data.meta || {};
  
  // Render KPI cards
  try {
    renderKPICards(s, td, state.unit);
  } catch (e) {
    console.error('Error rendering KPI cards:', e);
  }
  
  // Render trends charts - force update by disposing old charts first
  if (typeof trafficChart !== 'undefined' && trafficChart) {
    try {
      trafficChart.dispose();
      trafficChart = null;
    } catch (e) {
      console.warn('Error disposing traffic chart:', e);
    }
  }
  if (typeof connsChart !== 'undefined' && connsChart) {
    try {
      connsChart.dispose();
      connsChart = null;
    } catch (e) {
      console.warn('Error disposing conns chart:', e);
    }
  }
  renderTrendsCharts(t, state.mode, state.unit);
  
  // Render top domains tables
  renderTopDomainsTables(td, state.unit);
  
  // Render users histograms (always show ALL users, not filtered)
  // These are separate from the user filter in the Users section
  renderUsersHistograms(u, state.unit);
  
  // Render users section
  renderUsersSection(u, ud, state.selectedUsers, state.mainMetric, state.miniMetric, state.mode, state.unit);
  
  // Update date select
  updateDateSelect();
}

function renderKPICards(summary, topDomains, unit) {
  if (!summary) {
    console.warn('renderKPICards: no summary data');
    return;
  }
  if (!topDomains) {
    console.warn('renderKPICards: no topDomains data');
    topDomains = { traffic: [], conns: [], top3TrafficDomains: [], top3ConnsDomains: [] };
  }
  
  const gbBase = 1000000000;
  const mbBase = 1000000;
  const base = unit === 'gb' ? gbBase : mbBase;
  const unitLabel = unit === 'gb' ? 'GB' : 'MB';
  
  // Today traffic
  const todayTraffic = (summary.todayTrafficBytes || 0) / base;
  const yesterdayTraffic = (summary.yesterdayTrafficBytes || 0) / base;
  const avg7dTraffic = (summary.avg7dTrafficBytes || 0) / base;
  const deltaTodayTraffic = summary.deltaTodayTrafficPct;
  
  const el1 = $('#kpiTodayTrafficValue');
  const el2 = $('#kpiTodayTrafficAvg');
  if (el1) el1.textContent = todayTraffic.toFixed(2) + ' ' + unitLabel;
  if (el2) el2.textContent = avg7dTraffic.toFixed(2) + ' ' + unitLabel;
  renderBubble($('#kpiTodayTrafficBubble'), deltaTodayTraffic);
  
  // Today conns
  const todayConns = summary.todayConns || 0;
  const yesterdayConns = summary.yesterdayConns || 0;
  const avg7dConns = Math.round(summary.avg7dConns || 0);
  const deltaTodayConns = summary.deltaTodayConnsPct;
  
  const el3 = $('#kpiTodayConnsValue');
  const el4 = $('#kpiTodayConnsAvg');
  if (el3) el3.textContent = todayConns.toLocaleString('ru-RU');
  if (el4) el4.textContent = avg7dConns.toLocaleString('ru-RU');
  renderBubble($('#kpiTodayConnsBubble'), deltaTodayConns);
  
  // 7d total traffic
  const total7dTraffic = (summary.total7dTrafficBytes || 0) / base;
  const prevTotal7dTraffic = (summary.prevTotal7dTrafficBytes || 0) / base;
  const deltaTotal7dTraffic = summary.deltaTotal7dTrafficPct;
  
  const el5 = $('#kpiTotal7dTrafficValue');
  if (el5) el5.textContent = total7dTraffic.toFixed(2) + ' ' + unitLabel;
  renderBubble($('#kpiTotal7dTrafficBubble'), deltaTotal7dTraffic);
  
  // 7d total conns
  const total7dConns = summary.total7dConns || 0;
  const prevTotal7dConns = summary.prevTotal7dConns || 0;
  const deltaTotal7dConns = summary.deltaTotal7dConnsPct;
  
  const el6 = $('#kpiTotal7dConnsValue');
  if (el6) el6.textContent = total7dConns.toLocaleString('ru-RU');
  renderBubble($('#kpiTotal7dConnsBubble'), deltaTotal7dConns);
  
  // Top domains traffic (top-3) - display with traffic data
  const top3TrafficData = (topDomains.traffic || []).slice(0, 3);
  const el7 = $('#kpiTopDomainsTrafficList');
  if (el7) {
    if (top3TrafficData.length > 0) {
      const domainsText = top3TrafficData.map(d => {
        const domain = d.domain || '‚Äî';
        const traffic = ((d.trafficBytes || 0) / base).toFixed(2);
        return `${domain} (${traffic} ${unitLabel})`;
      }).join(' | ');
      el7.innerHTML = `<div class="kpi-list-item" style="padding:2px 0;justify-content:flex-start;"><span>${domainsText}</span></div>`;
    } else {
      el7.innerHTML = '<div class="kpi-list-item" style="padding:2px 0;"><span>‚Äî</span></div>';
    }
  }
  renderBubble($('#kpiTopDomainsTrafficBubble'), deltaTotal7dTraffic);
  
  // Top domains conns (top-3) - display with conns data
  const top3ConnsData = (topDomains.conns || []).slice(0, 3);
  const el8 = $('#kpiTopDomainsConnsList');
  if (el8) {
    if (top3ConnsData.length > 0) {
      const domainsText = top3ConnsData.map(d => {
        const domain = d.domain || '‚Äî';
        const conns = (d.conns || 0).toLocaleString('ru-RU');
        return `${domain} (${conns})`;
      }).join(' | ');
      el8.innerHTML = `<div class="kpi-list-item" style="padding:2px 0;justify-content:flex-start;"><span>${domainsText}</span></div>`;
    } else {
      el8.innerHTML = '<div class="kpi-list-item" style="padding:2px 0;"><span>‚Äî</span></div>';
    }
  }
  renderBubble($('#kpiTopDomainsConnsBubble'), deltaTotal7dConns);
}

function renderBubble(el, delta) {
  if (!el) return;
  if (delta === null || delta === undefined) {
    el.textContent = '‚Äî';
    el.className = 'kpi-bubble na';
    return;
  }
  const sign = delta >= 0 ? '+' : '';
  el.textContent = `${sign}${delta.toFixed(2)}%`;
  el.className = `kpi-bubble ${delta >= 0 ? 'up' : 'down'}`;
}

// ==================== HELPERS ====================
/**
 * –ü–æ–ª—É—á–∞–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
 * @param {string} varName - –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä "--text" –∏–ª–∏ "--muted")
 * @param {string} fallback - –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
 * @returns {string} - –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "#e6edf3")
 */
function getCSSColor(varName, fallback = '#8b949e') {
  try {
    const root = document.documentElement;
    if (!root || typeof root !== 'object') {
      return fallback;
    }
    const style = getComputedStyle(root);
    if (!style) {
      return fallback;
    }
    const value = style.getPropertyValue(varName).trim();
    return value || fallback;
  } catch (e) {
    console.warn(`Failed to get CSS color for ${varName}:`, e);
    return fallback;
  }
}

/**
 * –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è am5.color —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
 * @param {string} varName - –∏–º—è CSS –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä "--text")
 * @param {string} fallback - –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
 * @returns {am5.Color} - –æ–±—ä–µ–∫—Ç —Ü–≤–µ—Ç–∞ amCharts
 */
function amColorVar(varName, fallback = '#8b949e') {
  const colorValue = getCSSColor(varName, fallback);
  return am5.color(colorValue);
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ —ç–ª–µ–º–µ–Ω—Ç–µ
 * @param {HTMLElement} el - —ç–ª–µ–º–µ–Ω—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
 * @returns {boolean} - true –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
 */
function isRenderable(el) {
  if (!el || !(el instanceof Element)) {
    return false;
  }
  try {
    const rect = el.getBoundingClientRect();
    // –≠–ª–µ–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ DOM –∏ –∏–º–µ—Ç—å —Ä–∞–∑–º–µ—Ä—ã
    return rect.width > 0 && rect.height > 0;
  } catch (e) {
    return false;
  }
}

let trafficChart = null;
let connsChart = null;

function renderTrendsCharts(trends, mode, unit) {
  const gbBase = 1000000000;
  const mbBase = 1000000;
  const base = unit === 'gb' ? gbBase : mbBase;
  const unitLabel = unit === 'gb' ? 'GB' : 'MB';
  
  // Traffic chart
  const trafficData = trends.trafficDailyBytes || [];
  if (trafficData.length === 0) {
    console.warn('renderTrendsCharts: no traffic data');
  }
  
  const trafficLabels = trafficData.map(t => {
    try {
      const dateStr = typeof t === 'object' ? (t.date || '') : '';
      if (!dateStr) return '‚Äî';
      const d = new Date(dateStr + 'T00:00:00');
      if (isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    } catch (e) {
      console.error('Error parsing traffic date:', t, e);
      return '‚Äî';
    }
  });
  const trafficValues = trafficData.map(t => {
    const val = typeof t === 'object' ? (t.value || 0) : (t || 0);
    return Number(val) / base;
  });
  
  const elTraffic = document.getElementById('chTraffic');
  if (!elTraffic) {
    console.warn('chTraffic element not found');
    return;
  }
  
  // Destroy existing chart if exists
  if (trafficChart) {
    try {
      trafficChart.dispose();
    } catch (e) {
      console.warn('Error disposing traffic chart:', e);
    }
  }
  
  am5.ready(() => {
    try {
      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
      const elCheck = document.getElementById('chTraffic');
      if (!elCheck || elCheck !== elTraffic) {
        console.warn('renderTrendsCharts: chTraffic element changed');
        return;
      }
      
      const maxValue = Math.max(...trafficValues, 1);
      
      // Create root element
      const root = am5.Root.new(elCheck);
    root.setThemes([
      am5themes_Animated.new(root)
    ]);
    
    // Create chart
    const chart = root.container.children.push(am5xy.XYChart.new(root, {
      panX: false,
      panY: false,
      wheelX: "none",
      wheelY: "none",
      paddingLeft: 0,
      paddingRight: 0
    }));
    
    // Create axes
    const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
      categoryField: "category",
      renderer: am5xy.AxisRendererX.new(root, {
        cellStartLocation: 0.1,
        cellEndLocation: 0.9,
        minGridDistance: 30
      })
    }));
    
    xAxis.data.setAll(trafficLabels.map((label, idx) => ({
      category: label
    })));
    
    const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, {})
    }));
    
    // Create series
    const series = chart.series.push(am5xy.ColumnSeries.new(root, {
      name: `Traffic (${unitLabel})`,
      xAxis: xAxis,
      yAxis: yAxis,
      valueYField: "value",
      categoryXField: "category"
    }));
    
    // Configure columns with gradient fill
    series.columns.template.setAll({
      tooltipText: "{categoryX}: {valueY.formatNumber('#.00')} {unitLabel}",
      tooltipY: 0,
      strokeOpacity: 0,
      cornerRadiusTL: 8,
      cornerRadiusTR: 8,
      cornerRadiusBL: 8,
      cornerRadiusBR: 8
    });
    
    // Dynamic fill color based on value
    series.columns.template.adapters.add("fill", (fill, target) => {
      const dataItem = target.dataItem;
      if (dataItem) {
        const value = dataItem.get("valueY");
        const ratio = maxValue > 0 ? value / maxValue : 0;
        const opacity = 0.4 + ratio * 0.4;
        return am5.color(`rgba(88, 166, 255, ${opacity})`);
      }
      return fill;
    });
    
    // Labels added via bullets for ColumnSeries
    series.bullets.push(function() {
      const label = am5.Label.new(root, {
        text: "",
        fill: amColorVar("--text"),
        centerY: 0,
        centerX: am5.p50,
        fontSize: 11,
        fontWeight: "bold",
        dy: -5
      });
      // Format text using adapter
      label.adapters.add("text", (text, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const value = dataItem.get("valueY");
          return value ? value.toFixed(2) : "";
        }
        return "";
      });
      return am5.Bullet.new(root, {
        locationY: 1,
        sprite: label
      });
    });
    
    // Set data
    series.data.setAll(trafficValues.map((val, idx) => ({
      category: trafficLabels[idx],
      value: val,
      unitLabel: unitLabel
    })));
    
    // Add cursor
    chart.set("cursor", am5xy.XYCursor.new(root, {}));
    
      trafficChart = root;
    } catch (e) {
      console.error('Error creating traffic chart:', e);
      trafficChart = null;
    }
  });
  
  // Conns chart
  const connsData = trends.connsDaily || [];
  if (connsData.length === 0) {
    console.warn('renderTrendsCharts: no conns data');
  }
  
  const connsLabels = connsData.map(t => {
    try {
      const dateStr = typeof t === 'object' ? (t.date || '') : '';
      if (!dateStr) {
        console.warn('renderTrendsCharts: empty dateStr in conns data:', t);
        return '‚Äî';
      }
      const d = new Date(dateStr + 'T00:00:00');
      if (isNaN(d.getTime())) {
        console.warn('renderTrendsCharts: invalid date for conns:', dateStr, t);
        return '‚Äî';
      }
      const label = d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
      return label;
    } catch (e) {
      console.error('Error parsing conns date:', t, e);
      return '‚Äî';
    }
  });
  const connsValues = connsData.map(t => {
    const val = typeof t === 'object' ? (t.value || 0) : (t || 0);
    const numVal = Number(val) || 0;
    return numVal;
  });
  
  // Debug: log data for troubleshooting
  console.log('renderTrendsCharts: connsData length:', connsData.length);
  console.log('renderTrendsCharts: connsLabels:', connsLabels);
  console.log('renderTrendsCharts: connsValues:', connsValues);
  
  const elConns = document.getElementById('chConns');
  if (!elConns) {
    console.warn('chConns element not found');
    return;
  }
  
  // Destroy existing chart if exists
  if (connsChart) {
    try {
      connsChart.dispose();
    } catch (e) {
      console.warn('Error disposing conns chart:', e);
    }
  }
  
  am5.ready(() => {
    try {
      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
      const elCheck = document.getElementById('chConns');
      if (!elCheck || elCheck !== elConns) {
        console.warn('renderTrendsCharts: chConns element changed');
        return;
      }
      
      const maxValue = Math.max(...connsValues, 1);
      
      // Create root element
      const root = am5.Root.new(elCheck);
    root.setThemes([
      am5themes_Animated.new(root)
    ]);
    
    // Create chart
    const chart = root.container.children.push(am5xy.XYChart.new(root, {
      panX: false,
      panY: false,
      wheelX: "none",
      wheelY: "none",
      paddingLeft: 0,
      paddingRight: 0
    }));
    
    // Create axes
    const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
      categoryField: "category",
      renderer: am5xy.AxisRendererX.new(root, {
        cellStartLocation: 0.1,
        cellEndLocation: 0.9,
        minGridDistance: 30
      })
    }));
    
    // Set X-axis data - ensure all categories are included, even with 0 values
    const xAxisData = connsLabels.map((label, idx) => ({
      category: label
    }));
    xAxis.data.setAll(xAxisData);
    console.log('renderTrendsCharts: xAxis data set:', xAxisData.length, 'categories');
    
    const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, {}),
      min: 0  // Ensure Y-axis starts at 0 to show zero values
    }));
    
    // Create series
    const series = chart.series.push(am5xy.ColumnSeries.new(root, {
      name: "Connections",
      xAxis: xAxis,
      yAxis: yAxis,
      valueYField: "value",
      categoryXField: "category"
    }));
    
    // Configure columns with gradient fill
    series.columns.template.setAll({
      tooltipText: "{categoryX}: {valueY.formatNumber('#,###')} connections",
      tooltipY: 0,
      strokeOpacity: 0,
      cornerRadiusTL: 8,
      cornerRadiusTR: 8,
      cornerRadiusBL: 8,
      cornerRadiusBR: 8
    });
    
    // Ensure zero values create visible columns (minimum height)
    series.columns.template.adapters.add("height", (height, target) => {
      const dataItem = target.dataItem;
      if (dataItem) {
        const value = dataItem.get("valueY");
        // For zero values, show a minimal visible bar (2px) so the date is visible on graph
        if (value === 0 || value === null || value === undefined) {
          return 2;  // 2px minimum height for zero values
        }
      }
      return height;
    });
    
    // Dynamic fill color based on value
    series.columns.template.adapters.add("fill", (fill, target) => {
      const dataItem = target.dataItem;
      if (dataItem) {
        const value = dataItem.get("valueY");
        // For zero values, use a very light color but still visible
        if (value === 0 || value === null || value === undefined) {
          return am5.color(`rgba(63, 185, 80, 0.15)`);  // Very light green for zero (slightly more visible)
        }
        const ratio = maxValue > 0 ? value / maxValue : 0;
        const opacity = 0.4 + ratio * 0.4;
        return am5.color(`rgba(63, 185, 80, ${opacity})`);
      }
      return fill;
    });
    
    // Labels added via bullets for ColumnSeries
    series.bullets.push(function() {
      const label = am5.Label.new(root, {
        text: "",
        fill: amColorVar("--text"),
        centerY: 0,
        centerX: am5.p50,
        fontSize: 11,
        fontWeight: "bold",
        dy: -5
      });
      // Format text using adapter
      label.adapters.add("text", (text, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const value = dataItem.get("valueY");
          return value ? value.toLocaleString('ru-RU') : "";
        }
        return "";
      });
      return am5.Bullet.new(root, {
        locationY: 1,
        sprite: label
      });
    });
    
    // Set data - ensure all data points are included, even with 0 values
    const seriesData = connsValues.map((val, idx) => ({
      category: connsLabels[idx],
      value: val
    }));
    console.log('renderTrendsCharts: series data set:', seriesData.length, 'points');
    console.log('renderTrendsCharts: series data sample:', seriesData.slice(0, 3));
    series.data.setAll(seriesData);
    
    // Add cursor
    chart.set("cursor", am5xy.XYCursor.new(root, {}));
    
      connsChart = root;
    } catch (e) {
      console.error('Error creating conns chart:', e);
      connsChart = null;
    }
  });
}

function renderTopDomainsTables(topDomains, unit) {
  if (!topDomains) return;
  
  const gbBase = 1000000000;
  const mbBase = 1000000;
  const base = unit === 'gb' ? gbBase : mbBase;
  const unitLabel = unit === 'gb' ? 'GB' : 'MB';
  
  // Traffic table - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –¥–æ top-7
  const trafficTbody = $('#tblTopTraffic tbody');
  if (trafficTbody) {
    const trafficRows = (topDomains.traffic || []).slice(0, 7).map(d => `
      <tr>
        <td>${d.domain || '‚Äî'}</td>
        <td>${((d.trafficBytes || 0) / base).toFixed(2)} ${unitLabel}</td>
        <td>${(d.sharePct || 0).toFixed(2)}%</td>
      </tr>
    `).join('') || '<tr><td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    trafficTbody.innerHTML = trafficRows;
  }
  
  // Conns table - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –¥–æ top-7
  const connsTbody = $('#tblTopConns tbody');
  if (connsTbody) {
    const connsRows = (topDomains.conns || []).slice(0, 7).map(d => `
      <tr>
        <td>${d.domain || '‚Äî'}</td>
        <td>${(d.conns || 0).toLocaleString('ru-RU')}</td>
        <td>${(d.sharePct || 0).toFixed(2)}%</td>
      </tr>
    `).join('') || '<tr><td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    connsTbody.innerHTML = connsRows;
  }
}

let usersCmpChart = null;
let usersTrafficChart = null;
let usersConnsChart = null;
let usersDomChart = null;
const userColors = {}; // userId -> color

function getColorForUser(userId) {
  if (!userColors[userId]) {
    const colors = [
      '#8ab4ff', '#26c281', '#ff5d5d', '#d29922', '#a371f7',
      '#58a6ff', '#3fb950', '#f85149', '#d29922', '#bc8cff'
    ];
    const idx = Object.keys(userColors).length % colors.length;
    userColors[userId] = colors[idx];
  }
  return userColors[userId];
}

// Helper function to darken a hex color (for line stroke)
function darkenColor(hex, percent) {
  const num = parseInt(hex.replace('#', ''), 16);
  const r = Math.max(0, Math.min(255, (num >> 16) - Math.round(255 * percent / 100)));
  const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) - Math.round(255 * percent / 100)));
  const b = Math.max(0, Math.min(255, (num & 0x0000FF) - Math.round(255 * percent / 100)));
  return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
}

function renderUsersSection(users, userDetails, selectedUsers, mainMetric, miniMetric, mode, unit) {
  // Filter users
  const filteredUsers = selectedUsers.length === 0 || selectedUsers.includes('all') 
    ? users 
    : users.filter(u => selectedUsers.includes(u.userId));
  
  // Render filter chips
  renderUserFilters(users, selectedUsers);
  
  // Note: comparison charts are now rendered separately in renderUsersHistograms
  // and are NOT affected by the user filter - they always show ALL users
  
  // Render user cards
  renderUserCards(filteredUsers, userDetails, mode, unit, miniMetric);
}

function renderUserFilters(users, selectedUsers) {
  const container = $('#userFilters');
  if (!container) return;
  
  const allSelected = selectedUsers.length === 0 || selectedUsers.includes('all');
  const html = `
    <div class="filter-chip ${allSelected ? 'active' : ''}" data-user="all">–í—Å–µ</div>
    ${users.map(u => {
      const isSelected = selectedUsers.includes(u.userId);
      return `<div class="filter-chip ${isSelected ? 'active' : ''}" data-user="${u.userId}">${u.displayName || u.userId}</div>`;
    }).join('')}
  `;
  container.innerHTML = html;
  
  // Add click handlers
  container.querySelectorAll('.filter-chip').forEach(chip => {
    chip.onclick = () => {
      const userId = chip.dataset.user;
      if (userId === 'all') {
        state.selectedUsers = ['all'];
      } else {
        if (state.selectedUsers.includes('all')) {
          state.selectedUsers = [userId];
        } else {
          const idx = state.selectedUsers.indexOf(userId);
          if (idx >= 0) {
            state.selectedUsers.splice(idx, 1);
            if (state.selectedUsers.length === 0) {
              state.selectedUsers = ['all'];
            }
          } else {
            state.selectedUsers.push(userId);
          }
        }
      }
      localStorage.setItem('users.selected', JSON.stringify(state.selectedUsers));
      if (state.dashboard) {
        renderUsersSection(state.dashboard.users, state.dashboard.userDetails, 
                          state.selectedUsers, state.mainMetric, state.miniMetric, state.mode, state.unit);
      }
    };
  });
}

function renderUsersComparisonChart(users, metric, unit) {
  const el = document.getElementById('chUsersCmp');
  if (!el) return;
  
  const gbBase = 1000000000;
  const mbBase = 1000000;
  const base = unit === 'gb' ? gbBase : mbBase;
  const unitLabel = unit === 'gb' ? 'GB' : 'MB';
  
  // Prepare data with users
  const userData = users.map(u => {
    const value = metric === 'traffic' 
      ? Number(((u.traffic7dBytes || 0) / base).toFixed(2))
      : Number(u.conns7d || 0);
    return {
      user: u,
      label: u.displayName || u.userId,
      value: value,
      color: getColorForUser(u.userId)
    };
  });
  
  // Sort by value descending (top user first)
  userData.sort((a, b) => b.value - a.value);
  
  const labels = userData.map(d => d.label);
  const data = userData.map(d => d.value);
  const colors = userData.map(d => d.color);
  
  // Destroy existing chart if exists
  if (usersCmpChart) {
    try {
      usersCmpChart.dispose();
    } catch (e) {
      console.warn('Error disposing users comparison chart:', e);
    }
  }
  
  am5.ready(() => {
    try {
      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
      const elCheck = document.getElementById('chUsersCmp');
      if (!elCheck || elCheck !== el) {
        console.warn('renderUsersComparisonChart: element changed');
        return;
      }
      
      // Create root element
      const root = am5.Root.new(elCheck);
      root.setThemes([
        am5themes_Animated.new(root)
      ]);
      
      // Create chart
      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "none",
        wheelY: "none",
        paddingLeft: 0,
        paddingRight: 0
      }));
      
      // Create axes - vertical bar chart (categories on Y, values on X)
      const yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "category",
        renderer: am5xy.AxisRendererY.new(root, {
          cellStartLocation: 0.1,
          cellEndLocation: 0.9,
          minGridDistance: 20,
          inversed: false
        })
      }));
      
      yAxis.data.setAll(labels.map((label, idx) => ({
        category: label
      })));
      
      const xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererX.new(root, {})
      }));
      
      // Create series - horizontal bar chart
      const series = chart.series.push(am5xy.ColumnSeries.new(root, {
        name: metric === 'traffic' ? `Traffic (${unitLabel})` : 'Connections',
        xAxis: xAxis,
        yAxis: yAxis,
        valueXField: "value",
        categoryYField: "category"
      }));
      
      // Configure columns with user-specific colors (horizontal bars)
      series.columns.template.setAll({
        tooltipText: "{categoryY}: {valueX.formatNumber(metric === 'traffic' ? '#.00' : '#,###')} {unitLabel}",
        tooltipX: 0,
        strokeOpacity: 0,
        cornerRadiusTL: 4,
        cornerRadiusTR: 4,
        cornerRadiusBL: 4,
        cornerRadiusBR: 4
      });
      
      // Dynamic fill color based on user
      series.columns.template.adapters.add("fill", (fill, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const idx = dataItem.get("index");
          if (idx !== undefined && colors[idx]) {
            return am5.color(colors[idx] + 'CC');
          }
        }
        return fill;
      });
      
      series.columns.template.adapters.add("stroke", (stroke, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const idx = dataItem.get("index");
          if (idx !== undefined && colors[idx]) {
            return am5.color(colors[idx]);
          }
        }
        return stroke;
      });
      
      // Labels added via bullets for ColumnSeries (horizontal bars)
      series.bullets.push(function() {
        const label = am5.Label.new(root, {
          text: "",
          fill: amColorVar("--text"),
          centerY: am5.p50,
          centerX: 0,
          fontSize: 10,
          fontWeight: "bold",
          dx: 5
        });
        // Format text using adapter
        label.adapters.add("text", (text, target) => {
          const dataItem = target.dataItem;
          if (dataItem) {
            const value = dataItem.get("valueX");
            if (!value) return "";
            if (metric === 'traffic') {
              return value.toFixed(2);
            } else {
              return value.toLocaleString('ru-RU');
            }
          }
          return "";
        });
        return am5.Bullet.new(root, {
          locationX: 1,
          sprite: label
        });
      });
      
      // Set data
      series.data.setAll(data.map((val, idx) => ({
        category: labels[idx],
        value: val,
        unitLabel: metric === 'traffic' ? unitLabel : 'connections',
        metric: metric
      })));
      
      // Add cursor
      chart.set("cursor", am5xy.XYCursor.new(root, {}));
      
      usersCmpChart = root;
    } catch (e) {
      console.error('Error creating users comparison chart:', e);
      usersCmpChart = null;
    }
  });
}

// Render two histograms for users: traffic (top) and connections (bottom)
// These always show ALL users, regardless of filter in Users section
function renderUsersHistograms(users, unit) {
  if (!users || !Array.isArray(users) || users.length === 0) {
    console.warn('renderUsersHistograms: no users data');
    return;
  }
  
  const gbBase = 1000000000;
  const mbBase = 1000000;
  const base = unit === 'gb' ? gbBase : mbBase;
  const unitLabel = unit === 'gb' ? 'GB' : 'MB';
  
  // Prepare data for traffic histogram
  const trafficData = users.map(u => ({
    user: u,
    label: u.displayName || u.userId,
    value: Number(((u.traffic7dBytes || 0) / base).toFixed(2)),
    color: getColorForUser(u.userId)
  })).sort((a, b) => b.value - a.value); // Sort descending
  
  // Prepare data for connections histogram
  const connsData = users.map(u => ({
    user: u,
    label: u.displayName || u.userId,
    value: Number(u.conns7d || 0),
    color: getColorForUser(u.userId)
  })).sort((a, b) => b.value - a.value); // Sort descending
  
  // Render traffic histogram
  renderUserHistogram('chUsersTraffic', trafficData, unitLabel, 'traffic', unit);
  
  // Render connections histogram
  renderUserHistogram('chUsersConns', connsData, 'connections', 'conns', unit);
}

function renderUserHistogram(elementId, userData, unitLabel, metric, unit) {
  const el = document.getElementById(elementId);
  if (!el) {
    console.warn(`renderUserHistogram: element ${elementId} not found`);
    return;
  }
  
  const labels = userData.map(d => d.label);
  const values = userData.map(d => d.value);
  const colors = userData.map(d => d.color);
  
  // Destroy existing chart if exists
  if (metric === 'traffic' && usersTrafficChart) {
    try {
      usersTrafficChart.dispose();
      usersTrafficChart = null;
    } catch (e) {
      console.warn('Error disposing users traffic chart:', e);
    }
  }
  if (metric === 'conns' && usersConnsChart) {
    try {
      usersConnsChart.dispose();
      usersConnsChart = null;
    } catch (e) {
      console.warn('Error disposing users conns chart:', e);
    }
  }
  
  am5.ready(() => {
    try {
      const elCheck = document.getElementById(elementId);
      if (!elCheck) {
        console.warn(`renderUserHistogram: element ${elementId} not found in am5.ready`);
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —ç–ª–µ–º–µ–Ω—Ç–∞
      const rect = elCheck.getBoundingClientRect();
      if (rect.width === 0 || rect.height === 0) {
        console.warn(`renderUserHistogram: element ${elementId} has zero size, retrying...`);
        setTimeout(() => renderUserHistogram(elementId, userData, unitLabel, metric, unit), 200);
        return;
      }
      
      console.log(`renderUserHistogram: creating chart for ${elementId}, size: ${rect.width}x${rect.height}`);
      
      // Create root element
      const root = am5.Root.new(elCheck);
      root.setThemes([
        am5themes_Animated.new(root)
      ]);
      
      // Create chart
      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "none",
        wheelY: "none",
        paddingLeft: 0,
        paddingRight: 0,
        paddingTop: 20,
        paddingBottom: 0
      }));
      
      // Create axes - horizontal bar chart (categories on Y, values on X)
      const yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "category",
        renderer: am5xy.AxisRendererY.new(root, {
          cellStartLocation: 0.1,
          cellEndLocation: 0.9,
          minGridDistance: 20,
          inversed: false
        })
      }));
      
      yAxis.data.setAll(labels.map((label) => ({
        category: label
      })));
      
      const xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererX.new(root, {}),
        min: 0
      }));
      
      // Create series - horizontal bar chart
      const series = chart.series.push(am5xy.ColumnSeries.new(root, {
        name: metric === 'traffic' ? `Traffic (${unitLabel})` : 'Connections',
        xAxis: xAxis,
        yAxis: yAxis,
        valueXField: "value",
        categoryYField: "category"
      }));
      
      // Configure columns
      const formatPattern = metric === 'traffic' ? '#.00' : '#,###';
      series.columns.template.setAll({
        tooltipText: `{categoryY}: {valueX.formatNumber('${formatPattern}')} ${unitLabel}`,
        tooltipX: 0,
        strokeOpacity: 0,
        cornerRadiusTL: 4,
        cornerRadiusTR: 4,
        cornerRadiusBL: 4,
        cornerRadiusBR: 4
      });
      
      // Dynamic fill color based on user
      series.columns.template.adapters.add("fill", (fill, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const idx = dataItem.get("index");
          if (idx !== undefined && colors[idx]) {
            return am5.color(colors[idx] + 'CC');
          }
        }
        return fill;
      });
      
      series.columns.template.adapters.add("stroke", (stroke, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const idx = dataItem.get("index");
          if (idx !== undefined && colors[idx]) {
            return am5.color(colors[idx]);
          }
        }
        return stroke;
      });
      
      // Labels on bars
      series.bullets.push(function() {
        const label = am5.Label.new(root, {
          text: "",
          fill: amColorVar("--text"),
          centerY: am5.p50,
          centerX: 0,
          fontSize: 10,
          fontWeight: "bold",
          dx: 5
        });
        label.adapters.add("text", (text, target) => {
          const dataItem = target.dataItem;
          if (dataItem) {
            const value = dataItem.get("valueX");
            if (!value) return "";
            if (metric === 'traffic') {
              return value.toFixed(2);
            } else {
              return value.toLocaleString('ru-RU');
            }
          }
          return "";
        });
        return am5.Bullet.new(root, {
          locationX: 1,
          sprite: label
        });
      });
      
      // Set data
      series.data.setAll(values.map((val, idx) => ({
        category: labels[idx],
        value: val
      })));
      
      // Add cursor
      chart.set("cursor", am5xy.XYCursor.new(root, {}));
      
      // Store chart reference
      if (metric === 'traffic') {
        usersTrafficChart = root;
      } else {
        usersConnsChart = root;
      }
      
      console.log(`renderUserHistogram: chart created successfully for ${elementId}`);
    } catch (e) {
      console.error(`Error creating users ${metric} histogram:`, e);
      if (metric === 'traffic') {
        usersTrafficChart = null;
      } else {
        usersConnsChart = null;
      }
    }
  });
}

function renderUsersDomainsChart(users, metric) {
  const el = document.getElementById('chUsersDom');
  if (!el) {
    console.warn('renderUsersDomainsChart: chUsersDom element not found');
    return;
  }
  
  if (!users || !Array.isArray(users) || users.length === 0) {
    console.warn('renderUsersDomainsChart: no users data');
    return;
  }
  
  const labels = users.map(u => u.displayName || u.userId);
  const data = users.map(u => {
    if (metric === 'traffic') {
      return Number((u.traffic7dBytes || 0) / 1000000000); // GB
    } else {
      return Number(u.conns7d || 0);
    }
  });
  const colors = users.map(u => getColorForUser(u.userId));
  
  // Destroy existing chart if exists
  if (usersDomChart) {
    try {
      usersDomChart.dispose();
    } catch (e) {
      console.warn('Error disposing users domains chart:', e);
    }
  }
  
  am5.ready(() => {
    try {
      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
      const elCheck = document.getElementById('chUsersDom');
      if (!elCheck || elCheck !== el) {
        console.warn('renderUsersDomainsChart: element changed');
        return;
      }
      
      const maxValue = Math.max(...data, 1);
      const unitLabel = metric === 'traffic' ? 'GB' : 'connections';
      
      // Create root element
      const root = am5.Root.new(elCheck);
      root.setThemes([
        am5themes_Animated.new(root)
      ]);
      
      // Create chart
      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "none",
        wheelY: "none",
        paddingLeft: 0,
        paddingRight: 0
      }));
      
      // Create axes
      const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "category",
        renderer: am5xy.AxisRendererX.new(root, {
          cellStartLocation: 0.1,
          cellEndLocation: 0.9,
          minGridDistance: 30
        })
      }));
      
      xAxis.data.setAll(labels.map((label, idx) => ({
        category: label
      })));
      
      const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererY.new(root, {})
      }));
      
      // Create series
      const series = chart.series.push(am5xy.ColumnSeries.new(root, {
        name: metric === 'traffic' ? `Traffic (${unitLabel})` : 'Connections',
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: "value",
        categoryXField: "category"
      }));
      
      // Configure columns with user-specific colors
      series.columns.template.setAll({
        tooltipText: "{categoryX}: {valueY.formatNumber(metric === 'traffic' ? '#.00' : '#,###')} {unitLabel}",
        tooltipY: 0,
        strokeOpacity: 0,
        cornerRadiusTL: 8,
        cornerRadiusTR: 8,
        cornerRadiusBL: 8,
        cornerRadiusBR: 8
      });
      
      // Dynamic fill color based on user
      series.columns.template.adapters.add("fill", (fill, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const idx = dataItem.get("index");
          if (idx !== undefined && colors[idx]) {
            return am5.color(colors[idx] + 'CC');
          }
        }
        return fill;
      });
      
      series.columns.template.adapters.add("stroke", (stroke, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const idx = dataItem.get("index");
          if (idx !== undefined && colors[idx]) {
            return am5.color(colors[idx]);
          }
        }
        return stroke;
      });
      
      // Labels added via bullets for ColumnSeries
      series.bullets.push(function() {
        const label = am5.Label.new(root, {
          text: "",
          fill: amColorVar("--text"),
          centerY: 0,
          centerX: am5.p50,
          fontSize: 10,
          fontWeight: "bold",
          dy: -5
        });
        // Format text using adapter
        label.adapters.add("text", (text, target) => {
          const dataItem = target.dataItem;
          if (dataItem) {
            const value = dataItem.get("valueY");
            if (!value) return "";
            if (metric === 'traffic') {
              return value.toFixed(2);
            } else {
              return value.toLocaleString('ru-RU');
            }
          }
          return "";
        });
        return am5.Bullet.new(root, {
          locationY: 1,
          sprite: label
        });
      });
      
      // Set data
      series.data.setAll(data.map((val, idx) => ({
        category: labels[idx],
        value: val,
        unitLabel: unitLabel,
        metric: metric
      })));
      
      // Add cursor
      chart.set("cursor", am5xy.XYCursor.new(root, {}));
      
      usersDomChart = root;
    } catch (e) {
      console.error('Error creating users domains chart:', e);
      usersDomChart = null;
    }
  });
}

function renderUserCards(users, userDetails, mode, unit, miniMetric) {
  const container = $('#usersGrid');
  if (!container) return;
  
  const gbBase = 1000000000;
  const mbBase = 1000000;
  const base = unit === 'gb' ? gbBase : mbBase;
  const unitLabel = unit === 'gb' ? 'GB' : 'MB';
  
  const html = users.map(u => {
    const details = userDetails[u.userId] || {};
    const status = u.status === 'anomaly' ? '–∞–Ω–æ–º–∞–ª–∏–∏' : 'ok';
    const statusClass = u.status === 'anomaly' ? 'bad' : 'ok';
    
    const traffic7d = ((u.traffic7dBytes || 0) / base).toFixed(2);
    const conns7d = (u.conns7d || 0).toLocaleString('ru-RU');
    
    const topTraffic = (details.topDomainsTraffic || []).slice(0, 10);
    const topConns = (details.topDomainsConns || []).slice(0, 10);
    
    return `
      <div class="card">
        <div class="card-hd">
          <div>
            <h3>${u.displayName || u.userId}</h3>
            <div class="meta">${u.userId}</div>
          </div>
          <span class="badge ${statusClass}">${status}</span>
        </div>
        <div class="card-bd">
          <div class="row" style="margin-bottom:8px;">
            <span class="badge">traffic7d: ${traffic7d} ${unitLabel}</span>
            <span class="badge">conns7d: ${conns7d}</span>
          </div>
          <div style="height:70px;margin-bottom:6px;">
            <div id="userChart_${u.userId}" style="width:100%;height:100%;"></div>
          </div>
          <div class="domains-grid">
            <div>
              <div class="kpi-title" style="font-size:11px;margin-bottom:6px;">Top-10 Traffic</div>
              <table class="table">
                <thead><tr><th>Domain</th><th>${unitLabel}</th><th>%</th></tr></thead>
                <tbody>
                  ${topTraffic.map(d => `
                    <tr>
                      <td>${d.domain}</td>
                      <td>${((d.trafficBytes || 0) / base).toFixed(2)}</td>
                      <td>${(d.sharePct || 0).toFixed(2)}%</td>
                    </tr>
                  `).join('') || '<tr><td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>'}
                </tbody>
              </table>
            </div>
            <div>
              <div class="kpi-title" style="font-size:11px;margin-bottom:6px;">Top-10 Conns</div>
              <table class="table">
                <thead><tr><th>Domain</th><th>#</th><th>%</th></tr></thead>
                <tbody>
                  ${(topConns && topConns.length > 0) ? topConns.map(d => {
                    const domain = d.domain || '‚Äî';
                    const conns = typeof d === 'object' ? (d.conns || 0) : 0;
                    const pct = typeof d === 'object' ? (d.sharePct || 0) : 0;
                    return `
                    <tr>
                      <td>${domain}</td>
                      <td>${conns.toLocaleString('ru-RU')}</td>
                      <td>${pct.toFixed(2)}%</td>
                    </tr>
                  `;
                  }).join('') : '<tr><td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
  
  // Render mini charts for each user - use miniMetric to determine which trend to show
  users.forEach(u => {
    const details = userDetails[u.userId] || {};
    const trend = miniMetric === 'traffic' 
      ? (details.trafficTrendDailyBytes || [])
      : (details.connsTrendDaily || []);
    renderUserMiniChart(u.userId, trend, mode, unit, miniMetric);
  });
}

function renderUserMiniChart(userId, trend, mode, unit, miniMetric) {
  const el = document.getElementById(`userChart_${userId}`);
  if (!el) {
    console.warn(`Element userChart_${userId} not found`);
    return;
  }
  
  if (!trend || !Array.isArray(trend) || trend.length === 0) {
    console.warn(`No trend data for user ${userId}`);
    return;
  }
  
  const gbBase = 1000000000;
  const mbBase = 1000000;
  const base = unit === 'gb' ? gbBase : mbBase;
  const unitLabel = miniMetric === 'traffic' ? (unit === 'gb' ? 'GB' : 'MB') : 'connections';
  
  const labels = trend.map(t => {
    try {
      const dateStr = typeof t === 'object' ? (t.date || '') : '';
      if (!dateStr) return '‚Äî';
      const d = new Date(dateStr + 'T00:00:00');
      if (isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    } catch (e) {
      console.error('Error parsing mini chart date:', t, e);
      return '‚Äî';
    }
  });
  const data = trend.map(t => {
    const val = typeof t === 'object' ? (t.value || 0) : (t || 0);
    // For traffic, divide by base; for conns, use value as-is
    return miniMetric === 'traffic' ? (Number(val) / base) : Number(val);
  });
  const color = getColorForUser(userId);
  
  // Destroy existing chart if exists (store in a map)
  if (!window.userMiniCharts) {
    window.userMiniCharts = {};
  }
  if (window.userMiniCharts[userId]) {
    try {
      window.userMiniCharts[userId].dispose();
    } catch (e) {
      console.warn(`Error disposing mini chart for user ${userId}:`, e);
    }
  }
  
  am5.ready(() => {
    try {
      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
      const elCheck = document.getElementById(`userChart_${userId}`);
      if (!elCheck || elCheck !== el) {
        console.warn(`renderUserMiniChart: element changed for user ${userId}`);
        return;
      }
      
      // Create root element
      const root = am5.Root.new(elCheck);
      root.setThemes([
        am5themes_Animated.new(root)
      ]);
      
      // Create chart
      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "none",
        wheelY: "none",
        paddingLeft: 0,
        paddingRight: 0,
        paddingTop: 0,
        paddingBottom: 0
      }));
      
      // Create axes
      const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "category",
        renderer: am5xy.AxisRendererX.new(root, {
          minGridDistance: 20
        })
      }));
      xAxis.get("renderer").labels.template.setAll({
        fontSize: 8,
        fill: amColorVar("--muted")
      });
      
      xAxis.data.setAll(labels.map((label, idx) => ({
        category: label
      })));
      
      const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererY.new(root, {})
      }));
      yAxis.get("renderer").labels.template.setAll({
        fontSize: 8,
        fill: amColorVar("--muted")
      });
      
      // Create series with darker line and lighter fill (same color direction)
      const darkerColor = darkenColor(color, 20); // Darker for line (20% darker)
      
      const seriesName = miniMetric === 'traffic' ? `Traffic (${unitLabel})` : 'Connections';
      const lineSeries = chart.series.push(am5xy.LineSeries.new(root, {
        name: seriesName,
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: "value",
        categoryXField: "category",
        stroke: am5.color(darkerColor), // Darker line (same color direction, just darker)
        fill: am5.color(color) // Same color for fill, opacity will be set separately
      }));
      
      // Set tooltip format based on metric type
      lineSeries.set("tooltip", am5.Tooltip.new(root, {
        labelText: miniMetric === 'traffic' 
          ? "{categoryX}: {valueY.formatNumber('#.00')} {unitLabel}"
          : "{categoryX}: {valueY.formatNumber('#,###')} {unitLabel}"
      }));
      
      lineSeries.fills.template.setAll({
        fillOpacity: 0.3,
        visible: true
      });
      
      lineSeries.strokes.template.setAll({
        strokeWidth: 2
      });
      
      // Add bullets (points) with darker color
      lineSeries.bullets.push(() => {
        return am5.Bullet.new(root, {
          sprite: am5.Circle.new(root, {
            radius: 2,
            fill: am5.color(darkerColor), // Use darker color for consistency
            stroke: am5.color("#fff"),
            strokeWidth: 1
          })
        });
      });
      
      // Note: LineSeries doesn't have labels.template by default in amCharts 5
      // For mini charts, we skip labels to keep them clean and readable
      
      // Set data
      lineSeries.data.setAll(data.map((val, idx) => ({
        category: labels[idx],
        value: val,
        unitLabel: unitLabel
      })));
      
      // Store chart reference
      window.userMiniCharts[userId] = root;
    } catch (e) {
      console.error(`Error creating mini chart for user ${userId}:`, e);
      if (window.userMiniCharts) {
        window.userMiniCharts[userId] = null;
      }
    }
  });
}

async function updateDateSelect() {
  try {
    const res = await api('/api/usage/dates');
    const select = $('#dateSelect');
    if (!select) {
      console.warn('dateSelect element not found');
      return;
    }
    
    // Handle both {ok: true, dates: [...]} and {dates: [...]} formats
    const dates = (res.ok && res.dates) ? res.dates : (res.dates || []);
    
    if (dates && dates.length > 0) {
      // Prefer today's date if available, otherwise use saved date or first date
      const today = new Date().toISOString().split('T')[0];
      if (!state.date) {
        state.date = dates.includes(today) ? today : dates[0];
        localStorage.setItem('usage.date', state.date);
      }
      
      select.innerHTML = dates.map(d => 
        `<option value="${d}" ${d === state.date ? 'selected' : ''}>${formatDate(d)}</option>`
      ).join('');
    } else {
      select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç</option>';
    }
  } catch (e) {
    console.error('Failed to load dates:', e);
    const select = $('#dateSelect');
    if (select) {
      select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
  }
}

function formatDate(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
}

// ==================== ONLINE ====================
let onlinePollInterval = null;
let onlineLoading = false;

/**
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç polling –¥–ª—è online –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ online –∞–∫—Ç–∏–≤–Ω–∞)
 */
function startOnlinePolling() {
  // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
  if (onlinePollInterval) {
    clearInterval(onlinePollInterval);
    onlinePollInterval = null;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ online
  const paneOnline = document.querySelector('[data-pane="online"]');
  if (!paneOnline || !paneOnline.classList.contains('active')) {
    return; // –ù–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ online - –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ –Ω–∞ –ø–∞—É–∑–µ
  if (state.livePaused) {
    return;
  }
  
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ä–∞–∑—É
  loadOnline();
  
  // –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª
  onlinePollInterval = setInterval(() => {
    // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –≤—Å—ë –µ—â—ë –Ω–∞ –≤–∫–ª–∞–¥–∫–µ online
    const paneCheck = document.querySelector('[data-pane="online"]');
    if (!paneCheck || !paneCheck.classList.contains('active') || state.livePaused) {
      stopOnlinePolling();
      return;
    }
    loadOnline();
  }, 5000);
}

/**
 * –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç polling –¥–ª—è online –¥–∞–Ω–Ω—ã—Ö
 */
function stopOnlinePolling() {
  if (onlinePollInterval) {
    clearInterval(onlinePollInterval);
    onlinePollInterval = null;
  }
}

async function loadOnline() {
  if (state.livePaused) return;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ online
  const paneOnline = document.querySelector('[data-pane="online"]');
  if (!paneOnline || !paneOnline.classList.contains('active')) {
    return; // –ù–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ online - –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º
  }
  
  // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
  if (onlineLoading) {
    return;
  }
  
  onlineLoading = true;
  
  try {
    // Load "now"
    const nowRes = await api('/api/live/now');
    if (nowRes.ok) {
      renderOnlineNow(nowRes.now, nowRes.meta);
    }
    
    // Load series for both charts
    const [connsRes, trafficRes] = await Promise.all([
      api(`/api/live/series?metric=conns&period=${state.livePeriod}&gran=${state.liveGran}&scope=${state.liveScope}`),
      api(`/api/live/series?metric=traffic&period=${state.livePeriod}&gran=${state.liveGran}&scope=${state.liveScope}`)
    ]);
    
    if (connsRes.ok && connsRes.series) {
      renderOnlineChart('conns', connsRes.series, connsRes.meta);
    }
    if (trafficRes.ok && trafficRes.series) {
      renderOnlineChart('traffic', trafficRes.series, trafficRes.meta);
    }
    
    // Load top users for today with online status
    const today = new Date().toISOString().split('T')[0];
    const topRes = await api(`/api/usage/dashboard?date=${today}&mode=daily&windowDays=1`);
    if (topRes.ok) {
      // Get online users from now data
      const onlineUsersList = nowRes?.now?.onlineUsers || [];
      renderOnlineTop(topRes, onlineUsersList);
    }
  } catch (e) {
    console.error('Online load error:', e);
  } finally {
    onlineLoading = false;
  }
}

function renderOnlineNow(now, meta) {
  if (!now || !meta) return;
  const el1 = $('#onlineUsersValue');
  const el2 = $('#onlineConnsValue');
  const el3 = $('#onlineTrafficValue');
  const el4 = $('#onlineTrafficNote');
  const el5 = $('#onlineSource');
  // Use onlineUsersCount if available, otherwise onlineUsers (for backward compatibility)
  const onlineCount = now.onlineUsersCount !== undefined ? now.onlineUsersCount : (Array.isArray(now.onlineUsers) ? now.onlineUsers.length : (now.onlineUsers || 0));
  if (el1) el1.textContent = onlineCount.toLocaleString('ru-RU');
  if (el2) el2.textContent = (now.conns || 0).toLocaleString('ru-RU');
  if (el3) {
    if (now.trafficAvailable) {
      el3.textContent = fmtBytes(now.trafficBytes || 0);
      if (el4) el4.style.display = 'none';
    } else {
      el3.textContent = '‚Äî';
      if (el4) el4.style.display = 'block';
    }
  }
  if (el5) el5.textContent = meta.source || '‚Äî';
}

let onlineConnsChart = null;
let onlineTrafficChart = null;
let onlineChartInitializing = { conns: false, traffic: false };

function renderOnlineChart(metric, series, meta) {
  const chartId = metric === 'traffic' ? 'chOnlineTraffic' : 'chOnlineConns';
  const chartVar = metric === 'traffic' ? 'onlineTrafficChart' : 'onlineConnsChart';
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
  const el = document.getElementById(chartId);
  if (!el) {
    return; // –¢–∏—Ö–∏–π –≤—ã—Ö–æ–¥, –±–µ–∑ warn
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
  if (!isRenderable(el)) {
    return; // –¢–∏—Ö–∏–π –≤—ã—Ö–æ–¥, –±–µ–∑ warn
  }
  
  if (!series || !Array.isArray(series) || series.length === 0) {
    console.warn(`renderOnlineChart(${metric}): no data`);
    return;
  }
  
  // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π
  if (onlineChartInitializing[metric]) {
    console.warn(`renderOnlineChart(${metric}): already initializing, skipping`);
    return;
  }
  
  const labels = series.map(s => {
    const d = new Date(s.ts);
    return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
  });
  const data = series.map(s => s.value || 0);
  
  const unit = meta.unit === 'bytes' ? 'bytes' : 'count';
  const label = metric === 'traffic' ? 'Traffic' : 'Connections';
  const color = metric === 'traffic' ? '#58a6ff' : '#4caf50';
  
  // Destroy existing chart if exists (–ø–µ—Ä–µ–¥ am5.ready)
  if (window[chartVar]) {
    try {
      window[chartVar].dispose();
      window[chartVar] = null;
    } catch (e) {
      console.warn(`Error disposing ${metric} chart:`, e);
      window[chartVar] = null;
    }
  }
  
  onlineChartInitializing[metric] = true;
  
  am5.ready(() => {
    try {
      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω –±—ã–ª —É–¥–∞–ª—ë–Ω)
      const elCheck = document.getElementById(chartId);
      if (!elCheck || elCheck !== el) {
        console.warn(`renderOnlineChart(${metric}): element changed or removed`);
        onlineChartInitializing[metric] = false;
        return;
      }
      
      // Create root element
      const root = am5.Root.new(elCheck);
      root.setThemes([
        am5themes_Animated.new(root)
      ]);
      
      // Create chart
      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "none",
        wheelY: "none",
        paddingLeft: 0,
        paddingRight: 0
      }));
      
      // Create axes
      const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "category",
        renderer: am5xy.AxisRendererX.new(root, {
          minGridDistance: 30
        })
      }));
      
      xAxis.data.setAll(labels.map((label, idx) => ({
        category: label
      })));
      
      const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererY.new(root, {})
      }));
      
      // Create series
      // Convert hex color to rgba
      const hexToRgba = (hex, alpha) => {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      };
      
      const lineSeries = chart.series.push(am5xy.LineSeries.new(root, {
        name: label,
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: "value",
        categoryXField: "category",
        stroke: am5.color(color),
        fill: am5.color(hexToRgba(color, 0.3))
      }));
      
      lineSeries.fills.template.setAll({
        fillOpacity: 0.3,
        visible: true
      });
      
      lineSeries.strokes.template.setAll({
        strokeWidth: 3
      });
      
      lineSeries.bullets.push(() => {
        return am5.Bullet.new(root, {
          sprite: am5.Circle.new(root, {
            radius: 4,
            fill: am5.color(color),
            stroke: am5.color("#fff"),
            strokeWidth: 2
          })
        });
      });
      
      // Set data
      lineSeries.data.setAll(data.map((val, idx) => ({
        category: labels[idx],
        value: val,
        unit: unit,
        label: label
      })));
      
      // Add cursor
      chart.set("cursor", am5xy.XYCursor.new(root, {}));
      
      window[chartVar] = root;
      onlineChartInitializing[metric] = false;
    } catch (e) {
      console.error(`Error creating ${metric} chart:`, e);
      window[chartVar] = null;
      onlineChartInitializing[metric] = false;
    }
  });
}

function renderOnlineTop(dashboardData, onlineUsers) {
  if (!dashboardData || !dashboardData.users) {
    $('#tblOnlineTop tbody').innerHTML = '<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    return;
  }
  
  const users = dashboardData.users || [];
  const onlineUsersSet = new Set(onlineUsers || []);
  const userDetails = dashboardData.userDetails || {};
  
  // Build user list with today's data
  // users is an array of objects with userId, displayName, traffic7dBytes, conns7d, etc.
  // For today's data, we need to get from userDetails which has daily data
  const userList = users.map(userData => {
    const userId = userData.userId;
    const details = userDetails[userId] || {};
    
    // Get today's data from trends (last day in the array)
    const trafficTrend = details.trafficDailyBytes || [];
    const connsTrend = details.connsDaily || [];
    const userTodayTraffic = trafficTrend.length > 0 ? trafficTrend[trafficTrend.length - 1] : 0;
    const userTodayConns = connsTrend.length > 0 ? connsTrend[connsTrend.length - 1] : 0;
    
    const isOnline = onlineUsersSet.has(userId);
    
    return {
      userId: userId,
      displayName: userData.displayName || userId,
      traffic: userTodayTraffic,
      conns: userTodayConns,
      isOnline
    };
  }).filter(u => u.traffic > 0 || u.conns > 0 || u.isOnline) // Show only users with activity or online
    .sort((a, b) => {
      // Sort: online first, then by traffic
      if (a.isOnline && !b.isOnline) return -1;
      if (!a.isOnline && b.isOnline) return 1;
      return (b.traffic || 0) - (a.traffic || 0);
    });
  
  const html = userList.length > 0 ? userList.map(r => `
    <tr>
      <td>${r.displayName || r.userId}</td>
      <td>${r.isOnline ? '<span style="color: var(--ok);">üü¢ –û–Ω–ª–∞–π–Ω</span>' : '<span style="color: var(--muted);">‚ö™ –û—Ñ–ª–∞–π–Ω</span>'}</td>
      <td>${fmtBytes(r.traffic || 0)}</td>
      <td>${(r.conns || 0).toLocaleString('ru-RU')}</td>
    </tr>
  `).join('') : '<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
  
  $('#tblOnlineTop tbody').innerHTML = html;
}

// ==================== STATUS ====================
async function loadStatus() {
  try {
    const res = await api('/api/system/status');
    if (res.ok) {
      const s = res.services || {};
      const html = `
        <div class="card">
          <h4>UI Service</h4>
          <p>Name: ${s.ui?.name || '‚Äî'}</p>
          <p>Active: ${s.ui?.active ? '‚úÖ' : '‚ùå'}</p>
          <p>State: ${s.ui?.state || '‚Äî'}</p>
        </div>
        <div class="card">
          <h4>Xray Service</h4>
          <p>Name: ${s.xray?.name || '‚Äî'}</p>
          <p>Active: ${s.xray?.active ? '‚úÖ' : '‚ùå'}</p>
          <p>State: ${s.xray?.state || '‚Äî'}</p>
        </div>
      `;
      $('#statusContent').innerHTML = html;
    }
  } catch (e) {
    console.error('Status load error:', e);
  }
}

// ==================== RESTART ====================
function loadRestart() {
  $('#btnRestartUI').onclick = async () => {
    if (!await modal('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å UI —Å–µ—Ä–≤–∏—Å?')) return;
    try {
      const res = await api('/api/system/restart?target=ui', { method: 'POST' });
      if (res.ok) {
        showToast('‚úÖ', 'UI –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω');
      }
    } catch (e) {
      showToast('‚ùå', '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞');
    }
  };
  
  $('#btnRestartXray').onclick = async () => {
    if (!await modal('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Xray —Å–µ—Ä–≤–∏—Å?')) return;
    try {
      const res = await api('/api/system/restart?target=xray', { method: 'POST' });
      if (res.ok) {
        showToast('‚úÖ', 'Xray –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω');
      }
    } catch (e) {
      showToast('‚ùå', '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞');
    }
  };
}

// ==================== JOURNAL ====================
async function loadJournal() {
  const target = $('#journalTarget').value || 'xray';
  try {
    const res = await api(`/api/system/journal?target=${target}&limit=200`);
    if (res.ok) {
      $('#journalContent').textContent = res.journal || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    }
  } catch (e) {
    console.error('Journal load error:', e);
  }
  
  $('#journalTarget').onchange = loadJournal;
}

// ==================== OLD DASHBOARD (legacy) ====================
async function loadDashboard() {
  // Legacy function, redirect to management
  setNav('management');
}

function renderDashboard(data) {
  const kpi = data.kpi || {};
  const global = data.global || {};
  const usersObj = data.users || {};
  const meta = data.meta || {};
  
  // Convert users object to array, sorted by sum7_traffic_bytes
  const usersArray = Object.values(usersObj).sort((a, b) => 
    (b.sum7_traffic_bytes || 0) - (a.sum7_traffic_bytes || 0)
  );
  
  // Top users for today (from last day of daily_traffic_bytes)
  const todayTraffic = global.daily_traffic_bytes || [];
  const todayIdx = todayTraffic.length - 1;
  const todayUsers = usersArray
    .map(u => ({
      email: u.email,
      bytes: (u.daily_traffic_bytes || [])[todayIdx] || 0
    }))
    .sort((a, b) => b.bytes - a.bytes)
    .slice(0, 5);
  
  // KPI Cards with icons and top users
  const changeColor = kpi.change_pct >= 0 ? 'var(--ok)' : 'var(--bad)';
  const changePct = kpi.change_pct !== null ? `${kpi.change_pct >= 0 ? '+' : ''}${kpi.change_pct.toFixed(1)}%` : '‚Äî';
  
  const topUsersHtml = todayUsers.length > 0 ? `
    <div style="margin-top:12px;font-size:12px;">
      <div style="color:var(--muted);margin-bottom:6px;">Top-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</div>
      ${todayUsers.map((u, idx) => `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <span style="color:var(--text);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%;">${u.email}</span>
          <span style="color:var(--text);font-weight:600;white-space:nowrap;">${fmtBytes(u.bytes || 0)}</span>
        </div>
      `).join('')}
    </div>
  ` : '';
  
  // Top domains for KPI
  const topDomainsTraffic = (global.top_domains_traffic || []).slice(0, 3);
  const topDomainsConns = (global.top_domains_conns || []).slice(0, 3);
  
  $('#kpiGrid').innerHTML = `
    <div class="kpi-card" style="border-left: 4px solid var(--accent);">
      <div class="kpi-label">üìä ${t('todayTraffic')}</div>
      <div class="kpi-value" style="color:var(--accent);">${fmtBytes(kpi.today_bytes)}</div>
      <div class="kpi-change ${kpi.change_pct >= 0 ? 'up' : 'down'}" style="color:${changeColor};">
        ${changePct}
        <span style="font-size:11px;color:var(--muted);margin-left:8px;">vs –≤—á–µ—Ä–∞</span>
      </div>
      ${topUsersHtml}
    </div>
    <div class="kpi-card" style="border-left: 4px solid var(--muted);">
      <div class="kpi-label">üìÖ ${t('yesterdayTraffic')}</div>
      <div class="kpi-value">${fmtBytes(kpi.yesterday_bytes)}</div>
    </div>
    <div class="kpi-card" style="border-left: 4px solid var(--ok);">
      <div class="kpi-label">üíæ ${t('totalTraffic')}</div>
      <div class="kpi-value" style="color:var(--ok);">${fmtBytes(kpi.total_bytes)}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:4px;">–∑–∞ –ø–µ—Ä–∏–æ–¥</div>
    </div>
    <div class="kpi-card" style="border-left: 4px solid var(--warn);">
      <div class="kpi-label">üë• ${t('activeUsers')}</div>
      <div class="kpi-value" style="color:var(--warn);">${kpi.active_users || 0} <span style="font-size:16px;color:var(--muted);">/ ${kpi.total_users || 0}</span></div>
    </div>
    <div class="kpi-card" style="border-left: 4px solid ${data.collector?.lag_days > 1 ? 'var(--bad)' : 'var(--ok)'};">
      <div class="kpi-label">‚è±Ô∏è ${t('collectorLag')}</div>
      <div class="kpi-value ${data.collector?.lag_days > 1 ? 'text-warn' : 'text-ok'}">${data.collector?.lag_days ?? '‚Äî'} <span style="font-size:14px;">–¥–Ω.</span></div>
    </div>
    ${topDomainsTraffic.length > 0 ? `
    <div class="kpi-card" style="border-left: 4px solid var(--accent);">
      <div class="kpi-label">üåê –¢–æ–ø –¥–æ–º–µ–Ω—ã (7–¥) - —Ç—Ä–∞—Ñ–∏–∫</div>
      <div style="margin-top:8px;font-size:12px;">
        ${topDomainsTraffic.map((d, idx) => `
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%;">${idx + 1}. ${d.domain}</span>
            <span style="color:var(--text);font-weight:600;white-space:nowrap;">${fmtBytes(d.value)}</span>
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}
    ${topDomainsConns.length > 0 ? `
    <div class="kpi-card" style="border-left: 4px solid var(--warn);">
      <div class="kpi-label">üåê –¢–æ–ø –¥–æ–º–µ–Ω—ã (7–¥) - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
      <div style="margin-top:8px;font-size:12px;">
        ${topDomainsConns.map((d, idx) => `
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%;">${idx + 1}. ${d.domain}</span>
            <span style="color:var(--text);font-weight:600;white-space:nowrap;">${d.value.toLocaleString()}</span>
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}
  `;
  
  // Chart - use global.daily_traffic_bytes with meta.days as labels
  const days = meta.days || [];
  const dailyData = global.daily_traffic_bytes || [];
  const chartData = days.map((d, i) => ({
    date: d,
    bytes: dailyData[i] || 0
  }));
  renderChart(chartData);
  
  // Top Users Table with progress bars
  const totalBytes = usersArray.reduce((sum, u) => sum + (u.sum7_traffic_bytes || 0), 0);
  const tbody = $('#topUsersTable tbody');
  tbody.innerHTML = usersArray.slice(0, 20).map((u, idx) => {
    const pct = totalBytes > 0 ? ((u.sum7_traffic_bytes || 0) / totalBytes * 100) : 0;
    return `
      <tr>
        <td style="text-align:center;color:var(--muted);">${idx + 1}</td>
        <td><strong class="mono">${u.email}</strong></td>
        <td><strong>${fmtBytes(u.sum7_traffic_bytes || 0)}</strong></td>
        <td>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${pct}%;">${pct.toFixed(1)}%</div>
          </div>
        </td>
        <td style="text-align:center;">${(u.daily_traffic_bytes || []).filter(x => x > 0).length}</td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="5" class="muted" style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
  
  // Store for other functions
  state.dashboard = data;
}

let chartInstance = null;

function renderChart(perDay) {
  const el = $('#trafficChart');
  if (!el) return;
  
  if (chartInstance) {
    try {
      chartInstance.dispose();
    } catch (e) {
      console.warn('Error disposing legacy chart:', e);
    }
    chartInstance = null;
  }
  
  if (!perDay || !perDay.length) {
    el.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</div>';
    return;
  }
  
  const labels = perDay.map(d => d.date.slice(5)); // MM-DD
  const data = perDay.map(d => d.bytes);
  const maxValue = Math.max(...data, 1);
  
  am5.ready(() => {
    try {
      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
      const elCheck = $('#trafficChart');
      if (!elCheck || elCheck !== el) {
        console.warn('renderChart: element changed or not found');
        return;
      }
      
      // Create root element
      const root = am5.Root.new(elCheck);
      root.setThemes([
        am5themes_Animated.new(root)
      ]);
      
      // Create chart
      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "none",
        wheelY: "none",
        paddingLeft: 0,
        paddingRight: 0
      }));
      
      // Create axes
      const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "category",
        renderer: am5xy.AxisRendererX.new(root, {
          cellStartLocation: 0.1,
          cellEndLocation: 0.9,
          minGridDistance: 30
        })
      }));
      
      xAxis.data.setAll(labels.map((label, idx) => ({
        category: label
      })));
      
      const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererY.new(root, {})
      }));
      
      // Create series
      const series = chart.series.push(am5xy.ColumnSeries.new(root, {
        name: '–¢—Ä–∞—Ñ–∏–∫',
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: "value",
        categoryXField: "category"
      }));
      
      // Configure columns
      series.columns.template.setAll({
        tooltipY: 0,
        strokeOpacity: 0,
        cornerRadiusTL: 8,
        cornerRadiusTR: 8,
        cornerRadiusBL: 8,
        cornerRadiusBR: 8
      });
      
      // Custom tooltip formatter
      series.columns.template.adapters.add("tooltipText", (text, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const value = dataItem.get("valueY");
          const category = dataItem.get("categoryX");
          return `${category}: ${fmtBytes(value)}`;
        }
        return text;
      });
      
      // Dynamic fill color
      series.columns.template.adapters.add("fill", (fill, target) => {
        const dataItem = target.dataItem;
        if (dataItem) {
          const value = dataItem.get("valueY");
          const ratio = maxValue > 0 ? value / maxValue : 0;
          const opacity = 0.4 + ratio * 0.4;
          return am5.color(`rgba(88, 166, 255, ${opacity})`);
        }
        return fill;
      });
      
      // Labels added via bullets for ColumnSeries
      series.bullets.push(function() {
        const label = am5.Label.new(root, {
          text: "{valueY}",
          fill: amColorVar("--text"),
          centerY: 0,
          centerX: am5.p50,
          fontSize: 10,
          fontWeight: "bold",
          dy: -5
        });
        // Custom text formatting
        label.adapters.add("text", (text, target) => {
          const dataItem = target.dataItem;
          if (dataItem) {
            const value = dataItem.get("valueY");
            return fmtBytes(value);
          }
          return text;
        });
        return am5.Bullet.new(root, {
          locationY: 1,
          sprite: label
        });
      });
      
      // Set data
      series.data.setAll(data.map((val, idx) => ({
        category: labels[idx],
        value: val
      })));
      
      // Add cursor
      chart.set("cursor", am5xy.XYCursor.new(root, {}));
      
      chartInstance = root;
    } catch (e) {
      console.error('Error creating legacy chart:', e);
      chartInstance = null;
    }
  });
}

// ==================== USERS ====================
async function loadUsers() {
  try {
    // Load users first (required)
    const usersRes = await api('/api/users');
    state.users = usersRes.users || [];
    
    // Try to load stats (optional - if fails, just show users without stats)
    let statsMap = {};
    try {
      const statsRes = await api('/api/users/stats');
      if (statsRes && statsRes.users) {
        statsRes.users.forEach(s => {
          statsMap[s.email] = s;
        });
      }
    } catch (statsError) {
      console.warn('Failed to load user stats, continuing without stats:', statsError);
      // Continue without stats - users will be shown with default values
    }
    
    renderUsers(state.users, statsMap);
  } catch (e) {
    console.error('Users load error:', e);
    showToast('‚ùå', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + (e.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    // Show empty table on error
    const tbody = $('#usersTable tbody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="7" class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    }
  }
}

function renderUsers(users, statsMap = {}) {
  const tbody = $('#usersTable tbody');
  if (!users || users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="muted">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
    return;
  }
  
  tbody.innerHTML = users.map(u => {
    const stats = statsMap[u.email] || {};
    const alias = stats.alias || u.alias || '';
    const displayName = alias || u.email;
    const daysUsed = stats.daysUsed || 0;
    const totalTraffic = stats.totalTrafficBytes || 0;
    const top3Domains = stats.top3Domains || [];
    const isOnline = stats.isOnline || false;
    
    // Format top 3 domains
    let top3Html = '‚Äî';
    if (top3Domains.length > 0) {
      top3Html = top3Domains.map(d => {
        const trafficGB = (d.trafficBytes / 1000000000).toFixed(2);
        return `<span style="display: inline-block; margin-right: 8px;" title="${d.domain}: ${trafficGB} GB (${d.sharePct}%)">${escapeHtml(d.domain)}</span>`;
      }).join('');
    }
    
    // Status indicator
    const statusHtml = isOnline 
      ? '<span style="color: var(--ok);">üü¢ –û–Ω–ª–∞–π–Ω</span>' 
      : '<span style="color: var(--muted);">‚ö™ –û—Ñ–ª–∞–π–Ω</span>';
    
    return `
    <tr>
      <td>
        <span class="user-name" data-email="${u.email}" style="cursor: pointer; position: relative;">
          <strong>${escapeHtml(displayName)}</strong>
          <span style="margin-left: 4px; opacity: 0.6; font-size: 10px;" onclick="event.stopPropagation(); editUserAlias('${u.email}', '${escapeHtml(alias)}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å alias">‚úèÔ∏è</span>
        </span>
      </td>
      <td class="mono" style="font-size:11px;">${u.uuid}</td>
      <td style="font-size:11px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${top3Domains.map(d => `${d.domain}: ${(d.trafficBytes / 1000000000).toFixed(2)} GB (${d.sharePct}%)`).join('\\n')}">${top3Html}</td>
      <td style="text-align: center;">${daysUsed}</td>
      <td>${fmtBytes(totalTraffic)}</td>
      <td>${statusHtml}</td>
      <td>
        <div class="flex gap-8">
          <button class="btn" onclick="copyUserLink('${u.email}')" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å VLESS —Å—Å—ã–ª–∫—É">üîó ${t('getLink')}</button>
          <button class="btn" onclick="kickUser('${u.email}')" title="–û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–º–µ–Ω–∏—Ç—å UUID)">üîÑ ${t('kick')}</button>
          <button class="btn danger" onclick="deleteUser('${u.email}')" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–≤—Å–µ–≥–¥–∞">üóëÔ∏è ${t('delete')}</button>
        </div>
      </td>
    </tr>
  `;
  }).join('');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function addUser() {
  const email = await modal(t('addUser'), '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (email):', '<input type="text" id="newUserEmail" placeholder="user_12" style="width:100%;">');
  if (!email) return;
  
  try {
    await api('/api/users/add', {
      method: 'POST',
      body: JSON.stringify({ email })
    });
    showToast('‚úÖ', t('userAdded'));
    loadUsers();
    loadDashboard();
  } catch (e) {}
}

async function copyUserLink(email) {
  try {
    const res = await api(`/api/users/link?email=${encodeURIComponent(email)}`);
    if (res.ok && res.link) {
      // Copy to clipboard
      await navigator.clipboard.writeText(res.link);
      showToast('‚úÖ', '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
    } else {
      showToast('‚ùå', res.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏');
    }
  } catch (e) {
    console.error('Copy link error:', e);
    showToast('‚ùå', '–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏');
  }
}

async function deleteUser(email) {
  const confirmed = await modal(
    '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ–æ–±—Ä–∞—Ç–∏–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ',
    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${email}"?<br><br><strong style="color: var(--bad);">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</strong><br>UUID –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.`,
    '',
    '–û—Ç–º–µ–Ω–∞',
    '–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞'
  );
  if (!confirmed) return;
  
  try {
    const res = await api('/api/users/delete', {
      method: 'POST',
      body: JSON.stringify({ email })
    });
    if (res.ok) {
      showToast('‚úÖ', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω');
      loadUsers();
      loadDashboard();
    } else {
      showToast('‚ùå', res.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
  } catch (e) {
    console.error('Delete user error:', e);
    showToast('‚ùå', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
  }
}

async function kickUser(email) {
  const confirmed = await modal(
    '–û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${email}"?<br><br>–¢–µ–∫—É—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±—É–¥—É—Ç —Ä–∞–∑–æ—Ä–≤–∞–Ω—ã, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞ –ø–æ —Ç–æ–π –∂–µ —Å—Å—ã–ª–∫–µ (UUID –±—É–¥–µ—Ç –∏–∑–º–µ–Ω—ë–Ω, –Ω–æ —Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ–π).`,
    '',
    '–û—Ç–º–µ–Ω–∞',
    '–ö–∏–∫–Ω—É—Ç—å'
  );
  if (!confirmed) return;
  
  try {
    const res = await api('/api/users/kick', {
      method: 'POST',
      body: JSON.stringify({ email })
    });
    if (res.ok) {
      showToast('‚úÖ', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á—ë–Ω');
      loadUsers();
    } else {
      showToast('‚ùå', res.error || '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è');
    }
  } catch (e) {
    console.error('Kick user error:', e);
    showToast('‚ùå', '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
  }
}

async function editUserAlias(email, currentAlias) {
  const alias = await modal(
    '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å Alias',
    `–í–≤–µ–¥–∏—Ç–µ alias –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${email}":`,
    `<input type="text" id="userAliasInput" placeholder="–í–≤–µ–¥–∏—Ç–µ alias (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º)" value="${escapeHtml(currentAlias)}" style="width:100%;">`,
    '–û—Ç–º–µ–Ω–∞',
    '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    false
  );
  
  if (alias === null) return; // Cancelled
  
  const aliasInput = document.getElementById('userAliasInput');
  const newAlias = aliasInput ? aliasInput.value.trim() : '';
  
  try {
    const res = await api('/api/users/update-alias', {
      method: 'POST',
      body: JSON.stringify({ email, alias: newAlias })
    });
    if (res.ok) {
      showToast('‚úÖ', 'Alias –æ–±–Ω–æ–≤–ª—ë–Ω');
      loadUsers();
    } else {
      showToast('‚ùå', res.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è alias');
    }
  } catch (e) {
    console.error('Update alias error:', e);
    showToast('‚ùå', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è alias');
  }
}

// Legacy function - redirect to copyUserLink
async function getLink(email) {
  return copyUserLink(email);
}

// ==================== EVENTS ====================
async function loadEvents() {
  try {
    const filter = $('#eventsFilter').value.trim();
    const url = filter ? `/api/events?text=${encodeURIComponent(filter)}` : '/api/events';
    const data = await api(url);
    renderEvents(data.events || []);
  } catch (e) {
    console.error('Events load error:', e);
  }
}

function renderEvents(events) {
  const tbody = $('#eventsTable tbody');
  
  function interpretEvent(e) {
    const type = e.type || 'UNKNOWN';
    const action = e.action || '';
    const severity = e.severity || 'INFO';
    
    let interpretation = '';
    let icon = 'üìã';
    
    if (type === 'USER') {
      if (action.includes('add')) {
        interpretation = `–î–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${e.email || e.userId || '‚Äî'}`;
        icon = '‚ûï';
      } else if (action.includes('delete')) {
        interpretation = `–£–¥–∞–ª—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${e.email || e.userId || '‚Äî'}`;
        icon = 'üóëÔ∏è';
      } else if (action.includes('kick')) {
        interpretation = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á—ë–Ω (UUID –∏–∑–º–µ–Ω—ë–Ω): ${e.email || e.userId || '‚Äî'}`;
        icon = 'üîÑ';
      } else {
        interpretation = `–î–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: ${action}`;
      }
    } else if (type === 'SYSTEM') {
      if (action.includes('restart')) {
        interpretation = `–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞: ${e.target || '‚Äî'}`;
        icon = '‚ö°';
      } else {
        interpretation = `–°–∏—Å—Ç–µ–º–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${action}`;
      }
    } else if (type === 'SETTINGS') {
      interpretation = `–ò–∑–º–µ–Ω–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ${action}`;
      icon = '‚öôÔ∏è';
    } else if (type === 'XRAY') {
      interpretation = `–î–µ–π—Å—Ç–≤–∏–µ —Å Xray: ${action}`;
      icon = 'üîß';
    } else {
      interpretation = `${type}: ${action}`;
    }
    
    return { interpretation, icon, severity };
  }
  
  tbody.innerHTML = events.slice(0, 100).map(e => {
    const { interpretation, icon, severity } = interpretEvent(e);
    const severityClass = severity === 'ERROR' ? 'bad' : severity === 'WARN' ? 'warn' : 'ok';
    
    return `
      <tr>
        <td class="mono" style="font-size:11px;">${fmtDate(e.ts)}</td>
        <td><span class="badge ${severityClass}">${e.type || '‚Äî'}</span></td>
        <td>${icon} ${interpretation}</td>
        <td class="muted" style="font-size:11px;">${e.action || '‚Äî'}</td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="4" class="muted">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</td></tr>';
}

// ==================== XRAY ====================
async function loadXrayConfig() {
  try {
    const data = await api('/api/xray/config');
    $('#xrayConfig').value = JSON.stringify(data.config, null, 2);
    
    const reality = data.reality || {};
    $('#realityParams').textContent = `pbk: ${reality.pbk || '(–Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω)'}
sni: ${reality.sni || '‚Äî'}
sid: ${reality.sid || '‚Äî'}
port: ${reality.port || 443}
server_host: ${reality.server_host || '(–Ω–µ –∑–∞–¥–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)'}`;
  } catch (e) {
    console.error('Xray config load error:', e);
  }
}

async function restartXray() {
  const ok = await modal('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Xray', 'Xray –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω. –í—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±–æ—Ä–≤—É—Ç—Å—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
  if (!ok) return;
  
  try {
    await api('/api/xray/restart', { method: 'POST', body: '{}' });
    showToast('‚úÖ', 'Xray –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω');
    loadSystemStatus();
  } catch (e) {}
}

// ==================== SETTINGS ====================
async function loadSettings() {
  try {
    const data = await api('/api/settings');
    state.settings = data.settings;
    
    $('#setServerHost').value = state.settings.xray?.server_host || '';
    $('#setPbk').value = state.settings.xray?.reality_pbk || '';
    $('#setUsageDir').value = state.settings.collector?.usage_dir || '/var/log/xray/usage';
    
    // Collector status (read-only, no auto-toggle)
    try {
      const collector = await api('/api/collector/status');
      if (collector && collector.ok !== false) {
        $('#collectorStatus').innerHTML = `
          <div class="form-row">
            <span>–°—Ç–∞—Ç—É—Å: <strong>${collector.enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω'}</strong></span>
            <span>–§–∞–π–ª–æ–≤: <strong>${collector.files_count || 0}</strong></span>
            <span>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª: <strong>${collector.newest_file || '‚Äî'}</strong></span>
            <span>–õ–∞–≥: <strong class="${collector.lag_days > 1 ? 'text-warn' : ''}">${collector.lag_days ?? '‚Äî'} –¥–Ω–µ–π</strong></span>
          </div>
        `;
      } else {
        $('#collectorStatus').innerHTML = '<div class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–±–æ—Ä—â–∏–∫–∞</div>';
      }
    } catch (e) {
      $('#collectorStatus').innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–±–æ—Ä—â–∏–∫–∞</div>';
    }
  } catch (e) {
    console.error('Settings load error:', e);
  }
}

async function saveSettings() {
  try {
    const settings = {
      xray: {
        server_host: $('#setServerHost').value.trim(),
        reality_pbk: $('#setPbk').value.trim(),
      },
      collector: {
        usage_dir: $('#setUsageDir').value.trim(),
      }
    };
    
    await api('/api/settings', {
      method: 'POST',
      body: JSON.stringify(settings)
    });
    
    showToast('‚úÖ', t('settingsSaved'));
  } catch (e) {}
}

// ==================== SYSTEM STATUS ====================
async function loadSystemStatus() {
  try {
    const data = await api('/api/system/status');
    
    // Compact status: show only state, no "UI:" or "Xray:" prefix
    $('#statusUI').textContent = data.ui?.state || '‚Äî';
    $('#dotUI').className = 'dot ' + (data.ui?.active ? 'ok' : 'bad');
    
    $('#statusXray').textContent = data.xray?.state || '‚Äî';
    $('#dotXray').className = 'dot ' + (data.xray?.active ? 'ok' : 'bad');
  } catch (e) {
    console.error('Status load error:', e);
  }
}

// ==================== INIT ====================
let initCalled = false;
async function init() {
  if (initCalled) {
    console.warn('init() already called, skipping');
    return;
  }
  initCalled = true;
  
  // Theme
  const savedTheme = localStorage.getItem('theme') || 'dark';
  setTheme(savedTheme);
  
  // Lang
  const savedLang = localStorage.getItem('lang') || 'ru';
  state.lang = savedLang;
  const langToggle = $('#langToggle');
  if (langToggle) langToggle.textContent = savedLang.toUpperCase();
  applyI18n();
  
  // Event handlers for tabs (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –°–æ–±—ã—Ç–∏—è, Xray, –ù–∞—Å—Ç—Ä–æ–π–∫–∏)
  const tabsContainer = document.querySelector('.tabs');
  if (tabsContainer) {
    tabsContainer.addEventListener('click', (e) => {
      const tab = e.target.closest('.tab');
      if (tab && tab.dataset && tab.dataset.tab) {
        e.preventDefault();
        e.stopPropagation();
        setTab(tab.dataset.tab);
      }
    });
  } else {
    // Fallback: direct handlers
    const tabs = $$('.tab');
    if (tabs.length > 0) {
      tabs.forEach(tab => {
        if (tab && tab.dataset && tab.dataset.tab) {
          tab.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            setTab(tab.dataset.tab);
          };
        }
      });
    }
  }
  
  const themeToggle = $('#themeToggle');
  if (themeToggle) {
    themeToggle.onclick = () => {
      setTheme(state.theme === 'dark' ? 'light' : 'dark');
    };
  }
  
  if (langToggle) {
    langToggle.onclick = () => {
      state.lang = state.lang === 'ru' ? 'en' : 'ru';
      localStorage.setItem('lang', state.lang);
      langToggle.textContent = state.lang.toUpperCase();
      applyI18n();
      loadDashboard();
    };
  }
  
  // User management buttons
  const btnAddUser = $('#btnAddUser');
  if (btnAddUser) btnAddUser.onclick = addUser;
  const btnRefreshUsers = $('#btnRefreshUsers');
  if (btnRefreshUsers) btnRefreshUsers.onclick = loadUsers;
  const btnRefreshEvents = $('#btnRefreshEvents');
  if (btnRefreshEvents) btnRefreshEvents.onclick = loadEvents;
  const eventsFilter = $('#eventsFilter');
  if (eventsFilter) {
    eventsFilter.onkeyup = (e) => { if (e.key === 'Enter') loadEvents(); };
  }
  const btnReloadXray = $('#btnReloadXray');
  if (btnReloadXray) btnReloadXray.onclick = loadXrayConfig;
  const btnRestartXray = $('#btnRestartXray');
  if (btnRestartXray) btnRestartXray.onclick = restartXray;
  const btnSaveSettings = $('#btnSaveSettings');
  if (btnSaveSettings) btnSaveSettings.onclick = saveSettings;
  const btnReloadSettings = $('#btnReloadSettings');
  if (btnReloadSettings) btnReloadSettings.onclick = loadSettings;
  // Navigation pills - use event delegation
  const navContainer = document.querySelector('.nav-pills') || document.querySelector('.header-right');
  if (navContainer) {
    navContainer.addEventListener('click', (e) => {
      const pill = e.target.closest('.nav-pill');
      if (pill && pill.dataset && pill.dataset.nav) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Nav pill clicked:', pill.dataset.nav);
        setNav(pill.dataset.nav);
      }
    });
  }
  
  // Date select
  const dateSelect = $('#dateSelect');
  if (dateSelect) {
    dateSelect.onchange = () => {
      state.date = dateSelect.value;
      localStorage.setItem('usage.date', state.date);
      loadManagement();
    };
  } else {
    console.warn('dateSelect element not found');
  }
  
  // Segmented controls - use event delegation
  document.addEventListener('click', (e) => {
    // Daily/Cumulative
    if (e.target.id === 'segDaily' || e.target.id === 'segCum') {
      e.preventDefault();
      e.stopPropagation();
      const isDaily = e.target.id === 'segDaily';
      state.mode = isDaily ? 'daily' : 'cumulative';
      localStorage.setItem('usage.mode', state.mode);
      const segDaily = $('#segDaily');
      const segCum = $('#segCum');
      if (segDaily && segCum) {
        if (isDaily) {
          segDaily.classList.add('active');
          segCum.classList.remove('active');
        } else {
          segCum.classList.add('active');
          segDaily.classList.remove('active');
        }
      }
      loadManagement();
      return;
    }
    
    // Dark/Light
    if (e.target.id === 'segDark' || e.target.id === 'segLight') {
      e.preventDefault();
      e.stopPropagation();
      const isDark = e.target.id === 'segDark';
      setTheme(isDark ? 'dark' : 'light');
      const segDark = $('#segDark');
      const segLight = $('#segLight');
      if (segDark && segLight) {
        if (isDark) {
          segDark.classList.add('active');
          segLight.classList.remove('active');
        } else {
          segLight.classList.add('active');
          segDark.classList.remove('active');
        }
      }
      return;
    }
    
    // GB/MB
    if (e.target.id === 'segGB' || e.target.id === 'segMB') {
      e.preventDefault();
      e.stopPropagation();
      const isGB = e.target.id === 'segGB';
      state.unit = isGB ? 'gb' : 'mb';
      localStorage.setItem('ui.unit', state.unit);
      const segGB = $('#segGB');
      const segMB = $('#segMB');
      if (segGB && segMB) {
        if (isGB) {
          segGB.classList.add('active');
          segMB.classList.remove('active');
        } else {
          segMB.classList.add('active');
          segGB.classList.remove('active');
        }
      }
      if (state.dashboard) renderManagement(state.dashboard);
      return;
    }
    
    // Users: Traffic/Conns comparison toggle
    if (e.target.id === 'segCmpTraffic' || e.target.id === 'segCmpConns') {
      e.preventDefault();
      e.stopPropagation();
      const isTraffic = e.target.id === 'segCmpTraffic';
      state.mainMetric = isTraffic ? 'traffic' : 'conns';
      localStorage.setItem('users.mainMetric', state.mainMetric);
      const segCmpTraffic = $('#segCmpTraffic');
      const segCmpConns = $('#segCmpConns');
      if (segCmpTraffic && segCmpConns) {
        if (isTraffic) {
          segCmpTraffic.classList.add('active');
          segCmpConns.classList.remove('active');
        } else {
          segCmpConns.classList.add('active');
          segCmpTraffic.classList.remove('active');
        }
      }
      // Re-render users section with new metric
      if (state.dashboard && state.dashboard.users && state.dashboard.userDetails) {
        renderUsersSection(state.dashboard.users, state.dashboard.userDetails, 
                          state.selectedUsers, state.mainMetric, state.miniMetric, state.mode, state.unit);
      }
      return;
    }
    
    // Users: Mini Traffic/Conns toggle
    if (e.target.id === 'segMiniTraffic' || e.target.id === 'segMiniConns') {
      e.preventDefault();
      e.stopPropagation();
      const isTraffic = e.target.id === 'segMiniTraffic';
      state.miniMetric = isTraffic ? 'traffic' : 'conns';
      localStorage.setItem('users.miniMetric', state.miniMetric);
      const segMiniTraffic = $('#segMiniTraffic');
      const segMiniConns = $('#segMiniConns');
      if (segMiniTraffic && segMiniConns) {
        if (isTraffic) {
          segMiniTraffic.classList.add('active');
          segMiniConns.classList.remove('active');
        } else {
          segMiniConns.classList.add('active');
          segMiniTraffic.classList.remove('active');
        }
      }
      // Re-render users section with new metric
      if (state.dashboard && state.dashboard.users && state.dashboard.userDetails) {
        renderUsersSection(state.dashboard.users, state.dashboard.userDetails, 
                          state.selectedUsers, state.mainMetric, state.miniMetric, state.mode, state.unit);
      }
      return;
    }
  });
  
  // Segmented controls handlers are already set via event delegation above
  // Just initialize visual state here
  
  // Legacy handlers (if elements exist)
  const btnRefreshDashboard = $('#btnRefreshDashboard');
  if (btnRefreshDashboard) btnRefreshDashboard.onclick = () => loadManagement();
  const periodSelect = $('#periodSelect');
  if (periodSelect) periodSelect.onchange = () => loadManagement();
  
  // Online pause button
  const btnPause = $('#btnPause');
  if (btnPause) {
    btnPause.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      state.livePaused = !state.livePaused;
      localStorage.setItem('live.paused', state.livePaused);
      btnPause.textContent = state.livePaused ? 'Resume' : 'Pause';
      if (state.livePaused) {
        stopOnlinePolling();
      } else {
        // Resume - –∑–∞–ø—É—Å—Ç–∏—Ç—å polling —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ online
        const paneOnline = document.querySelector('[data-pane="online"]');
        if (paneOnline && paneOnline.classList.contains('active')) {
          startOnlinePolling();
        }
      }
    };
  }
  
  // Initialize theme/unit/mode from state (with null checks)
  const segDark = $('#segDark');
  const segLight = $('#segLight');
  if (segDark && segLight) {
    if (state.theme === 'dark') {
      segDark.classList.add('active');
      segLight.classList.remove('active');
    } else {
      segLight.classList.add('active');
      segDark.classList.remove('active');
    }
  }
  
  const segGB = $('#segGB');
  const segMB = $('#segMB');
  if (segGB && segMB) {
    if (state.unit === 'gb') {
      segGB.classList.add('active');
      segMB.classList.remove('active');
    } else {
      segMB.classList.add('active');
      segGB.classList.remove('active');
    }
  }
  
  const segDaily = $('#segDaily');
  const segCum = $('#segCum');
  if (segDaily && segCum) {
    if (state.mode === 'daily') {
      segDaily.classList.add('active');
      segCum.classList.remove('active');
    } else {
      segCum.classList.add('active');
      segDaily.classList.remove('active');
    }
  }
  
  // Initial load
  try {
    await loadSystemStatus();
    await updateDateSelect();
    // Ensure dashboard tab is active and management pane is shown
    const dashboardTab = document.querySelector('.tab[data-tab="dashboard"]');
    if (dashboardTab) {
      $$('.tab').forEach(t => t.classList.remove('active'));
      dashboardTab.classList.add('active');
    }
    // Show management pane, hide others
    $$('.pane').forEach(p => {
      if (p && p.dataset) {
        if (p.dataset.pane === 'management') {
          p.classList.add('active');
          p.style.display = 'block';
        } else {
          p.classList.remove('active');
          p.style.display = 'none';
        }
      }
    });
    
    // Deactivate nav pills
    $$('.nav-pill').forEach(p => p.classList.remove('active'));
    // Load management content
    await loadManagement();
    const liveStatusEl = $('#liveStatus');
    const badgeDot = $('#badgeLive .dot');
    if (liveStatusEl) liveStatusEl.textContent = '–ì–æ—Ç–æ–≤–æ';
    if (badgeDot) badgeDot.classList.add('ok');
  } catch (e) {
    console.error('Init error:', e);
    const liveStatusEl = $('#liveStatus');
    const badgeDot = $('#badgeLive .dot');
    if (liveStatusEl) liveStatusEl.textContent = '–û—à–∏–±–∫–∞';
    if (badgeDot) badgeDot.classList.add('bad');
  }
  
  // Initialize Online segmented controls
  if (state.liveScope === 'global') {
    $('#segScopeGlobal').classList.add('active');
    $('#segScopeUsers').classList.remove('active');
  } else {
    $('#segScopeUsers').classList.add('active');
    $('#segScopeGlobal').classList.remove('active');
  }
  
  if (state.liveMetric === 'traffic') {
    $('#segMetricTraffic').classList.add('active');
  } else if (state.liveMetric === 'conns') {
    $('#segMetricConns').classList.add('active');
  } else {
    $('#segMetricOnline').classList.add('active');
  }
  
  if (state.livePeriod === 3600) {
    $('#segPeriod60m').classList.add('active');
  } else if (state.livePeriod === 21600) {
    $('#segPeriod6h').classList.add('active');
  } else {
    $('#segPeriod24h').classList.add('active');
  }
  
  if (state.liveGran === 60) {
    $('#segGran1m').classList.add('active');
  } else if (state.liveGran === 300) {
    $('#segGran5m').classList.add('active');
  } else {
    $('#segGran10m').classList.add('active');
  }
  
  // Initialize Users segmented controls
  if (state.mainMetric === 'traffic') {
    $('#segCmpTraffic').classList.add('active');
    $('#segCmpConns').classList.remove('active');
  } else {
    $('#segCmpConns').classList.add('active');
    $('#segCmpTraffic').classList.remove('active');
  }
  
  if (state.miniMetric === 'traffic') {
    $('#segMiniTraffic').classList.add('active');
    $('#segMiniConns').classList.remove('active');
  } else {
    $('#segMiniConns').classList.add('active');
    $('#segMiniTraffic').classList.remove('active');
  }
  
  // Initialize Pause button state
  const btnPauseInit = $('#btnPause');
  if (btnPauseInit) {
    btnPauseInit.textContent = state.livePaused ? 'Resume' : 'Pause';
  }
  // Polling –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É online —á–µ—Ä–µ–∑ startOnlinePolling()
  
  // Periodic refresh
  setInterval(loadSystemStatus, 10000);
  setInterval(() => {
    if (document.querySelector('.pane[data-pane="management"].active')) {
      loadManagement();
    }
  }, 60000);
}

// Wait for DOM to be ready
(function() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    // DOM already ready, but wait a bit to ensure all elements are rendered
    setTimeout(init, 100);
  }
})();
</script>
</body>
</html>
