<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Xray Users - Test Page</title>
<style>
:root {
  --bg: #0d1117;
  --panel: #161b22;
  --text: #e6edf3;
  --muted: #8b949e;
  --accent: #58a6ff;
  --ok: #3fb950;
  --bad: #f85149;
  --line: #30363d;
}
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}
.card {
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}
h1 { margin: 0 0 20px; }
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid var(--line);
}
th {
  color: var(--muted);
  font-weight: 600;
  text-transform: uppercase;
  font-size: 12px;
}
.btn {
  padding: 6px 12px;
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 6px;
  color: var(--text);
  cursor: pointer;
  font-size: 12px;
  margin: 2px;
}
.btn:hover { border-color: var(--accent); }
.danger { background: var(--bad); color: #fff; }
.mono { font-family: monospace; font-size: 10px; }
</style>
</head>
<body>

<div class="card">
  <h1>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)</h1>
  <p style="color: var(--muted);">
    API: <span id="apiStatus">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span> | 
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="userCount">?</span>
  </p>
  
  <button class="btn" onclick="loadData()" style="padding: 10px 20px; font-size: 14px; background: var(--accent); color: #fff;">
    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
  </button>
</div>

<div class="card">
  <table id="usersTable">
    <thead>
      <tr>
        <th>–ò–º—è</th>
        <th>Email</th>
        <th>UUID</th>
        <th>–¢—Ä–∞—Ñ–∏–∫ (–≤—Å–µ–≥–æ)</th>
        <th>–î–Ω–µ–π –∞–∫—Ç–∏–≤–µ–Ω</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="7" style="text-align:center;color:var(--muted);">
          –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
async function loadData() {
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
  
  try {
    // Load users
    console.log('Fetching /api/users...');
    const usersRes = await fetch('/api/users');
    const usersData = await usersRes.json();
    console.log('Users data:', usersData);
    
    if (!usersData.ok) {
      throw new Error(usersData.error || 'API error');
    }
    
    const users = usersData.users || [];
    document.getElementById('apiStatus').innerHTML = '<span style="color:var(--ok);">‚úÖ OK</span>';
    document.getElementById('userCount').textContent = users.length;
    
    // Load stats
    let statsMap = {};
    try {
      console.log('Fetching /api/users/stats...');
      const statsRes = await fetch('/api/users/stats');
      const statsData = await statsRes.json();
      console.log('Stats data:', statsData);
      
      if (statsData.ok && statsData.users) {
        statsData.users.forEach(s => {
          statsMap[s.email] = s;
        });
      }
    } catch (e) {
      console.warn('Stats error (non-critical):', e);
    }
    
    // Render table
    if (users.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
      return;
    }
    
    const rows = users.map(u => {
      const stats = statsMap[u.email] || {};
      const alias = u.alias || stats.alias || '';
      const displayName = alias || u.email;
      const traffic = formatBytes(stats.totalTrafficBytes || 0);
      const days = stats.daysUsed || 0;
      const online = stats.isOnline ? 'üü¢ Online' : '‚ö™ Offline';
      
      return `
        <tr>
          <td><strong>${escape(displayName)}</strong></td>
          <td>${escape(u.email)}</td>
          <td class="mono">${escape(u.uuid)}</td>
          <td><strong>${traffic}</strong></td>
          <td style="text-align:center;">${days}</td>
          <td>${online}</td>
          <td>
            <button class="btn" onclick="getLink('${escape(u.email)}')">üîó –°—Å—ã–ª–∫–∞</button>
            <button class="btn" onclick="kick('${escape(u.email)}')">üîÑ –ö–∏–∫</button>
            <button class="btn danger" onclick="del('${escape(u.email)}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </td>
        </tr>
      `;
    }).join('');
    
    tbody.innerHTML = rows;
    console.log('Rendered', users.length, 'users');
    
  } catch (e) {
    console.error('Load error:', e);
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--bad);">‚ùå ${e.message}</td></tr>`;
    document.getElementById('apiStatus').innerHTML = '<span style="color:var(--bad);">‚ùå ERROR</span>';
  }
}

function formatBytes(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

function escape(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

async function getLink(email) {
  try {
    const res = await fetch(`/api/users/link?email=${encodeURIComponent(email)}`);
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    prompt('–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', data.link);
  } catch (e) {
    alert('–û—à–∏–±–∫–∞: ' + e.message);
  }
}

async function kick(email) {
  if (!confirm(`–°–º–µ–Ω–∏—Ç—å UUID –¥–ª—è ${email}?`)) return;
  try {
    const res = await fetch('/api/users/kick', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email})
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    alert('‚úÖ UUID —Å–º–µ–Ω–µ–Ω');
    loadData();
  } catch (e) {
    alert('–û—à–∏–±–∫–∞: ' + e.message);
  }
}

async function del(email) {
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${email}?`)) return;
  try {
    const res = await fetch('/api/users/delete', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email})
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
    loadData();
  } catch (e) {
    alert('–û—à–∏–±–∫–∞: ' + e.message);
  }
}

// Auto-load on page load
window.onload = () => {
  console.log('Page loaded, starting data load...');
  loadData();
};
</script>

</body>
</html>
